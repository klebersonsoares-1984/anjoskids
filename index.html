<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Anjos Kid¬¥s</title>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/date-fns.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/locale/pt-BR.min.js"></script>
    <style>

/* Reduz especificamente a coluna de a√ß√µes na tabela de Clientes */
#secao-clientes table th:last-child,
#secao-clientes table td:last-child {
    width: 80px !important; /* Ajuste este valor conforme necess√°rio */
    padding: 5px !important;
    text-align: center;
    white-space: nowrap; /* Evita quebra de linha nos bot√µes */
}

/* Garante que os bot√µes fiquem alinhados */
#secao-clientes table td:last-child button {
    margin: 2px !important;
}

/* Diminui apenas a coluna de a√ß√µes da se√ß√£o de estoque */
   #secao-estoque table th:last-child,
   #secao-estoque table td:last-child {
       width: 60px !important;
       padding: 4px !important;
       text-align: center;
   }

   /* Cores das linhas por g√™nero na tabela de estoque */
   #secao-estoque table tbody tr.genero-feminino {
       background-color: #ffcce0 !important; /* Rosa claro */
   }

   #secao-estoque table tbody tr.genero-masculino {
       background-color: #cce7ff !important; /* Azul beb√™ */
   }

   /* Mant√©m a cor ao passar o mouse, mas com um leve escurecimento */
   #secao-estoque table tbody tr.genero-feminino:hover {
       background-color: #ffb3d1 !important; /* Rosa um pouco mais escuro */
   }

   #secao-estoque table tbody tr.genero-masculino:hover {
       background-color: #b3d9ff !important; /* Azul um pouco mais escuro */
   }

/* Reduz especificamente a coluna de a√ß√µes na tabela do Relat√≥rio de Vendas (Caixa) */
#corpoTabelaCaixa td:last-child,
#secao-caixa table th:last-child {
    width: 30px !important;
    padding: 5px !important;
}

/* Reduz a largura da coluna de a√ß√µes em TODAS as tabelas */
table th:last-child,
table td:last-child {
    width: 100px !important;
    padding: 5px !important;
}
/* Adicione este c√≥digo no final da sua tag <style> */

/* ------------------- ESTILO DE ALERTA PISCANTE ------------------- */

/* 1. Define a anima√ß√£o de piscar */
@keyframes piscarVermelho {
    /* Vermelho forte para o estado inicial e final */
    0%, 100% { 
        background-color: #dc3545; /* Cor Vermelha S√≥lida (do btn-remover) */
        color: white; 
        box-shadow: 0 0 5px rgba(220, 53, 69, 0.9); /* Sombra para destacar */
    } 
    /* Vermelho mais claro/transparente para o pico da anima√ß√£o */
    50% { 
        background-color: #ffcccc; 
        color: #dc3545; 
        box-shadow: none;
    }
}

/* 2. Aplica o estilo e a anima√ß√£o ao bot√£o */
.alerta-backup-piscante {
    /* Garante que o estilo de cor padr√£o do rodap√© seja sobrescrito */
    background-color: #dc3545 !important; 
    color: white !important;
    border: 2px solid #a71d2a !important; /* Borda vermelha escura para contraste */
    font-weight: bold !important;
    padding: 5px 9px !important; /* Aumenta um pouco o padding */
    font-size: 0.85em !important; /* Aumenta o tamanho da fonte */
    
    /* Aplica a anima√ß√£o: nome, dura√ß√£o de 1 segundo e repeti√ß√£o infinita */
    animation: piscarVermelho 1s infinite;
}
        /* --- ESTILOS ORIGINAIS AJUSTADOS PARA MAIS COR --- */
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); }
        
        /* NOVO ESTILO PARA ENVOLVER O T√çTULO E O LOGO */
        .header-titulo {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
    
    background: white;
    padding: 10px 25px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3), /* Rosa claro */
                0 4px 15px rgba(0, 0, 0, 0.15); /* Sombra preta suave */
    border: 2px solid #ffe0f0; /* Borda rosa suave */
}

        /* NOVO ESTILO PARA O LOGO (AUMENTADO) */
        .logo-anjo {
            /* Tamanho ajustado para ser 'pequeno' ao lado do h1 */
            height: 150px; /* Altura do logo AUMENTADA */
            margin-right: 15px; /* Espa√ßo entre o logo e o texto do t√≠tulo */
        }

        /* Modifica√ß√£o: H1 sem cor de texto padr√£o, para aplicar cor por letra via SPANs */
        h1 { 
            text-align: center; 
            font-size: 3.5em; /* TAMANHO MANTIDO */ 
        }
        /* Estilo para que as letras coloridas do H1 fiquem lado a lado */
        .color-letter {
            display: inline-block;
            font-weight: bold;
        }

        /* MODIFICADO: Redu√ß√£o da espessura da linha/borda para 1px (LINHAS MAIS FINAS) */
        h2 { color: #3a7bd5; border-bottom: 1px solid #3a7bd5; padding-bottom: 5px; margin-top: 25px; margin-bottom: 15px; }

        .menu { text-align: center; margin-bottom: 25px; background-color: #ffe0f0; padding: 10px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .menu button {
        color: white;
        border: none;
        padding: 24px 20px;         /* reduzido para caber todos */
        margin: 0;
        cursor: pointer;
        border-radius: 5px;
        transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        font-weight: bold;
        font-size: 0.88em;         /* texto um pouco menor */
        white-space: nowrap;      /* impede quebra de linha no texto do bot√£o */
        flex: 1;                   /* todos ocupam o mesmo espa√ßo */
        min-width: 0;              /* permite encolher */
        }
        
        /* Modifica√ß√£o: Defini√ß√£o de Cores e Estilos de Hover/Ativo para cada bot√£o */
        /* 1. Iniciar Venda: Rosa */
        .btn-venda { background-color: #ff69b4; } 
        .btn-venda:hover { background-color: #ff4d99; transform: scale(1.05); }
        .btn-venda.ativo { background-color: #dc3545; box-shadow: 0 0 10px rgba(220, 53, 69, 0.7); } 

        /* 2. Cadastro Produto: Azul */
        .btn-cadastro-produto { background-color: #3a7bd5; } 
        .btn-cadastro-produto:hover { background-color: #3264b3; transform: scale(1.05); }
        .btn-cadastro-produto.ativo { background-color: #ff69b4; box-shadow: 0 0 10px rgba(255, 105, 180, 0.7); } 

        /* 3. Cadastro Clientes: Verde */
        .btn-clientes { background-color: #28a745; } 
        .btn-clientes:hover { background-color: #1e7e34; transform: scale(1.05); }
        .btn-clientes.ativo { background-color: #3a7bd5; box-shadow: 0 0 10px rgba(58, 123, 213, 0.7); } 

        /* 4. Resumo de Caixa: Amarelo/Laranja */
        .btn-caixa { background-color: #ffc107; } 
        .btn-caixa:hover { background-color: #e0a800; transform: scale(1.05); }
        .btn-caixa.ativo { background-color: #28a745; box-shadow: 0 0 10px rgba(40, 167, 69, 0.7); } 

        /* 5. Estoque Atual: Violeta */
        .btn-estoque { background-color: #9400d3; } 
        .btn-estoque:hover { background-color: #7500a8; transform: scale(1.05); }
        .btn-estoque.ativo { background-color: #ffc107; box-shadow: 0 0 10px rgba(255, 193, 7, 0.7); } 

        /* 6. Consulta R√°pida: Ciano */
        .btn-consulta { background-color: #17a2b8; } 
        .btn-consulta:hover { background-color: #138496; transform: scale(1.05); }
        .btn-consulta.ativo { background-color: #9400d3; box-shadow: 0 0 10px rgba(148, 0, 211, 0.7); }

         /* NOVO ESTILO: 7. Auditoria de Estoque: Roxo Claro */
         .btn-auditoria { background-color: #8a2be2; } /* Azul violeta */
         .btn-auditoria:hover { background-color: #6a1ba3; transform: scale(1.05); }
         .btn-auditoria.ativo { background-color: #ffc107; box-shadow: 0 0 10px rgba(255, 193, 7, 0.7); } 

         /* NOVO ESTILO: 8. Consigna√ß√£o: Laranja Claro */
         .btn-consignacao { background-color: #fd7e14; } /* Laranja claro */
         .btn-consignacao:hover { background-color: #e06c00; transform: scale(1.05); }
         .btn-consignacao.ativo { background-color: #8a2be2; box-shadow: 0 0 10px rgba(138, 43, 226, 0.7); }
                
        /* ------------------- RESTANTE DO CSS ORIGINAL ------------------- */
        
        .secao { display: none; }

        .filtro-caixa {
            background-color: #fff5f5; /* Rosa mais claro */
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            margin-bottom: 20px;
        }

        label { display: block; margin-top: 10px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"], input[type="email"], input[type="date"], select, input[type="password"], input[type="month"] {
            width: calc(100% - 22px); 
            padding: 10px; 
            margin-top: 5px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            box-sizing: border-box;
        }

        button {
            background-color: #28a745; 
            color: white; 
            border: none; 
            /* MODIFICADO: Padding reduzido para bot√µes de A√ß√£o/Formul√°rio (BOT√ïES MENORES) */
            padding: 8px 12px; 
            cursor: pointer; 
            border-radius: 5px; 
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #1e7e34; }
        
        .btn-acao { background-color: #007bff; }
        .btn-acao:hover { background-color: #0056b3; }
        .btn-remover { background-color: #dc3545; }
        .btn-remover:hover { background-color: #bd2130; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f0f8ff; color: #3a7bd5; font-weight: bold; }
        tr:nth-child(even) { background-color: #f7f7f7; }

   /* NOVO ESTILO: Colunas ajustadas (40% / 60%) para expandir o Carrinho */
.secao-venda-grid {
    display: grid;
    /* Coluna 1: Entrada/Detalhes (3 partes) | Coluna 2: Carrinho (7 partes) */
    grid-template-columns: 4fr 6fr;
    gap: 20px;
}

        /* MODIFICADO: Redu√ß√£o da espessura da borda para 1px (LINHAS MAIS FINAS) */
        .carrinho {
            border: 1px solid #ff69b4;
            padding: 15px;
            border-radius: 8px;
            background-color: #fff0f5;
        }

        .carrinho-total {
            background-color: #3a7bd5;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: right;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        /* Classe reutilizada para Detalhes de Produto (Venda e Consulta) */
        .detalhes-produto {
            background-color: #e6f7ff;
            padding: 15px;
            border: 1px solid #3a7bd5;
            border-radius: 5px;
            margin-top: 15px;
        }

        /* NOVOS ESTILOS PARA ENFATIZAR DETALHES DO PRODUTO */
        .detalhes-produto p { 
            font-size: 1.1em; 
        }
        
        .detalhes-produto .preco-destaque {
            font-size: 1.5em; /* Aumenta o tamanho da fonte do pre√ßo */
            font-weight: bold; /* Garante que o valor do pre√ßo se destaque */
            color: #ff69b4; /* Usa a cor principal do sistema para destaque */
        }
        /* ----------------------------------------------------------------------------------- */

        /* NOVO ESTILO SOLICITADO: Bot√µes menores apenas com √≠cone no Detalhe das Vendas (BOT√ïES MAIS FINOS) */
        .btn-small-icon {
            padding: 5px 8px !important; /* Padding menor */
            font-size: 1.1em; /* Tamanho do √≠cone */
            margin: 2px 2px !important; /* Margem entre eles */
            line-height: 1; /* Para centralizar o √≠cone */
            display: inline-flex; /* Alinhamento */
            align-items: center;
        }

        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }

         /* üÜï NOVO: Modal sobreposto (quando um modal abre outro) */
.modal.modal-sobreposto {
    z-index: 1100 !important;
    background-color: rgba(0,0,0,0.6);
}

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        /* Ajuste para o modal de hist√≥rico de vendas (pode ser maior) */
        #modalHistoricoVendas .modal-content {
            max-width: 800px; 
        }

        .fechar {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .fechar:hover,
        .fechar:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        /* Layout para Resumos Fixos de Vendas */
        .input-group {
            display: flex;
            gap: 20px;
        }
        
        /* ESTILOS PARA EXPORTA√á√ÉO/IMPORTA√á√ÉO (DISCRETOS) */
        .rodape-utilitarios {
            text-align: right;
            margin-top: 30px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .rodape-utilitarios button {
            background-color: transparent; /* Fundo transparente */
            color: #888; /* Cor cinza sutil */
            border: 1px solid #ccc; /* Borda discreta */
            padding: 5px 10px;
            font-size: 0.9em;
            transition: color 0.3s, background-color 0.3s;
        }

        .rodape-utilitarios button:hover {
            color: #3a7bd5; /* Cor azul no hover */
            background-color: #f0f8ff;
        }
        
        .rodape-utilitarios input[type="file"] {
            display: none; /* Esconde o input de arquivo padr√£o */
        }

/* AJUSTE SOLICITADO: Garante que a descri√ß√£o do produto na tabela do carrinho n√£o seja cortada (55% Item) */
#tabelaCarrinho {
    table-layout: fixed; /* For√ßa a tabela a honrar as larguras de coluna */
    width: 100%;
}

/* Define a largura das colunas: 55% para o Item, 10% Qtd, 25% Valor e 10% A√ß√£o */
#tabelaCarrinho thead th:nth-child(1), /* Coluna Item */
#tabelaCarrinho tbody td:nth-child(1) {
    width: 55%; 
    word-break: break-word; /* Permite quebras de linha dentro da palavra se ela for muito longa */
}

#tabelaCarrinho thead th:nth-child(2), /* Coluna Qtd */
#tabelaCarrinho tbody td:nth-child(2) {
    width: 10%; 
}

#tabelaCarrinho thead th:nth-child(3), /* Coluna Valor */
#tabelaCarrinho tbody td:nth-child(3) {
    width: 25%;
}

#tabelaCarrinho thead th:nth-child(4), /* Coluna A√ß√£o */
#tabelaCarrinho tbody td:nth-child(4) {
    width: 10%;
}

/* NOVO: Estilos para impress√£o de comprovante */
@media print {
    /* Estilo de base para comprovante t√©rmico */
    .recibo-print-body {
        font-family: 'Consolas', monospace; /* Fonte mais adequada para recibo */
        font-size: 9pt; 
        width: 80mm; /* Largura padr√£o de impressora t√©rmica */
        margin: 0;
        padding: 0;
        color: #000;
    }
    .recibo-header img { max-width: 60px; } /* Reduz o logo na impress√£o */
    
    /* Estilos para o relat√≥rio de estoque */
    .print-report-body {
        font-family: Arial, sans-serif; 
        font-size: 10pt; 
        margin: 10px; 
    }
    .print-report-body h3 { 
        text-align: center; 
        color: #333; 
    }
    .print-report-body table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 15px; 
    }
    .print-report-body th, .print-report-body td { 
        border: 1px solid #ccc; 
        padding: 8px; 
        text-align: left; 
    }
    .print-report-body th { 
        background-color: #f0f0f0; 
        color: #333; 
    }
    .print-report-body .low-stock { 
        color: #dc3545; 
        font-weight: bold; 
    }
}

/* Estilos para a tabela de detalhes da consigna√ß√£o */
#tabelaDetalhesConsignacao th, #tabelaDetalhesConsignacao td {
    padding: 8px;
    text-align: left;
    border: 1px solid #ddd;
}
#tabelaDetalhesConsignacao tfoot td {
    font-size: 1.1em;
    color: #d35400;  /* Cor laranja para destacar o total */
}

/* üÜï Anima√ß√£o de destaque para etapas */
@keyframes pulse {
    0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    50% { 
        transform: scale(1.02); 
        box-shadow: 0 8px 20px rgba(255,193,7,0.4);
    }
}

    </style>
</head>
<body>

    <div class="container">
        <div class="header-titulo">
            <img src="image_df7b45.jpg" alt="Logo Anjos Kids" class="logo-anjo">
            <h1>
                <span class="color-letter" style="color: #ff69b4;">A</span><span class="color-letter" style="color: #3a7bd5;">n</span><span class="color-letter" style="color: #28a745;">j</span><span class="color-letter" style="color: #ffc107;">o</span><span class="color-letter" style="color: #dc3545;">s</span><span style="color: transparent;"> </span> <span class="color-letter" style="color: #9400d3;">K</span><span class="color-letter" style="color: #17a2b8;">i</span><span class="color-letter" style="color: #ff69b4;">d</span><span class="color-letter" style="color: #3a7bd5;">s</span></h1>
        </div>

        <div class="menu">
            <button id="btn-venda" class="btn-venda" onclick="mostrarSecao('secao-venda', this)">
                <i class="fas fa-shopping-cart"></i> Iniciar Venda
            </button>
            <button class="btn-cadastro-produto" onclick="mostrarSecao('secao-cadastro', this)">
                <i class="fas fa-box"></i> Cadastro Produto
            </button>
            <button class="btn-clientes" onclick="mostrarSecao('secao-clientes', this)">
                <i class="fas fa-users"></i> Cadastro Clientes
            </button>
            <button class="btn-caixa" onclick="mostrarSecao('secao-caixa', this)">
                <i class="fas fa-dollar-sign"></i> Relat√≥rio Vendas
            </button>
            <button class="btn-estoque" onclick="mostrarSecao('secao-estoque', this)">
                <i class="fas fa-warehouse"></i> Estoque Atual
            </button>
            <button class="btn-consulta" onclick="mostrarSecao('secao-consulta', this)">
                <i class="fas fa-search"></i> Consulta R√°pida
            </button>
           <button class="btn-auditoria" onclick="mostrarSecao('secao-auditoria', this)">
                <i class="fas fa-clipboard-check"></i> Auditoria 
            </button>
            <button class="btn-consignacao" onclick="mostrarSecao('secao-consignacao', this)">
            <i class="fas fa-handshake"></i> Consigna√ß√£o
           </button>
        </div>         
        
        <section id="secao-consulta" class="secao">
            <h2><i class="fas fa-search-dollar"></i> Consulta Valor / Estoque</h2>
            
            <form onsubmit="return false;">
                <label for="skuConsulta">SKU do Sistema ou do Fabricante:</label>
                <input type="text" id="skuConsulta" placeholder="Digite o SKU ou C√≥digo de Barras" 
       oninput="consultarProdutoPorSku()" 
       onkeyup="if(event.key === 'Enter') this.select();">
            </form>

            <div id="resultadoConsulta" class="detalhes-produto" style="min-height: 120px;">
                <h4>Resultado da Consulta:</h4>
                <p><strong>Descri√ß√£o:</strong> <span id="consultaDescricao">Aguardando a digita√ß√£o do SKU...</span></p>
                <p><strong>Pre√ßo de Venda:</strong> <span id="consultaPreco" class="preco-destaque">---</span></p>
                <p><strong>Estoque Atual:</strong> <span id="consultaEstoque">---</span></p>
                <p><strong>SKU do Sistema:</strong> <span id="consultaSkuSistema">---</span></p>
                <p><strong>SKU do Fabricante:</strong> <span id="consultaSkuFabricante">---</span></p>
                <p><strong>Vendas (Hist√≥rico):</strong> <span id="consultaVendas">---</span></p>
                <p><strong>Consigna√ß√µes Pendentes:</strong> <span id="consultaConsignacoes" style="color: #dc3545; font-weight: bold;">---</span></p>
            </div>

        <!-- KARDEX: Exibe hist√≥rico de movimenta√ß√£o do SKU consultado -->
<div id="kardexConsulta" class="detalhes-produto" style="min-height: 120px; margin-top:12px; display:none;">
  <h4>Kardex / Hist√≥rico de Movimenta√ß√£o</h4>
  <p id="kardexResumo" style="font-weight:bold;">Aguardando SKU...</p>

  <div style="max-height:300px; overflow:auto; margin-top:8px;">
    <table id="tabelaKardex" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th>Data</th>
          <th>Hora</th>
          <th>SKU</th>
          <th>Descri√ß√£o</th>
          <th>Qtd</th>
          <th>Cliente</th>
          <th>Valor Total</th>
        </tr>
      </thead>
      <tbody id="corpoTabelaKardex">
        <!-- linhas geradas dinamicamente -->
      </tbody>
    </table>
  </div>
</div>


        </section>
       
<section id="secao-auditoria" class="secao">
            <h2><i class="fas fa-clipboard-check"></i> Auditoria e Confronto de Estoque</h2>
            
            <form onsubmit="return false;" style="display: flex; gap: 20px; align-items: flex-end;">
                <div style="flex: 1; max-width: 400px;">
                    <label for="arquivoAuditoria">1. Selecione o Arquivo TXT (SKU,Quantidade):</label>
                    <input type="file" id="arquivoAuditoria" accept=".txt" onchange="iniciarConfronto(event)">
                </div>
                
                <div style="flex: 1; text-align: right;">
                    <button id="btnFecharCritica" class="btn-acao" onclick="fecharCritica()" style="background-color: #dc3545; display:none;">
                        <i class="fas fa-exclamation-triangle"></i> Fechar Cr√≠tica e Ajustar Estoque
                    </button>
                    <p style="margin-top: 10px; font-size: 0.8em; color: #555;">
                        * O arquivo .txt deve ter um SKU e a quantidade em cada linha, separados por v√≠rgula (ex: SKU123,50).
                    </p>
                </div>
            </form>


            <h3 style="margin-top: 30px;"><i class="fas fa-exclamation-circle"></i> Cr√≠ticas Encontradas (Diferen√ßa entre Arquivo e Sistema)</h3>

            <div style="text-align: right; margin-bottom: 10px;">
  <button onclick="imprimirAuditoria()" class="btn-acao" style="background-color:#9400d3;">
    <i class="fas fa-print"></i> Imprimir Diverg√™ncias
  </button>
</div>

       <div id="resultadoAuditoria" class="detalhes-produto" style="min-height: 120px; background-color: #fff0f5; border: 1px solid #dc3545;">
                <p id="auditoriaMensagem">Aguardando importa√ß√£o do arquivo de auditoria (.txt)...</p>
                <ul id="listaCriticas" style="list-style: none; padding: 0;"></ul>
            </div>

</section>
            

         <section id="secao-consignacao" class="secao">
    <h2><i class="fas fa-handshake"></i> Controle de Consigna√ß√£o</h2>
    
    <h3><i class="fas fa-plus"></i> Nova Consigna√ß√£o</h3>
    <div class="secao-venda-grid">  <!-- Reutiliza o grid da venda para layout similar -->
        <div>
            <form id="formAdicionarItemConsignacao">
    <label for="skuConsignacao">SKU do Sistema ou do Fabricante:</label>
    <input type="text" id="skuConsignacao" required oninput="exibirDetalhesProdutoConsignacao()">
    <label for="precoConsignacaoManual" style="margin-top:8px;">Pre√ßo de Venda (Remarca√ß√£o):</label>
    <input type="number" id="precoConsignacaoManual" step="0.01" placeholder="Ex 45.00" style="width: 50%; margin-bottom: 8px;">
    <button type="submit" class="btn-acao">
        <i class="fas fa-plus-circle"></i> Adicionar ao Pacote
    </button>
</form>

            <h3 style="margin-top: 30px;">Finalizar Consigna√ß√£o</h3>
            <div style="padding: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9;">
                <label for="cpfClienteConsignacao">CPF ou Nome do Cliente (Obrigat√≥rio):</label>
                <input type="text" id="cpfClienteConsignacao" placeholder="Digite CPF ou Nome" oninput="aplicarMascaraCpf(this); validarClienteConsignacao()">
                <p id="infoClienteConsignacao" style="margin-top: 5px; color: #fd7e14; font-weight: bold;">Cliente: N√£o identificado</p>

                <button id="btnSelecionarClienteConsignacao" class="btn-acao" style="margin-left: 10px; background-color: #ffc107; color: black !important; font-weight: bold;"  onclick="abrirModalSelecaoClienteParaConsignacao()">
                <i class="fas fa-user-plus"></i> + Cliente
                </button>
                
                <button onclick="iniciarFinalizacaoConsignacao()" class="btn-acao" style="background-color: #fd7e14;">
                    <i class="fas fa-check-circle"></i> Registrar Consigna√ß√£o
                </button>
                
                <button onclick="limparPacoteConsignacao()" class="btn-remover" style="margin-left: 10px;">
                    <i class="fas fa-trash-alt"></i> Limpar
                </button>
            </div>
        </div>

        <div class="carrinho">  <!-- Reutiliza estilo do carrinho -->
            <h3><i class="fas fa-box-open"></i> Pacote de Consigna√ß√£o</h3>
            <table id="tabelaPacoteConsignacao" style="width:100%; margin-top:10px;">
    <thead>
        <tr style="background:#3a7bd5; color:white;">
            <th style="width:45%; text-align:left;">Item</th>
            <th style="width:10%;">Qtd</th>
            <th style="width:15%;">Unit√°rio</th>
            <th style="width:15%;">Subtotal</th>
            <th style="width:15%;">A√ß√£o</th>
        </tr>
    </thead>
    <tbody id="corpoTabelaPacoteConsignacao"></tbody>
    <tfoot>
        <tr style="font-weight:bold; font-size:1.2em; background:#e6f7ff;">
            <td colspan="3" style="text-align:right; padding:12px;">TOTAL DO PACOTE:</td>
            <td id="totalPacoteConsignacao" colspan="2" style="text-align:center; color:#d35400;">R$ 0,00</td>
        </tr>
    </tfoot>
</table>
        </div>
    </div>

    <h3 style="margin-top: 30px;"><i class="fas fa-list"></i> Consigna√ß√µes Pendentes</h3>

<div style="text-align: right; margin-bottom: 10px;">
    <button onclick="abrirRelatorioConsignacoesPorDia()" class="btn-acao" style="background-color: #fd7e14;">
        <i class="fas fa-calendar-alt"></i> Relat√≥rio por Dia
    </button>
</div>

<table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Data</th>
                <th>Cliente</th>
                <th>Itens</th>
                <th>Status</th>
                <th>Total</th>  <!-- NOVA COLUNA ADICIONADA AQUI -->
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="corpoTabelaConsignacoes"></tbody>
    </table>
</section>
            
        </section>

        <section id="secao-venda" class="secao">
            <h2><i class="fas fa-hand-holding-usd"></i> Iniciar Venda</h2>
            
            <div class="secao-venda-grid">
                <div>
                    <form id="formAdicionarItem">
                        <label for="skuVenda">SKU do Sistema ou do Fabricante:</label>
                        <input type="text" id="skuVenda" required oninput="exibirDetalhesProduto()">
                        <label for="precoVendaManual" style="margin-top:8px;">Pre√ßo de Venda (Remarca√ß√£o):</label>
                        <input type="number" id="precoVendaManual" step="0.01" placeholder="Ex 45.00" style="width: 50%; margin-bottom: 8px;">
                        <button type="submit" class="btn-acao">
                            <i class="fas fa-plus-circle"></i> Adicionar ao Carrinho
                        </button>
                    </form>

                    <h3 style="margin-top: 30px;">Finalizar Venda</h3>
                    <div style="padding: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9;">
                        <label for="cpfCliente">CPF ou Nome do Cliente (Opcional):</label>
                        <input type="text" id="cpfCliente" placeholder="Digite CPF ou Nome" oninput="aplicarMascaraCpf(this); validarClienteVenda()">
                        <p id="infoCliente" style="margin-top: 5px; color: #ff69b4; font-weight: bold;">Cliente: N√£o identificado</p>

                        <button id="btnSelecionarCliente" class="btn-acao" style="margin-left: 10px; background-color: #ffc107; color: black !important; font-weight: bold;"                  onclick="abrirModalSelecaoCliente()">
                            <i class="fas fa-user-plus"></i> + Cliente
                         </button>

                        <button onclick="adicionarFrete()" class="btn-acao" style="background-color: #3a7bd5; margin-bottom: 8px;">
                            <i class="fas fa-truck"></i> Frete
                        </button>
                      
                        <button onclick="iniciarFinalizacaoVenda()" class="btn-acao" style="background-color: #ff69b4;">
                            <i class="fas fa-check-circle"></i> Finalizar Venda

                        <button onclick="iniciarFluxoTroca()" class="btn-acao" style="background-color: #ffc107; color: black; margin-left: 10px;">
                            <i class="fas fa-exchange-alt"></i> Troca
                        </button>
                        
                        <button onclick="limparCarrinho()" class="btn-remover" style="margin-left: 10px;">
                            <i class="fas fa-trash-alt"></i> Limpar
                        </button>
                        </div>
                </div>

                <div class="carrinho">
                    <h3><i class="fas fa-shopping-basket"></i> Resumo da Venda</h3>
                    <table id="tabelaCarrinho">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Qtd</th>
                                <th>Valor</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaCarrinho">
                            </tbody>
                    </table>
                    <div class="carrinho-total">
                        Total: <span id="totalCarrinho">R$ 0,00</span>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="secao-cadastro" class="secao">
            <h2><i class="fas fa-box"></i> Cadastro de Produto</h2>
            <form id="formCadastroProduto">
<!-- SKU do Fabricante e SKU do Sistema na mesma linha -->
<div style="display: flex; gap: 20px; align-items: flex-end;">
  <div style="flex: 1;">
      <label for="skuProduto">SKU do Fabricante (Manual / C√≥digo de Barras):</label>
      <input type="text" id="skuProduto" placeholder="Opcional - C√≥digo do Fabricante" style="width: 100%;">
  </div>
  <div style="flex: 1;">
      <label for="skuAutoDisplay">SKU do Sistema (Autom√°tico - Chave Prim√°ria):</label>
      <input type="text" id="skuAutoDisplay" value="Ser√° gerado automaticamente" disabled 
             style="width: 100%; background-color: #eee; color: #555; font-weight: bold;">
  </div>
</div>

<!-- Linha √∫nica: G√™nero, Marca, Modelo/Descri√ß√£o, Cor, Tamanho (larguras iguais corrigidas) -->
<div style="display: flex; gap: 10px; align-items: flex-end; margin-top: 15px;">
  <div style="flex: 1; min-width: 180px;">
      <label for="genero">G√™nero:</label>
      <select id="genero" required style="width: 100%; height: 38px;">
          <option value="">Selecione</option>
          <option value="Masculino">Masculino</option>          
          <option value="Feminino">Feminino</option>
          <option value="Desconto">Desconto</option>
      </select>
  </div>
  <div style="flex: 1; min-width: 180px;">
      <label for="marca">Marca:</label>
      <input list="listaMarca" id="marca" required style="width: 100%; height: 38px;">
      <datalist id="listaMarca"></datalist>
  </div>
  <div style="flex: 1; min-width: 180px;">
      <label for="modelo">Modelo/Descri√ß√£o:</label>
      <input list="listaModelo" id="modelo" required style="width: 100%; height: 38px;">
      <datalist id="listaModelo"></datalist>
  </div>
  <div style="flex: 1; min-width: 180px;">
      <label for="cor">Cor:</label>
      <input list="listaCor" id="cor" required style="width: 100%; height: 38px;">
      <datalist id="listaCor"></datalist>
  </div>
  <div style="flex: 1; min-width: 180px;">
      <label for="tamanho">Tamanho:</label>
      <input list="listaTamanho" id="tamanho" required style="width: 100%; height: 38px;">
      <datalist id="listaTamanho"></datalist>
  </div>
</div>

                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label for="custo">Pre√ßo de Custo (R$):</label>
                        <input type="number" id="custo" step="0.01" required>
                    </div>
                    <div style="flex: 1;">
                        <label for="venda">Pre√ßo de Venda (R$):</label>
                        <input type="number" id="venda" step="0.01" required>
                    </div>
                    <div style="flex: 1;">
                        <label for="quantidadeInicial">Quantidade Inicial em Estoque:</label>
                        <input type="number" id="quantidadeInicial" min="0" required>
                    </div>
                </div>

                <button type="submit" class="btn-acao"><i class="fas fa-save"></i> Salvar Produto</button>
            </form>
        </section>

        <section id="secao-clientes" class="secao">
            <h2><i class="fas fa-users"></i> Cadastro de Clientes</h2>
            <form id="formCadastroCliente">
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label for="nomeCliente">Nome Completo:</label>
                        <input type="text" id="nomeCliente" required>
                    </div>
                    <div style="flex: 1;">
                        <label for="cpf">CPF:</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="text" id="cpf" required oninput="aplicarMascaraCpf(this)" style="flex: 1;">
                            <label style="margin: 0; display: flex; align-items: center; gap: 5px; cursor: pointer; white-space: nowrap;">
                                <input type="checkbox" id="checkNaoInformarCPF" style="cursor: pointer;">
                                <span style="font-size: 0.9em;">N√£o informar CPF</span>
                            </label>
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <label for="telefone">Telefone:</label>
                        <input type="text" id="telefone">
                    </div>
                </div>

                <div style="display: flex; gap: 20px;">
                    <div style="flex: 2;">
                        <label for="rua">Rua/Av:</label>
                        <input type="text" id="rua">
                    </div>
                    <div style="flex: 1;">
                        <label for="numero">N√∫mero:</label>
                        <input type="text" id="numero">
                    </div>
                </div>
                
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label for="bairro">Bairro:</label>
                        <input type="text" id="bairro">
                    </div>
                    <div style="flex: 1;">
                        <label for="cep">CEP:</label>
                        <input type="text" id="cep">
                    </div>
                </div>

                <button type="submit" class="btn-acao"><i class="fas fa-user-plus"></i> Salvar Cliente</button>
            </form>

            <h3 style="margin-top: 30px;"><i class="fas fa-list"></i> Clientes Cadastrados</h3>
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>Telefone</th>
                        <th>Endere√ßo</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaClientes">
                    </tbody>

           <div class="filtro-clientes" style="margin-bottom: 15px;">
    <label for="inputPesquisaClientes" style="font-weight: bold; color: #9400d3;">
        üîç Pesquisar Cliente (Nome ou CPF):
    </label>
    <input type="text" id="inputPesquisaClientes"
           placeholder="Digite nome ou CPF para filtrar"
           oninput="filtrarClientes()"
           style="width: 35%; padding: 10px; border: 1px solid #9400d3; border-radius: 5px; box-sizing: border-box;">
</div>

 
            </table>
        </section>

        <section id="secao-caixa" class="secao">
    <h2><i class="fas fa-file-invoice-dollar"></i> Relat√≥rio de Vendas</h2>
    
    <!-- RESUMOS FIXOS NO TOPO -->
    <div style="display: flex; flex-wrap: nowrap; gap: 15px; justify-content: space-between; overflow-x: auto; padding-bottom: 10px;">
        <div style="flex: 1; min-width: 180px; background-color: #ffe0ef; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center;">
            <strong style="color:#ff69b4;">üìÖ Vendas do DIA</strong>
            <div id="resumoDiaTotalVendas" style="color:#ff69b4; font-size:1.4em; font-weight:bold;">R$ 0,00</div>
            <div id="resumoDiaLucro" style="color:#28a745; font-size:0.9em; font-weight:bold; margin-top:5px;">Lucro: R$ 0,00 (0%)</div>
        </div>
        <div style="flex: 1; min-width: 180px; background-color: #ffe0ef; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center;">
            <strong style="color:#dc3545;">‚öñÔ∏è Dia ANTERIOR</strong>
            <div id="resumoDiaAnteriorTotalVendas" style="color:#dc3545; font-size:1.4em; font-weight:bold;">R$ 0,00</div>
            <div id="resumoDiaAnteriorLucro" style="color:#28a745; font-size:0.9em; font-weight:bold; margin-top:5px;">Lucro: R$ 0,00 (0%)</div>
        </div>
        <div style="flex: 1; min-width: 180px; background-color: #e0f0ff; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center;">
            <strong style="color:#ff8c00;">üíé Vendas na SEMANA</strong>
            <div id="resumoSemanaTotalVendas" style="color:#ff8c00; font-size:1.4em; font-weight:bold;">R$ 0,00</div>
            <div id="resumoSemanaLucro" style="color:#28a745; font-size:0.9em; font-weight:bold; margin-top:5px;">Lucro: R$ 0,00 (0%)</div>
        </div>
        <div style="flex: 1; min-width: 180px; background-color: #e0f0ff; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center;">
            <strong style="color:#3a7bd5;">üöÄ Vendas no M√äS</strong>
            <div id="resumoMesTotalVendas" style="color:#3a7bd5; font-size:1.4em; font-weight:bold;">R$ 0,00</div>
            <div id="resumoMesLucro" style="color:#28a745; font-size:0.9em; font-weight:bold; margin-top:5px;">Lucro: R$ 0,00 (0%)</div>
        </div>
        <div style="flex: 1; min-width: 180px; background-color: #e0f0ff; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center;">
            <strong style="color:#28a745;">üèÜ Vendas no ANO</strong>
            <div id="resumoAnoTotalVendas" style="color:#28a745; font-size:1.4em; font-weight:bold;">R$ 0,00</div>
            <div id="resumoAnoLucro" style="color:#28a745; font-size:0.9em; font-weight:bold; margin-top:5px;">Lucro: R$ 0,00 (0%)</div>
        </div>
    </div>

    <!-- SEGUNDO BLOCO DE RESUMOS -->
    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
        <!-- 1. CONSIGNA√á√ÉO PENDENTE -->
        <div style="flex: 1; max-width: 280px; min-width: 250px; background-color: #fff3cd; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" 
     onclick="abrirModalResumoConsignacoes()"
     onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(253,126,20,0.3)'"
     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.1)'">
    <strong style="color:#fd7e14;">‚úã Total de Consigna√ß√£o Pendente</strong>
    <div id="resumoTotalConsignacao" style="color:#fd7e14; font-size:1.4em; font-weight:bold;">R$ 0,00</div>
    
    <!-- ‚ú® NOVA LINHA: SALDO A RECEBER -->
    <div style="font-size: 0.85em; margin-top: 8px; padding-top: 5px; border-top: 1px solid rgba(253,126,20,0.3);">
        Saldo a Receber: <span id="resumoConsignacaoSaldo" style="color: #dc3545; font-weight: bold;">R$ 0,00</span>
    </div>
</div>
        
        <!-- 2. NOVO: FATURAMENTO GERAL (VENDAS) -->
<div style="flex: 1; max-width: 280px; min-width: 250px; background-color: #e3f2fd; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" 
     onclick="abrirModalAnaliseVendas()"
     onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(25,118,210,0.3)'"
     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.1)'">
    <strong style="color:#1976d2;">üíµ Total Faturamento Geral</strong>
    <div id="resumoFaturamentoGeral" style="color:#1976d2; font-size:1.4em; font-weight:bold;">R$ 0,00</div>
    <!-- NOVO: Linha de Lucro -->
    <div id="resumoLucroGeral" style="color:#28a745; font-size:0.9em; font-weight:bold; margin-top:5px;">Lucro: R$ 0,00 (0%)</div>
    <!-- ‚ú® NOVO: Indicador visual de clique -->
    <div style="font-size: 0.75em; margin-top: 5px; opacity: 0.85; color: #666;">
    </div>
</div>
        
        <!-- 3. TOTAL GERAL (VENDAS + CONSIGNA√á√ÉO) -->
<div style="flex: 1; max-width: 280px; min-width: 250px; background-color: #d4edda; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center;">
    <strong style="color:#28a745;">üí∞ Total (Vendas + Consigna√ß√£o)</strong>
    <div id="resumoTotalGeral" style="color:#28a745; font-weight:bold;">
        <div style="font-size: 1.4em;">R$ 0,00</div>
        <div style="font-size: 0.9em; margin-top: 5px; color: #155724;">
            Lucro: R$ 0,00 (0%)
        </div>
    </div>
</div>
         

        <!-- 4. NOVO: TROCAS - DIFEREN√áAS -->
<div style="flex: 1; max-width: 280px; min-width: 250px; background-color: #fff8dc; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" 
     onclick="abrirModalHistoricoTrocas()"
     onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(255,140,0,0.3)'"
     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.1)'">
    <strong style="color:#ff8c00;">üîÑ Trocas - Diferen√ßas</strong>
    <div id="resumoTotalTrocas" style="color:#ff8c00; font-size:1.4em; font-weight:bold;">R$ 0,00</div>
    <div style="font-size: 0.75em; margin-top: 5px; opacity: 0.85; color: #666;">
        üîç Clique para ver detalhes
    </div>
</div>
 </div>


   <!-- LINHA DIVIS√ìRIA LARANJA -->
<hr style="border: 0; border-top: 2px solid #fd7e14; margin: 25px 0; opacity: 0.6;">

<!-- RESUMO DO FILTRO ATUAL -->
    
<h3 style="text-align: center; margin-bottom: 15px; color: #3a7bd5;">
    <i class="fas fa-search"></i> Resumo do Filtro Atual
</h3>

<div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px; margin-bottom: 20px; flex-wrap: nowrap; overflow-x: auto;">
    <!-- Card 1: Total de Vendas -->
<div style="flex: 1; max-width: 180px; min-width: 180px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 10px; padding: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); text-align: center; color: white;">
    <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
        üí∞ Total de Vendas
    </div>
    <div id="resumoTotalVendas" style="font-size: 1.8em; font-weight: bold;">
        R$ 0,00
    </div>
    <div style="font-size: 0.75em; margin-top: 5px; opacity: 0.85;">
        no per√≠odo selecionado
    </div>
</div>
    
    <!-- Card 2: Total de Itens -->
    <div style="flex: 1; max-width: 180px; min-width: 180px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); border-radius: 10px; padding: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); text-align: center; color: white;">
        <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
            üì¶ Total de Itens
        </div>
        <div id="resumoTotalItens" style="font-size: 1.8em; font-weight: bold;">
            0
        </div>
        <div style="font-size: 0.75em; margin-top: 5px; opacity: 0.85;">
            vendidos no per√≠odo
        </div>
        <div id="resumoTotalItensComTrocas" style="font-size: 0.85em; margin-top: 8px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 5px; font-weight: 600;">
    c/ trocas: 0
</div>
  </div>
    
    <!-- Card 3: Ticket M√©dio -->
    <div style="flex: 1; max-width: 180px; min-width: 180px; background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%); border-radius: 10px; padding: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); text-align: center; color: white;">
        <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
            üéØ Ticket M√©dio
        </div>
        <div id="resumoTicketMedio" style="font-size: 1.8em; font-weight: bold;">
            R$ 0,00
        </div>
        <div style="font-size: 0.75em; margin-top: 5px; opacity: 0.85;">
            por item vendido
        </div>
    </div>

    <!-- Card 4: Trocas no Per√≠odo -->
    <div style="flex: 1; max-width: 180px; min-width: 180px; background: linear-gradient(135deg, #ff8c00 0%, #ff6347 100%); border-radius: 10px; padding: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); text-align: center; color: white;">
        <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
            üîÑ Trocas no Per√≠odo
        </div>
        <div id="resumoTrocasPeriodo" style="font-size: 1.8em; font-weight: bold;">
            R$ 0,00
        </div>
        <div style="font-size: 0.75em; margin-top: 5px; opacity: 0.85;">
            diferen√ßas pagas/devolvidas
        </div>
    </div>

      <!-- Card 5: NOVO - Faturamento Total (Vendas + Trocas) -->
<div style="flex: 1; max-width: 180px; min-width: 180px; background: linear-gradient(135deg, #9400d3 0%, #6a1ba3 100%); border-radius: 10px; padding: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); text-align: center; color: white;">
    <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
        üíé Faturamento Total
    </div>
    <div id="resumoFaturamentoTotal" style="font-size: 1.8em; font-weight: bold;">
        R$ 0,00
    </div>
    <div style="font-size: 0.75em; margin-top: 5px; opacity: 0.85;">
        vendas + trocas no per√≠odo
    </div>
    <!-- ‚ú® NOVO: Ticket M√©dio com Trocas (TAMANHO AUMENTADO) -->
    <div id="resumoTicketMedioComTrocas" style="font-size: 0.85em; margin-top: 8px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 5px; font-weight: 600;">
        Ticket c/ troca: R$ 0,00
    </div>
</div>
</div>

    <!-- FILTROS MOVIDOS PARA BAIXO DOS QUADRANTES -->
<div class="filtro-caixa">
    <div class="filtros-linha" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;"> 
        
        <!-- Filtrar por -->
        <div>
            <label for="filtroCaixa">Filtrar por:</label>
            <select id="filtroCaixa" style="width:200px;" onchange="alternarFiltrosCaixa(this.value)">
                <option value="todos">Todos os Registros</option>
                <option value="diario">Por Dia Espec√≠fico</option>
                <option value="mensal">Por M√™s/Ano</option>
            </select>
        </div>

        <!-- Dia (condicional) -->
        <div id="divFiltroDiario" style="display:none;">
            <label for="filtroDataDiaria">Dia:</label>
            <input type="date" id="filtroDataDiaria" style="width:150px;" onchange="aplicarFiltroDiario()">
        </div>

        <!-- M√™s/Ano (condicional) -->
        <div id="divFiltroMensal" style="display:none;">
            <label for="filtroDataMensal">M√™s/Ano:</label>
            <input type="month" id="filtroDataMensal" style="width:150px;" onchange="aplicarFiltroMensal()">
        </div>

        <!-- Pesquisar Venda -->
        <div style="flex: 1; min-width: 250px;">
            <label for="inputPesquisaVendas" style="font-weight: bold; color: #ff69b4;">
                üîç Pesquisar Venda (Descri√ß√£o, Cliente, SKU):
            </label>
            <input type="text" id="inputPesquisaVendas"
                   placeholder="Digite descri√ß√£o, cliente ou SKU para filtrar"
                   oninput="filtrarVendasPorTexto()"
                   style="width: 100%; padding: 10px; border: 1px solid #ff69b4; border-radius: 5px; box-sizing: border-box;">
        </div>

        <!-- Bot√£o Atualizar -->
        <button onclick="renderizarTabelaCaixa()" class="btn-acao" 
            style="background-color: #3a7bd5; height:38px; margin-bottom: 0;">
            <i class="fas fa-search"></i> Atualizar
        </button>

    </div>
</div>

    <h3 style="margin-top: 30px;"><i class="fas fa-table"></i> Detalhe das Vendas</h3>
    <table>
        <thead>
            <tr>
                <th>Data</th>
                <th>Hora</th>
                <th>SKU</th>
                <th>Descri√ß√£o</th>
                <th>Qtd</th>
                <th>Valor Unit.</th>
                <th>Valor Total</th>
                <th>Cliente</th>
                <th>Pagamento</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="corpoTabelaCaixa">
        </tbody>
    </table>
</section>

        <section id="secao-estoque" class="secao">
<div style="text-align: right; margin-bottom: 10px;">
    <button onclick="imprimirEstoque()" class="btn-acao" style="background-color: #9400d3;">
        <i class="fas fa-print"></i> Imprimir Estoque
    </button>
</div>

            <h2><i class="fas fa-warehouse"></i> Estoque Atual</h2>

            <div id="painelGeneroTamanho" style="margin:15px 0;">

    <button id="toggleResumoBtn" onclick="(function(btn){
    const area=document.getElementById('areaResumoGeneroTamanho');
    if(!area) return;
    const visible = window.getComputedStyle(area).display !== 'none';
    if(!visible){ area.style.display='block'; btn.textContent='üîΩ Ocultar Resumo por G√™nero e Tamanho'; if(typeof atualizarResumoGeneroTamanho==='function') atualizarResumoGeneroTamanho(); }
    else { area.style.display='none'; btn.textContent='üìä Mostrar Resumo por G√™nero e Tamanho'; }
})(this)" style="...">üìä Mostrar Resumo por G√™nero e Tamanho</button>

    <div id="areaResumoGeneroTamanho" style="display:none;">
        <h3 style="margin-bottom:10px; color:#3a7bd5;">
            <i class="fas fa-chart-pie"></i> Resumo por G√™nero e Tamanho
        </h3>

        <div id="resultadoGeneroTamanho" 
            style="display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
        </div>
    </div>

</div>

    <!-- BOT√ïES PARA MOSTRAR/OCULTAR VALORES E ESTOQUE ZERADO -->
<div style="text-align:right; margin-bottom:8px; display:flex; gap:10px; justify-content:flex-end;">
  <button id="toggleValoresEstoque" class="btn-acao" style="background-color:#6c757d;">
    üîí Ocultar Valores
  </button>
  <button id="toggleEstoqueZerado" class="btn-acao" style="background-color:#dc3545;">
    üëÅÔ∏è Mostrar Estoque Zerado
  </button>
</div>
 	
<div id="resumoEstoque" style="display:flex; gap:10px; margin:10px 0;">
    <div style="flex:1; background:#e0f0ff; padding:10px; border-radius:8px; text-align:center;">
        <strong>Total Itens em Estoque</strong>
        <div id="resumoQtdEstoque" style="font-size:1.4em; font-weight:bold;">0</div>
    </div>
    <div style="flex:1; background:#d4edda; padding:10px; border-radius:8px; text-align:center;">
        <strong>Valor Total Custo</strong>
        <div id="resumoCustoEstoque" style="font-size:1.4em; font-weight:bold;">R$ 0,00</div>
    </div>
    <div style="flex:1; background:#fff3cd; padding:10px; border-radius:8px; text-align:center;">
        <strong>Valor Total Venda</strong>
        <div id="resumoVendaEstoque" style="font-size:1.4em; font-weight:bold;">R$ 0,00</div>
        <div id="resumoLucroVendaEstoque" style="font-size:0.85em; color:#28a745; font-weight:bold; margin-top:5px;">Lucro: R$ 0,00 (0%)</div>
    </div>
</div>

            
            <div class="filtro-estoque" style="margin-bottom: 15px;">
                <label for="inputPesquisaEstoque" style="font-weight: bold; color: #9400d3;">Pesquisar no Estoque (SKU, Marca, Gen√™ro, Modelo, Cor, Tamanho):</label>
                <input type="text" id="inputPesquisaEstoque" 
                       placeholder="Digite o termo de busca para filtrar a tabela..." 
                       oninput="filtrarEstoque()" 
                       style="width: 35%; padding: 10px; border: 1px solid #9400d3; border-radius: 5px; box-sizing: border-box;">
            </div>
            <table>
                <thead>
                    <tr>
                        <th>SKU Sistema</th> 
                        <th>SKU Fabricante</th> 
                        <th>Marca</th>
                        <th>G√™nero</th>
                        <th>Modelo.</th>
                        <th>Cor</th>
                        <th>Tamanho</th>
                        <th>Custo</th>
                        <th>Venda</th>
                        <th>Estoque</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaEstoque">
                    </tbody>
            </table>
        </section>

        <p style="text-align: center; color: #aaa; margin-top: 30px; font-size: 0.8em; border-top: 1px solid #eee; padding-top: 10px;">
            Vers√£o do Sistema: <span id="versaoSistema">v1.2 - Implanta√ß√£o Consiganado (24/11/2025)</span>
        </p>

    </div>
    
    <div class="rodape-utilitarios container">
    <button onclick="exportarDados()" class="alerta-backup-piscante">
        <i class="fas fa-download"></i> Fechamento (Fa√ßa o Backup Completo por Seguran√ßa)
    </button>
    <label for="importFile" class="btn-acao" style="margin-left: 10px; display: inline-block; background-color: transparent; border: 1px solid #ccc; color: #888; padding: 5px 10px; cursor: pointer; border-radius: 5px; font-size: 0.9em;">
        <i class="fas fa-upload"></i> Importar Dados
    </label>
    <input type="file" id="importFile" accept=".json" onchange="importarDados(event)" />
    
    <!-- üëáüëáüëá ADICIONE TODO ESTE BLOCO AQUI üëáüëáüëá -->
    
    <!-- Link do Instagram -->
    <a href="https://www.instagram.com/rosangela_anjos_kids" target="_blank" rel="noopener noreferrer" 
       style="margin-left: 15px; display: inline-block; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); 
              color: white; padding: 5px 12px; border-radius: 5px; text-decoration: none; font-size: 0.9em; 
              transition: transform 0.2s, box-shadow 0.2s; font-weight: bold;"
       onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(188,24,136,0.4)'"
       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
        <i class="fab fa-instagram"></i> @rosangela_anjos_kids
    </a>
    
    <!-- Link do Facebook -->
    <a href="https://www.facebook.com/rosangela.camiloti.soares" target="_blank" rel="noopener noreferrer" 
       style="margin-left: 10px; display: inline-block; background: #1877f2; 
              color: white; padding: 5px 12px; border-radius: 5px; text-decoration: none; font-size: 0.9em; 
              transition: transform 0.2s, box-shadow 0.2s; font-weight: bold;"
       onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(24,119,242,0.4)'; this.style.background='#166fe5'"
       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'; this.style.background='#1877f2'">
        <i class="fab fa-facebook-f"></i> Facebook
    </a>

     <!-- Link do Site -->
<a href="https://www.anjoskidsmodainfantil.com.br/" target="_blank" rel="noopener noreferrer" 
   style="margin-left: 10px; display: inline-block; background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%); 
          color: white; padding: 5px 12px; border-radius: 5px; text-decoration: none; font-size: 0.9em; 
          transition: transform 0.2s, box-shadow 0.2s; font-weight: bold;"
   onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(255,20,147,0.4)'"
   onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
    <i class="fas fa-globe"></i> Nosso Site
</a>

      <!-- Link do Painel Meloja -->
<a href="https://painel.meloja.com.br/painel/pedidos" target="_blank" rel="noopener noreferrer" 
   style="margin-left: 10px; display: inline-block; background: linear-gradient(135deg, #9400d3 0%, #6a1ba3 100%); 
          color: white; padding: 5px 12px; border-radius: 5px; text-decoration: none; font-size: 0.9em; 
          transition: transform 0.2s, box-shadow 0.2s; font-weight: bold;"
   onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(148,0,211,0.4)'"
   onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
    <i class="fas fa-shopping-bag"></i> Pedidos Anjos Kids
</a>

</div>

    <div id="modalEdicaoCliente" class="modal">
        <div class="modal-content">
            <span class="fechar" onclick="fecharModal('modalEdicaoCliente')">&times;</span>
            <h3><i class="fas fa-user-edit"></i> Editar Cliente</h3>
            <form id="formEdicaoCliente">
                <input type="hidden" id="editCpfOriginal">
                <label for="editNomeCliente">Nome Completo:</label>
                <input type="text" id="editNomeCliente" required>
                <label for="editCpf">CPF:</label>
                <input type="text" id="editCpf" required> 
                <label for="editTelefone">Telefone:</label>
                <input type="text" id="editTelefone">
                <label for="editRua">Rua/Av:</label>
                <input type="text" id="editRua">
                <label for="editNumero">N√∫mero:</label>
                <input type="text" id="editNumero">
                <label for="editBairro">Bairro:</label>
                <input type="text" id="editBairro">
                <label for="editCep">CEP:</label>
                <input type="text" id="editCep">
                <button type="submit" class="btn-acao"><i class="fas fa-save"></i> Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>
    
    <div id="modalEdicaoProduto" class="modal">
        <div class="modal-content">
            <span class="fechar" onclick="fecharModal('modalEdicaoProduto')">&times;</span>
            <h3><i class="fas fa-edit"></i> Editar Produto</h3>
            <form id="formEdicaoProduto">
                <input type="hidden" id="editSkuOriginal">
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label for="editSku">SKU do Sistema (Chave Prim√°ria):</label> <input type="text" id="editSku" required disabled> 
                    </div>
                    <div style="flex: 1;">
                        <label for="editSkuFabricante">SKU do Fabricante (Manual):</label> <input type="text" id="editSkuFabricante">
                    </div>
                </div>
                <label for="editMarca">Marca:</label>
                <input type="text" id="editMarca" required>
                
                <label for="editModelo">Modelo/Descri√ß√£o:</label>
                <input type="text" id="editModelo" required>

                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label for="editCor">Cor:</label>
                        <input type="text" id="editCor" required>
                    </div>
                    <div style="flex: 1;">
                        <label for="editTamanho">Tamanho:</label>
                        <input type="text" id="editTamanho" required>
                    </div>
                    <div style="flex: 1;">
                        <label for="editCusto">Pre√ßo de Custo (R$):</label>
                        <input type="number" id="editCusto" step="0.01" required>
                    </div>
                    <div style="flex: 1;">
                        <label for="editVenda">Pre√ßo de Venda (R$):</label>
                        <input type="number" id="editVenda" step="0.01" required>
                    </div>
                </div>

                <label for="editQuantidade">Quantidade em Estoque:</label>
                <input type="number" id="editQuantidade" min="0" required>
                <button type="submit" class="btn-acao"><i class="fas fa-save"></i> Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>
    
    <div id="modalEdicaoCaixa" class="modal">
        <div class="modal-content">
            <span class="fechar" onclick="fecharModal('modalEdicaoCaixa')">&times;</span>
            <h3><i class="fas fa-history"></i> Ajustar Registro de Venda</h3>
            <p style="color: #dc3545; font-weight: bold;">AVISO: Esta altera√ß√£o afeta o estoque e o relat√≥rio.</p>
            <form id="formEdicaoCaixa">
                <input type="hidden" id="editCaixaId">
                <input type="hidden" id="editCaixaSku">
                <input type="hidden" id="editCaixaQtdOriginal">
                
                <label>Produto:</label>
                <p id="editCaixaDescricao" style="font-weight: bold;"></p>
                
                <label for="editCaixaNovaQtd">Nova Quantidade Vendida:</label>
                <input type="number" id="editCaixaNovaQtd" min="1" required>
                
                <label for="editCaixaNovoCliente">Nome/CPF do Cliente (para o relat√≥rio):</label>
                <input type="text" id="editCaixaNovoCliente" placeholder="Nome ou CPF do cliente">
                
                <button type="submit" class="btn-acao"><i class="fas fa-save"></i> Salvar Ajuste</button>
            </form>
        </div>
    </div>
    
    <div id="modalCadastroClienteVenda" class="modal">
        <div class="modal-content">
            <span class="fechar" onclick="fecharModal('modalCadastroClienteVenda')">&times;</span>
            <h3><i class="fas fa-user-plus"></i> Cliente N√£o Encontrado. Cadastrar:</h3>
            <p style="color: #dc3545; font-weight: bold;">√â necess√°rio o cadastro para prosseguir com a venda quando o CPF √© informado.</p>
            <form id="formCadastroClienteVenda">
                <label for="vendaNomeCliente">Nome Completo:</label>
                <input type="text" id="vendaNomeCliente" required>
                <label for="vendaCpf">CPF:</label>
                <input type="text" id="vendaCpf" required> 
                <label for="vendaTelefone">Telefone:</label>
                <input type="text" id="vendaTelefone">
                <button type="submit" class="btn-acao" style="background-color: #ff69b4;"> <i class="fas fa-save"></i> Cadastrar e Finalizar Venda </button>
            </form>
        </div>
    </div>
    
    <div id="modalVendaSemCadastro" class="modal">
        <div class="modal-content">
            <span class="fechar" onclick="fecharModal('modalVendaSemCadastro')">&times;</span>
            <h3><i class="fas fa-user-times"></i> Cliente sem cadastro</h3>
            <p>O cliente informado n√£o possui cadastro. Escolha uma das op√ß√µes abaixo:</p>
            <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                <button onclick="abrirModalConfirmacaoSemCadastro()" class="btn-acao" style="background-color: #28a745;">
                    <i class="fas fa-check"></i> Continuar sem cadastro
                </button>
                <button onclick="abrirModalCadastroNovoCliente()" class="btn-acao" style="background-color: #3a7bd5;">
                    <i class="fas fa-user-plus"></i> Fazer cadastro de novo cliente
                </button>
                <button onclick="fecharModal('modalVendaSemCadastro')" class="btn-remover">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
    
    <div id="modalConfirmacaoVenda" class="modal">
        <div class="modal-content">
            <span class="fechar" onclick="fecharModal('modalConfirmacaoVenda')">&times;</span>
            <h3><i class="fas fa-check-circle"></i> Confirmar Venda</h3>
            <p>Cliente: <strong id="confirmNomeCliente"></strong></p>
            <p>CPF: <strong id="confirmCpfCliente"></strong></p>
            <p>Total: <strong id="confirmTotalVenda" style="color: #ff69b4;"></strong></p>
            <p id="alertaTaxaCredito" style="margin-top: 5px; font-weight: bold; font-size: 0.9em; display: none;"></p>
            <div style="margin-top: 20px;">
                <label for="metodoPagamento">M√©todo de Pagamento:</label>
                <select id="metodoPagamento" onchange="atualizarTotalModal()">
                    <option value="DINHEIRO">Dinheiro</option>
                    <option value="PIX">PIX</option>
                    <option value="CARTAO_DEBITO">Cart√£o de D√©bito</option>
                    <option value="CARTAO_CREDITO">Cart√£o de Cr√©dito</option>
                    <option value="APRAZO">Aprazo</option>
                </select>
            </div>
            <div style="margin-top: 20px;">
                <button onclick="finalizarVenda(false)" class="btn-acao" style="background-color: #28a745;">
                    <i class="fas fa-money-check-alt"></i> Confirmar e Registrar
                </button>
                <button onclick="fecharModal('modalConfirmacaoVenda')" class="btn-remover">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
    
    <div id="modalHistoricoVendas" class="modal">
        <div class="modal-content">
            <span class="fechar" onclick="fecharModal('modalHistoricoVendas')">&times;</span>
            <h3><i class="fas fa-history"></i> Hist√≥rico de Compras do Cliente</h3>
            <p>Cliente: <strong id="historicoClienteNome" style="color: #3a7bd5;"></strong> (CPF: <strong id="historicoClienteCpf"></strong>)</p>
            <p>Total Gasto: <strong id="historicoTotalGasto" style="color: #ff69b4; font-size: 1.1em;"></strong></p>
            <div style="text-align: right; margin-bottom: 10px;">
    <button onclick="imprimirHistoricoCliente()" class="btn-acao" style="background-color: #9400d3;">
        <i class="fas fa-print"></i> Imprimir Hist√≥rico
    </button>
</div>
            <div id="corpoTabelaHistoricoVendas" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
            </div>
        </div>
    </div>

<!-- NOVO MODAL: Detalhes de Produtos por G√™nero/Tamanho -->
<div id="modalDetalhesTamanho" class="modal">
    <div class="modal-content">
        <span class="fechar" onclick="fecharModal('modalDetalhesTamanho')">&times;</span>
        <h3 id="tituloDetalhesTamanho"><i class="fas fa-list"></i> Produtos</h3>
        
        <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
            <table style="width:100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f0f8ff;">
                        <th>SKU</th>
                        <th>Marca</th>
                        <th>Modelo</th>
                        <th>Cor</th>
                        <th>Pre√ßo</th>
                        <th>Estoque</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaDetalhesTamanho"></tbody>
            </table>
        </div>
        
        <div style="text-align: right; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
            <p><strong>Total de produtos nesta categoria:</strong> <span id="totalProdutosCategoria" style="color:#3a7bd5; font-size:1.2em;">0</span></p>
        </div>
    </div>
</div>

           <div id="modalDetalhesConsignacao" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="fechar" onclick="fecharModal('modalDetalhesConsignacao')">&times;</span>
        <h3><i class="fas fa-search-plus"></i> Detalhes da Consigna√ß√£o ID <span id="detalhesConsignacaoID"></span></h3>
        
        <p><strong>Cliente:</strong> <span id="detalhesConsignacaoCliente"></span></p>
        <p><strong>Data de Abertura:</strong> <span id="detalhesConsignacaoData"></span></p>
        
        <!-- üìÖ NOVO: Resumo por Data -->
        <div style="background-color: #fff3cd; border: 2px solid #fd7e14; border-radius: 8px; padding: 15px; margin: 15px 0;">
            <h4 style="margin: 0 0 10px 0; color: #fd7e14;">
                <i class="fas fa-calendar-check"></i> Resumo por Data de Inclus√£o
            </h4>
            <div id="resumoPorDataConsignacao"></div>
        </div>
        
        <h4 style="margin-top: 20px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Itens no Pacote:</h4>
        
        <div style="max-height: 400px; overflow-y: auto;">
            <table id="tabelaDetalhesConsignacao" style="width:100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f0f8ff;">
                        <th style="width:12%;">Data</th>
                        <th style="width:15%;">SKU</th>
                        <th style="width:35%;">Descri√ß√£o</th>
                        <th style="width:10%;">Qtd</th>
                        <th style="width:20%;">Unit√°rio (R$)</th>
                        <th style="width:20%;">Subtotal (R$)</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaDetalhesConsignacao"></tbody>
                <tfoot>
                    <tr style="font-weight:bold; font-size:1.1em; background:#e6f7ff;">
                        <td colspan="3" style="text-align:right; padding:12px;">TOTAL DE PRODUTOS:</td>
                        <td id="totalQtdDetalhesConsignacao" style="text-align:center; color:#d35400;">0</td>
                        <td style="text-align:right;"> VENDA:</td>
                        <td id="totalDetalhesConsignacao" style="text-align:center; color:#d35400;">R$ 0,00</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button id="btnIniciarVendaDetalhes" onclick="imprimirDetalhesConsignacao(consignacaoEmVisualizacao)" class="btn-acao" style="background-color: #007bff;">
                <i class="fas fa-print"></i> Imprimir Detalhes de Consigna√ß√£o
            </button>
        </div>
    </div>
</div>
   

    <div id="divReciboPrint" style="display: none;">
    </div>
   

    <!-- MODAL: Relat√≥rio Resumido de Consigna√ß√µes -->
<div id="modalRelatorioConsignacoes" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="fechar" onclick="fecharModal('modalRelatorioConsignacoes')">&times;</span>
        <h3><i class="fas fa-calendar-alt"></i> Relat√≥rio de Consigna√ß√µes por Dia</h3>
        
        <div style="text-align: right; margin-bottom: 15px;">
            <button onclick="imprimirRelatorioConsignacoes()" class="btn-acao" style="background-color: #9400d3;">
                <i class="fas fa-print"></i> Imprimir
            </button>
        </div>
        
        <div id="conteudoRelatorioConsignacoes" style="max-height: 500px; overflow-y: auto;">
            <!-- Conte√∫do gerado -->
        </div>
    </div>
</div>

    <div id="modalSelecaoCliente" class="modal">
    <div class="modal-content">
        <span class="fechar" onclick="fecharModal('modalSelecaoCliente')">&times;</span>
        <h3><i class="fas fa-users"></i> Selecionar ou Cadastrar Cliente</h3>
        
        <!-- Form de Cadastro R√°pido (simples, reutilizando campos essenciais) -->
        <form id="formCadastroClienteRapido" style="margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 15px;">
            <h4>Cadastrar Novo Cliente:</h4>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <label for="novoNomeCliente">Nome Completo:</label>
                    <input type="text" id="novoNomeCliente" required>
                </div>
                <div style="flex: 1;">
                    <label for="novoCpf">CPF:</label>
                    <input type="text" id="novoCpf" required oninput="aplicarMascaraCpf(this)">
                </div>
                <div style="flex: 1;">
                    <label for="novoTelefone">Telefone:</label>
                    <input type="text" id="novoTelefone">
                </div>
            </div>
            
            <button type="submit" class="btn-acao" style="margin-top: 10px;"><i class="fas fa-save"></i> Cadastrar e Selecionar</button>
        </form>
        
        <!-- Pesquisa e Tabela de Clientes Existentes -->
        <h4>Clientes Existentes:</h4>
        <div class="filtro-clientes" style="margin-bottom: 15px;">
            <label for="inputPesquisaClientesModal">üîç Pesquisar Cliente (Nome ou CPF):</label>
            <input type="text" id="inputPesquisaClientesModal" placeholder="Digite nome ou CPF para filtrar" oninput="filtrarClientesModal()" style="width: 100%; padding: 10px; border: 1px solid #9400d3; border-radius: 5px; box-sizing: border-box;">
        </div>
        <div style="max-height: 300px; overflow-y: auto;"> <!-- Scroll se houver muitos clientes -->
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>Telefone</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaClientesModal">
                    <!-- Preenchido via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- =============================================== -->
<!-- MODAL: SISTEMA DE TROCAS/DEVOLU√á√ïES -->
<!-- =============================================== -->
<div id="modalTroca" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="fechar" onclick="fecharModal('modalTroca')">&times;</span>
        <h3><i class="fas fa-exchange-alt"></i> Sistema de Trocas e Devolu√ß√µes</h3>
        
        <!-- ETAPA 1: Sele√ß√£o do Cliente -->
<div id="etapaTrocaCliente" style="border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <h4 style="color: #ffc107; margin-top: 0;">
        <i class="fas fa-user"></i> Etapa 1: Selecionar Cliente
    </h4>
    
    <div style="display: flex; gap: 10px; align-items: flex-end;">
        <div style="flex: 1;">
            <label for="cpfClienteTroca">CPF ou Nome do Cliente:</label>
            <input type="text" id="cpfClienteTroca" placeholder="Digite CPF ou Nome" 
                   oninput="aplicarMascaraCpf(this); validarClienteTroca()">
        </div>
        
        <!-- üÜï BOT√ÉO MELHORADO -->
        <button onclick="abrirModalSelecaoClienteParaTrocaMelhorado()" class="btn-acao" 
                style="background-color: #ffc107; color: black; padding: 12px 20px; white-space: nowrap;">
            <i class="fas fa-search"></i> + Cliente
        </button>
    </div>
    
    <p id="infoClienteTroca" style="margin-top: 10px; color: #ffc107; font-weight: bold;">
        Cliente: N√£o identificado
    </p>
</div>
        
        <!-- ETAPA 2: Sele√ß√£o de Produtos para Devolu√ß√£o -->
        <div id="etapaTrocaDevolucao" style="border: 2px solid #dc3545; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
            <h4 style="color: #dc3545; margin-top: 0;">
                <i class="fas fa-undo"></i> Etapa 2: Produtos para Devolu√ß√£o
            </h4>
            
            <div style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;">
                <table id="tabelaHistoricoTroca" style="width: 100%;">
                    <thead>
                        <tr style="background-color: #f8d7da;">
                            <th>Data</th>
                            <th>SKU</th>
                            <th>Descri√ß√£o</th>
                            <th>Qtd</th>
                            <th>Valor Unit.</th>
                            <th>Valor Total</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="corpoTabelaHistoricoTroca"></tbody>
                </table>
            </div>
            
            <div style="background-color: #f8d7da; padding: 10px; border-radius: 5px;">
                <h5 style="margin: 0 0 10px 0; color: #dc3545;">
                    <i class="fas fa-inbox"></i> Produtos Selecionados para Devolu√ß√£o:
                </h5>
                <div id="listaProdutosDevolucao" style="min-height: 50px;"></div>
                <div style="text-align: right; font-size: 1.2em; font-weight: bold; color: #dc3545; margin-top: 10px;">
                    Total Devolvido: <span id="totalDevolucao">R$ 0,00</span>
                </div>
            </div>
        </div>
        
        <!-- ETAPA 3: Sele√ß√£o de Novos Produtos -->
        <div id="etapaTrocaNovos" style="border: 2px solid #28a745; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
            <h4 style="color: #28a745; margin-top: 0;">
                <i class="fas fa-box-open"></i> Etapa 3: Novos Produtos
            </h4>
            
            <form id="formAdicionarProdutoTroca" style="display: flex; gap: 10px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label for="skuTroca">SKU do Sistema ou Fabricante:</label>
                    <input type="text" id="skuTroca" required 
                           oninput="exibirDetalhesProdutoTroca()" placeholder="Digite o SKU">
                </div>
                <button type="submit" class="btn-acao" style="align-self: flex-end;">
                    <i class="fas fa-plus-circle"></i> Adicionar
                </button>
            </form>
            
            <div style="background-color: #d4edda; padding: 10px; border-radius: 5px;">
                <h5 style="margin: 0 0 10px 0; color: #28a745;">
                    <i class="fas fa-shopping-bag"></i> Novos Produtos Selecionados:
                </h5>
                <div id="listaProdutosNovos" style="min-height: 50px;"></div>
                <div style="text-align: right; font-size: 1.2em; font-weight: bold; color: #28a745; margin-top: 10px;">
                    Total Novos Produtos: <span id="totalNovos">R$ 0,00</span>
                </div>
            </div>
        </div>
        
        <!-- RESUMO FINAL -->
        <div style="background-color: #e7f3ff; border: 2px solid #3a7bd5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="color: #3a7bd5; margin-top: 0;">
                <i class="fas fa-calculator"></i> Resumo da Troca
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 1.1em;">
                <div>
                    <strong>Total Devolvido:</strong>
                    <span id="resumoTotalDevolucao" style="color: #dc3545;">R$ 0,00</span>
                </div>
                <div>
                    <strong>Total Novos Produtos:</strong>
                    <span id="resumoTotalNovos" style="color: #28a745;">R$ 0,00</span>
                </div>
            </div>
            <hr style="margin: 10px 0;">
            <div style="text-align: center; font-size: 1.3em; font-weight: bold;">
                <span id="resumoDiferenca" style="color: #3a7bd5;">Diferen√ßa: R$ 0,00</span>
            </div>
        </div>
        
        <!-- BOT√ïES DE A√á√ÉO -->
        <div style="text-align: right;">
            <button onclick="finalizarTroca()" class="btn-acao" 
                    style="background-color: #3a7bd5; font-size: 1.1em; padding: 12px 24px;">
                <i class="fas fa-check-double"></i> Finalizar Troca
            </button>
            <button onclick="cancelarTroca()" class="btn-remover" style="margin-left: 10px;">
                <i class="fas fa-times"></i> Cancelar
            </button>
        </div>
    </div>
</div>
    
    <script>

// ========== FUN√á√ïES PARA CPF AUTOM√ÅTICO ==========

function formatarCPFNumero(numero) {
    const cpfStr = String(numero).padStart(11, '0');
    return cpfStr.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}

function gerarProximoCPF() {
    const clientes = getDados('clientes') || [];
    let ultimoNumero = 4;
    
    if (clientes.length > 0) {
        clientes.forEach(cliente => {
            const cpfNumerico = cliente.cpf.replace(/\D/g, '');
            if (cpfNumerico.startsWith('000000000')) {
                const numero = parseInt(cpfNumerico);
                if (numero > ultimoNumero) {
                    ultimoNumero = numero;
                }
            }
        });
    }
    
    return formatarCPFNumero(ultimoNumero + 1);
}

function gerenciarCampoCPF() {
    const checkbox = document.getElementById('checkNaoInformarCPF');
    const campoCPF = document.getElementById('cpf');
    
    if (!checkbox || !campoCPF) return;
    
    if (checkbox.checked) {
        campoCPF.value = gerarProximoCPF();
        campoCPF.disabled = true;
        campoCPF.style.backgroundColor = '#e9ecef';
        campoCPF.style.cursor = 'not-allowed';
        campoCPF.removeAttribute('required');
    } else {
        campoCPF.value = '';
        campoCPF.disabled = false;
        campoCPF.style.backgroundColor = '';
        campoCPF.style.cursor = '';
        campoCPF.setAttribute('required', 'required');
    }
}

// ===============================================
// AN√ÅLISE DETALHADA DE VENDAS
// ===============================================

function abrirModalAnaliseVendas() {
    const vendas = getDados(STORAGE_CAIXA) || [];
    const produtos = getDados(STORAGE_PRODUTOS);
    
    if (vendas.length === 0) {
        alert('Nenhuma venda registrada ainda.');
        return;
    }
    
    // Filtros de agrega√ß√£o
    const marcas = {};
    const tamanhos = {};
    const modelos = {};
    const generos = {};
    
    let totalQtd = 0;
    let totalValor = 0;
    
    // Processa vendas (ignora trocas)
    vendas.forEach(venda => {
        // Ignora movimentos de troca
        if (venda.tipoMovimento && venda.tipoMovimento.startsWith('troca_')) {
            return;
        }
        
        const produto = produtos.find(p => p.sku === venda.sku);
        if (!produto) return;
        
        const qtd = venda.quantidade;
        const valor = venda.valorTotal;
        
        totalQtd += qtd;
        totalValor += valor;
        
        // Agrega marcas
        if (!marcas[produto.marca]) marcas[produto.marca] = { qtd: 0, valor: 0 };
        marcas[produto.marca].qtd += qtd;
        marcas[produto.marca].valor += valor;
        
        // Agrega tamanhos
        if (!tamanhos[produto.tamanho]) tamanhos[produto.tamanho] = { qtd: 0, valor: 0 };
        tamanhos[produto.tamanho].qtd += qtd;
        tamanhos[produto.tamanho].valor += valor;
        
        // Agrega modelos
        if (!modelos[produto.modelo]) modelos[produto.modelo] = { qtd: 0, valor: 0 };
        modelos[produto.modelo].qtd += qtd;
        modelos[produto.modelo].valor += valor;
        
        // Agrega g√™neros
        const gen = produto.genero || 'N√£o Especificado';
        if (!generos[gen]) generos[gen] = { qtd: 0, valor: 0 };
        generos[gen].qtd += qtd;
        generos[gen].valor += valor;
    });
    
    // Atualiza cards principais
    document.getElementById('analiseQtdTotal').textContent = totalQtd;
    document.getElementById('analiseFaturamentoTotal').textContent = formatarMoeda(totalValor);
    
    const ticketMedio = totalQtd > 0 ? totalValor / totalQtd : 0;
    document.getElementById('analiseTicketMedio').textContent = formatarMoeda(ticketMedio);
    
    // Renderiza Top 5 de cada categoria
    renderizarTopN('analiseTopMarcas', marcas, totalQtd, '#3a7bd5');
    renderizarTopN('analiseTopTamanhos', tamanhos, totalQtd, '#28a745');
    renderizarTopN('analiseTopModelos', modelos, totalQtd, '#ff69b4');
    renderizarTopN('analiseTopGeneros', generos, totalQtd, '#9400d3');
    
    // Abre modal
    abrirModal('modalAnaliseVendas');
}

// Fun√ß√£o auxiliar para renderizar Top N
function renderizarTopN(elementoId, dados, totalGeral, cor) {
    const elemento = document.getElementById(elementoId);
    
    // Converte objeto em array e ordena por quantidade
    const arrayOrdenado = Object.entries(dados)
        .map(([nome, info]) => ({ nome, qtd: info.qtd, valor: info.valor }))
        .sort((a, b) => b.qtd - a.qtd)
        .slice(0, 5); // Top 5
    
    if (arrayOrdenado.length === 0) {
        elemento.innerHTML = '<p style="color: #888; text-align: center;">Sem dados</p>';
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
    
    arrayOrdenado.forEach((item, index) => {
        const percentual = ((item.qtd / totalGeral) * 100).toFixed(1);
        const posicao = index + 1;
        
        // √çcones de medalha para os 3 primeiros
        let icone = '';
        if (posicao === 1) icone = 'ü•á';
        else if (posicao === 2) icone = 'ü•à';
        else if (posicao === 3) icone = 'ü•â';
        else icone = `${posicao}¬∫`;
        
        html += `
            <div style="background: #f9f9f9; padding: 10px; border-radius: 8px; border-left: 4px solid ${cor};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <span style="font-weight: bold; font-size: 1.1em;">${icone} ${item.nome}</span>
                    <span style="color: ${cor}; font-weight: bold;">${item.qtd} un</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                    <span>${formatarMoeda(item.valor)}</span>
                    <span>${percentual}% do total</span>
                </div>
                <div style="width: 100%; height: 6px; background: #e0e0e0; border-radius: 3px; margin-top: 5px; overflow: hidden;">
                    <div style="width: ${percentual}%; height: 100%; background: ${cor}; border-radius: 3px;"></div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    elemento.innerHTML = html;
}

// Fun√ß√£o para imprimir a an√°lise
function imprimirAnaliseVendas() {
    const conteudo = document.querySelector('#modalAnaliseVendas .modal-content').cloneNode(true);
    
    // Remove bot√µes de a√ß√£o
    const botoes = conteudo.querySelectorAll('button');
    botoes.forEach(btn => btn.remove());
    
    // Remove o bot√£o fechar (X)
    const fechar = conteudo.querySelector('.fechar');
    if (fechar) fechar.remove();
    
    const janelaImpressao = window.open('', '', 'width=1000,height=800');
    janelaImpressao.document.write(`
        <html>
        <head>
            <title>An√°lise de Vendas - Anjos Kids</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    padding: 20px; 
                    background: white;
                }
                h3 { 
                    color: #3a7bd5; 
                    text-align: center; 
                    border-bottom: 3px solid #3a7bd5;
                    padding-bottom: 10px;
                }
                ${document.querySelector('style').textContent}
                @media print {
                    body { font-size: 11pt; }
                    .modal-content { box-shadow: none !important; }
                }
            </style>
        </head>
        <body>
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #3a7bd5; margin: 0;">Anjos Kid's</h2>
                <p style="color: #888; font-size: 0.9em;">Data: ${formatarDataHoraSegura(new Date().getTime())}</p>
            </div>
            ${conteudo.innerHTML}
        </body>
        </html>
    `);
    janelaImpressao.document.close();
    
    setTimeout(() => {
        janelaImpressao.print();
    }, 250);
}

// =========================================================================
// NOVO: Fun√ß√£o para filtrar a tabela de Vendas (Relat√≥rio de Caixa) em tempo real
// =========================================================================
const filtrarVendasPorTexto = () => {
    const termo = document.getElementById('inputPesquisaVendas').value.trim().toUpperCase();
    const linhas = document.querySelectorAll('#corpoTabelaCaixa tr');
    
    if (termo === '') {
        linhas.forEach(linha => {
            linha.style.display = '';
        });
        return;
    }

    linhas.forEach(linha => {
        if (linha.cells.length < 8) {
            linha.style.display = 'none';
            return;
        }

        // Busca em: SKU (cells[2]), Descri√ß√£o (cells[3]) e Cliente (cells[7])
        const textoLinha = `${linha.cells[2].textContent} ${linha.cells[3].textContent} ${linha.cells[7].textContent}`.toUpperCase();
        
        linha.style.display = textoLinha.includes(termo) ? '' : 'none';
    });
};

/**
 * Retorna a parte "base" do SKU (antes do '-') em mai√∫sculas.
 * Ex: '01001-P-MASC' -> '01001'
 */
function obterBaseSku(sku) {
  if (!sku) return '';
  return sku.toString().split('-')[0].trim().toUpperCase();
}

/**
 * Gera o Kardex (hist√≥rico) para o SKU informado.
 * Procura por vendas em STORAGE_CAIXA que contenham o SKU exato
 * ou cujo SKU base corresponda ao SKU base informado.
 */
function gerarKardexParaSku(skuInput) {
  const sku = (skuInput || '').toString().trim();
  const container = document.getElementById('kardexConsulta');
  const corpo = document.getElementById('corpoTabelaKardex');
  const resumo = document.getElementById('kardexResumo');

  // Esconde se SKU vazio
  if (!sku) {
    if (container) container.style.display = 'none';
    return;
  }

  // Exibe container
  if (container) container.style.display = 'block';

  const baseBusca = obterBaseSku(sku);
  const vendas = getDados(STORAGE_CAIXA) || [];
  const produtos = getDados(STORAGE_PRODUTOS) || [];

  // Filtra vendas pelo SKU exato OU que tenham o mesmo baseSku
  const vendasFiltradas = vendas.filter(v => {
    if (!v.sku) return false;
    const vSku = v.sku.toString().trim().toUpperCase();
    const vBase = obterBaseSku(vSku);
    return vSku === sku.toUpperCase() || vBase === baseBusca;
  });

  // Ordena desc por timestamp (mais recente primeiro) se dispon√≠vel
  vendasFiltradas.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

  // Atualiza resumo: soma total vendido e quantidade
  let totalQtd = 0;
  let totalValor = 0;
  vendasFiltradas.forEach(v => { totalQtd += Number(v.quantidade || 0); totalValor += Number(v.valorTotal || 0); });

  resumo.textContent = `SKU consultado: ${sku.toUpperCase()} ‚Äî Movimentos encontrados: ${vendasFiltradas.length} | Qtd total: ${totalQtd} | Valor total: ${formatarMoeda(totalValor)}`;

  // Preenche tabela
  corpo.innerHTML = '';
  if (vendasFiltradas.length === 0) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 7;
    td.style.textAlign = 'center';
    td.style.color = '#888';
    td.textContent = 'Nenhuma movimenta√ß√£o encontrada para este SKU.';
    tr.appendChild(td);
    corpo.appendChild(tr);
    return;
  }

  vendasFiltradas.forEach(v => {
    const tr = document.createElement('tr');
    const data = v.data || formatarDataIso(new Date());
    const hora = v.hora || (new Date(v.timestamp || Date.now()).toLocaleTimeString('pt-BR'));
    tr.insertCell().textContent = data;
    tr.insertCell().textContent = hora;
    tr.insertCell().textContent = v.sku || '-';
    tr.insertCell().textContent = v.descricao || '-';
    tr.insertCell().textContent = v.quantidade || 0;
    tr.insertCell().textContent = v.clienteNome || (v.clienteCpf ? formatarCpfVisual(v.clienteCpf) : 'N√£o Identificado');
    tr.insertCell().textContent = formatarMoeda(v.valorTotal || 0);
    corpo.appendChild(tr);
  });
}

/**
 * Hooks: chamar gerarKardexParaSku() toda vez que a consulta for feita.
 * Se voc√™ j√° tem uma fun√ß√£o consultarProdutoPorSku(), s√≥ garanta que ela invoque
 * gerarKardexParaSku(skuEncontrado) com o SKU pesquisado.
 *
 * Exemplo simples: (adapte caso sua fun√ß√£o consultarProdutoPorSku j√° exista)
 */
function consultarProdutoPorSku_e_Kardex() {
  const input = document.getElementById('skuConsulta');
  if (!input) return;
  const termo = input.value.trim();
  // Chama a sua fun√ß√£o existente que preenche consulta (se existir)
  if (typeof consultarProdutoPorSku === 'function') {
      try { consultarProdutoPorSku(); } catch(e) { console.warn('Erro ao chamar consultarProdutoPorSku():', e); }
  }
  // Gera o kardex com base no que o usu√°rio digitou
  gerarKardexParaSku(termo);
}

// Substitui o evento oninput do input#skuConsulta para tamb√©m atualizar o kardex
(function ligarKardexAoInput() {
  const input = document.getElementById('skuConsulta');
  if (!input) return;
  // Se j√° estava usando oninput inline, sobrescreve para garantir comportamento
  input.removeEventListener('input', consultarProdutoPorSku_e_Kardex);
  input.addEventListener('input', consultarProdutoPorSku_e_Kardex);
})();

function filtrarClientes() {
    const input = document.getElementById('inputPesquisaClientes');
    if (!input) return;

    const filtro = input.value.toUpperCase().trim();
    const tabela = document.getElementById('corpoTabelaClientes');
    if (!tabela) return;

    const linhas = tabela.getElementsByTagName('tr');

    // Colunas que queremos buscar: 0 = Nome, 1 = CPF
    const indicesBusca = [0, 1];

    for (let i = 0; i < linhas.length; i++) {
        let linhaVisivel = false;
        const celulas = linhas[i].getElementsByTagName('td');

        if (celulas.length > 0) {
            if (filtro === "") {
                linhaVisivel = true;
            } else {
                for (let j = 0; j < indicesBusca.length; j++) {
                    const indice = indicesBusca[j];
                    const celula = celulas[indice];
                    if (celula) {
                        const textoCelula = celula.textContent || celula.innerText;
                        if (textoCelula.toUpperCase().indexOf(filtro) > -1) {
                            linhaVisivel = true;
                            break;
                        }
                    }
                }
            }
            linhas[i].style.display = linhaVisivel ? "" : "none";
        }
    }
}

// =========================================================================
// === AUDITORIA DE ESTOQUE (NOVO) - COMPARANDO APENAS PELO SKU BASE (01001) ===
// === L√≥gica ajustada para SOMAR m√∫ltiplas ocorr√™ncias do mesmo SKU no arquivo TXT.
// =========================================================================

// Vari√°vel global para armazenar os ajustes a serem feitos (somente os itens com diferen√ßa)
let ajustesAuditoria = {};

/**
 * Auxiliar: Encontra todos os produtos que s√£o varia√ß√µes do SKU base
 * e calcula o estoque total no sistema.
 * @param {string} baseSku - O SKU base (ex: "01001").
 * @param {Array<Object>} produtosSistema - O array de produtos do sistema.
 * @returns {{totalEstoque: number, variantes: Array<Object>}}
 */
const getEstoqueTotalByBaseSku = (baseSku, produtosSistema) => {
    const skuPrefix = `${baseSku}-`; 
    let totalEstoque = 0;
    const variantes = [];

    const produtosEncontrados = produtosSistema.filter(p => {
        const produtoSkuUpper = p.sku.toUpperCase();
        const baseSkuUpper = baseSku.toUpperCase();
        
        // Verifica se √© o SKU base exato (sem varia√ß√µes) OU se come√ßa com o prefixo da varia√ß√£o
        return produtoSkuUpper === baseSkuUpper || produtoSkuUpper.startsWith(skuPrefix.toUpperCase());
    });
    
    // Filtra e soma o estoque
    produtosEncontrados.forEach(p => {
        const currentBaseSku = p.sku.split('-')[0].toUpperCase();
        
        if (currentBaseSku === baseSku.toUpperCase()) {
            totalEstoque += p.estoque;
            // Armazena todas as variantes para o ajuste
            variantes.push(p);
        }
    });

    return { totalEstoque, variantes };
};


/**
 * Inicia o processo de leitura do arquivo TXT e confronto de estoque.
 */
const iniciarConfronto = (event) => {
    const file = event.target.files[0];
    if (!file) {
        document.getElementById('auditoriaMensagem').textContent = 'Selecione um arquivo.';
        document.getElementById('btnFecharCritica').style.display = 'none';
        return;
    }

    if (file.type !== 'text/plain') {
        alert('Por favor, selecione um arquivo de texto (.txt).');
        document.getElementById('arquivoAuditoria').value = '';
        document.getElementById('auditoriaMensagem').textContent = 'Tipo de arquivo inv√°lido. Por favor, selecione um arquivo .txt.';
        document.getElementById('btnFecharCritica').style.display = 'none';
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => confrontarEstoque(e.target.result);
    reader.readAsText(file);
    document.getElementById('auditoriaMensagem').textContent = 'Lendo e confrontando dados...';
    document.getElementById('listaCriticas').innerHTML = '';
    ajustesAuditoria = {}; // Limpa ajustes anteriores
    document.getElementById('btnFecharCritica').style.display = 'none';
};

/**
 * Compara o conte√∫do do arquivo TXT com o estoque atual do sistema.
 * Agora agrega a contagem do arquivo TXT por SKU Base.
 * @param {string} fileContent - O conte√∫do do arquivo TXT.
 */
const confrontarEstoque = (fileContent) => {
    const linhas = fileContent.trim().split('\n');
    const listaCriticas = document.getElementById('listaCriticas');
    listaCriticas.innerHTML = '';
    
    const contagemArquivo = {};
    const linhasInvalidas = [];

    // --- FASE 1: LER E AGREGAR O ARQUIVO TXT ---
    linhas.forEach((linha, index) => {
        // Limpa espa√ßos em branco e divide por v√≠rgula
        const [skuRaw, quantidadeRaw] = linha.trim().split(',').map(s => s.trim());
        
        if (!skuRaw || !quantidadeRaw) return;

        // Pega o SKU Base (ex: 01001) mesmo que o arquivo venha com varia√ß√£o (ex: 01001-P-MASC)
        const baseSku = skuRaw.split('-')[0].toUpperCase(); 
        const quantidade = parseInt(quantidadeRaw);

        if (isNaN(quantidade) || quantidade < 0) {
            linhasInvalidas.push(`‚ö†Ô∏è Linha ${index + 1} - SKU: <b>${baseSku}</b>. Quantidade contada inv√°lida (<b>${quantidadeRaw}</b>). Item ignorado.`);
            return;
        }

        // Soma a quantidade ao total do SKU Base
        contagemArquivo[baseSku] = (contagemArquivo[baseSku] || 0) + quantidade;
    });

    // Exibe as linhas com erro de formato
    linhasInvalidas.forEach(msg => {
        const li = document.createElement('li');
        li.style.color = '#dc3545';
        li.innerHTML = msg;
        listaCriticas.appendChild(li);
    });

    // --- FASE 2: CONFRONTAR O TOTAL AGREGADO COM O ESTOQUE DO SISTEMA ---
    const produtosSistema = getDados(STORAGE_PRODUTOS);
    const skusAuditados = new Set();
    let totalCriticas = 0;
    ajustesAuditoria = {}; 

    for (const baseSku in contagemArquivo) {
        const quantidadeContada = contagemArquivo[baseSku];

        // 1. Obt√©m o estoque TOTAL para o SKU base e suas varia√ß√µes
        const { totalEstoque: estoqueSistema, variantes } = getEstoqueTotalByBaseSku(baseSku, produtosSistema);

        if (variantes.length === 0) {
            const li = document.createElement('li');
            li.style.color = '#ffc107'; // Amarelo/Laranja
            li.innerHTML = `‚ö†Ô∏è SKU Base: <b>${baseSku}</b> - Produto n√£o encontrado no cadastro do sistema. Item ignorado.`;
            listaCriticas.appendChild(li);
            // Pula para o pr√≥ximo SKU no loop
            continue; 
        }

        if (estoqueSistema !== quantidadeContada) {
            totalCriticas++;
            const diferenca = quantidadeContada - estoqueSistema;
            const cor = diferenca > 0 ? '#28aa45' : '#dc3545'; // Verde se sobrou, Vermelho se faltou
            const sinal = diferenca > 0 ? '+' : '';
            
            const modeloProduto = variantes[0].modelo || 'Produto Variado';

            const li = document.createElement('li');
            li.style.color = cor;
            li.style.padding = "6px";
li.style.borderBottom = "1px solid #ddd";
li.innerHTML = `
    <div style="
        background: #fff; 
        border: 1px solid #ccc; 
        border-radius: 6px; 
        margin-bottom: 8px; 
        padding: 6px; 
        color: black;
    ">
        <table style="width:100%; font-size: 0.9em; border-collapse: collapse;">
            <tr>
                <td><b>SKU</b>: ${baseSku}</td>
                <td><b>G√™nero</b>: ${variantes[0]?.genero || '-'}</td>
                <td><b>Marca</b>: ${variantes[0]?.marca || '-'}</td>
            </tr>
            <tr>
                <td><b>Modelo</b>: ${modeloProduto}</td>
                <td><b>Tamanho</b>: ${variantes[0]?.tamanho || '-'}</td>
                <td><b>Pre√ßo</b>: R$ ${(variantes[0]?.venda || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td><b>Estoque Sistema</b>: ${estoqueSistema}</td>
                <td><b>Auditado</b>: ${quantidadeContada ?? 0}</td>
                <td><b>Diferen√ßa</b>: <span style="color:red; font-weight:bold;">${diferenca ?? -estoqueSistema}</span></td>
            </tr>
        </table>
    </div>
`;


            listaCriticas.appendChild(li);
            
            // Armazena o ajuste
            ajustesAuditoria[baseSku] = { novaQuantidade: quantidadeContada, variantes: variantes.map(v => v.sku) };
        }
        
        skusAuditados.add(baseSku);
    }

   // --- FASE 3: Encontrar itens com estoque no sistema que N√ÉO estavam no arquivo ---
produtosSistema.forEach(produto => {
    const baseSku = produto.sku.split('-')[0].toUpperCase();
    
    // Verifica se o SKU Base ainda n√£o foi auditado E n√£o estava no arquivo de contagem
    if (!skusAuditados.has(baseSku) && !contagemArquivo.hasOwnProperty(baseSku)) { 
        const { totalEstoque: estoqueSistema, variantes } = getEstoqueTotalByBaseSku(baseSku, produtosSistema);
        
        // Se houver estoque no sistema (e n√£o estiver no arquivo)
        if(estoqueSistema !== 0) { 
            totalCriticas++; // Garante que conte no total de faltas


            const modeloProduto = variantes[0]?.modelo || 'Produto Sem Modelo';
            
            const li = document.createElement('li');
            li.style.color = '#dc3545'; // Cor de Alerta Vermelho

          // CORRE√á√ÉO CR√çTICA: Armazena a instru√ß√£o de ajuste para 0
                    ajustesAuditoria[baseSku] = {
                        novaQuantidade: 0, 
                        variantes: variantes.map(v => v.sku) 
                    };
            
            // -----------------------------------------------------------------
            // --- LAYOUT PADRONIZADO (INCLUINDO O √çCONE DE ALERTA <i class="fas fa-exclamation-triangle"></i>) ---
            li.innerHTML = `
    <div style="
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-bottom: 8px;
        padding: 6px;
        color: black;
    ">
        <table style="width:100%; font-size: 0.9em; border-collapse: collapse;">
            <tr>
                <td style="width: 33%;"><b>SKU</b>: ${baseSku}</td>
                <td style="width: 33%;"><b>G√™nero</b>: ${variantes[0]?.genero || '-'}</td>
                <td style="width: 33%;"><b>Marca</b>: ${variantes[0]?.marca || '-'}</td>
            </tr>
            <tr>
                <td><b>Modelo</b>: ${modeloProduto}</td>
                <td><b>Tamanho</b>: ${variantes[0]?.tamanho || '-'}</td>
                <td><b>Pre√ßo</b>: R$ ${(variantes[0]?.venda || 0).toFixed(2)}</td>
            </tr>
            <tr>
                <td><b>Estoque Sistema</b>: ${estoqueSistema}</td>
                <td><b>Auditado</b>: 0</td>
                <td><b>Diferen√ßa</b>: <span style="color:red; font-weight:bold;">-${estoqueSistema}</span></td>
            </tr>
        </table>
    </div>
`;


            // -----------------------------------------------------------------

            listaCriticas.appendChild(li);

            // Armazena o ajuste: O estoque total deve ser zerado, pois n√£o foi encontrado.
            ajustesAuditoria[baseSku] = { 
                novaQuantidade: 0, 
                variantes: variantes.map(v => v.sku) 
            };
            
            // Adiciona o SKU Base ao conjunto para evitar duplicidade na cr√≠tica
            skusAuditados.add(baseSku);
        }
    }
});

    // --- FASE 4: MENSAGEM FINAL ---
    if (totalCriticas > 0 || linhasInvalidas.length > 0) {
        document.getElementById('auditoriaMensagem').innerHTML = `
            Confronto conclu√≠do. <b>${totalCriticas}</b> diferen√ßas encontradas (Cr√≠ticas). 
            Revise a lista e clique em "Fechar Cr√≠tica" para aplicar os ajustes.
        `;
        document.getElementById('btnFecharCritica').style.display = 'inline-block';
    } else {
        document.getElementById('auditoriaMensagem').innerHTML = `
            ‚úÖ Confronto conclu√≠do. <b>Nenhuma</b> diferen√ßa encontrada. Estoque e arquivo est√£o sincronizados.
        `;
        document.getElementById('btnFecharCritica').style.display = 'none';
    }
    
    document.getElementById('resultadoAuditoria').scrollIntoView({ behavior: 'smooth' });
};

/**
 * Aplica os ajustes de estoque encontrados no confronto, concentrando o novo estoque.
 */
const fecharCritica = () => {
    if (Object.keys(ajustesAuditoria).length === 0) {
        alert('N√£o h√° cr√≠ticas para fechar e ajustar. Por favor, importe o arquivo primeiro.');
        return;
    }

    if (!confirm(`ATEN√á√ÉO: A aplica√ß√£o dos ajustes concentrar√° o estoque total do SKU auditado na sua PRIMEIRA VARIA√á√ÉO encontrada no sistema. 
Confirma o FECHAMENTO DA CR√çTICA e o ajuste de ${Object.keys(ajustesAuditoria).length} SKUs no sistema para o total do arquivo?`)) {
        return;
    }

    let produtos = getDados(STORAGE_PRODUTOS);
    let ajustesAplicados = 0;
    
    // Itera sobre os ajustes de SKU BASE e aplica a nova quantidade TOTAL
    for (const baseSkuAjuste in ajustesAuditoria) {
        const { novaQuantidade, variantes } = ajustesAuditoria[baseSkuAjuste];
        
        let ajustadaPrimeiraVariante = false;

        // Estrat√©gia: Zera todas as variantes E aplica o total na PRIMEIRA variante.
        for (let i = 0; i < variantes.length; i++) {
            const skuCompleto = variantes[i];
            const produtoIndex = produtos.findIndex(p => p.sku === skuCompleto);
            
            if (produtoIndex !== -1) {
                let quantidadeParaAplicar = 0;

                if (i === 0) {
                    // A primeira varia√ß√£o recebe o estoque total do arquivo
                    quantidadeParaAplicar = novaQuantidade; 
                    ajustadaPrimeiraVariante = true;
                } else {
                    // As outras varia√ß√µes do mesmo SKU base s√£o zeradas
                    quantidadeParaAplicar = 0;
                }
                
                // Aplica o ajuste se houver diferen√ßa
                if (produtos[produtoIndex].estoque !== quantidadeParaAplicar) {
                    produtos[produtoIndex].estoque = quantidadeParaAplicar;
                    ajustesAplicados++;
                }
            }
        }
    }

    // Salva os dados atualizados
    salvarDados(STORAGE_PRODUTOS, produtos);
    
    // Limpa a tela de auditoria
    ajustesAuditoria = {};
    document.getElementById('listaCriticas').innerHTML = '';
    document.getElementById('btnFecharCritica').style.display = 'none';
    document.getElementById('arquivoAuditoria').value = '';

    // Atualiza a exibi√ß√£o do estoque
    if (document.getElementById('secao-estoque').style.display === 'block') {
        renderizarTabelaEstoque();
    }
    
    alert(`‚úÖ Fechamento de Cr√≠tica conclu√≠do! ${Object.keys(ajustesAuditoria).length} SKUs Base ajustados.`);
    document.getElementById('auditoriaMensagem').innerHTML = `Ajuste conclu√≠do. ${Object.keys(ajustesAuditoria).length} SKUs Base tiveram seu estoque total atualizado para corresponder √† contagem f√≠sica do arquivo.`;
};

    /**
 * Imprime o relat√≥rio de diverg√™ncias da auditoria
 */
function imprimirAuditoria() {
  const lista = document.getElementById('listaCriticas');
  if (!lista || lista.children.length === 0) {
    alert('Nenhuma diverg√™ncia para imprimir.');
    return;
  }

  let conteudo = `
    <div class="print-report-body">
      <h3>Relat√≥rio de Diverg√™ncias de Auditoria</h3>
      <table>
        <thead>
          <tr>
            <th>SKU</th>
            <th>Marca</th>
            <th>Descri√ß√£o</th>
            <th>Tamanho</th>
            <th>Custo (R$)</th>
            <th>Venda (R$)</th>
            <th>Diferen√ßa</th>
          </tr>
        </thead>
        <tbody>
  `;

  const produtosSistema = getDados(STORAGE_PRODUTOS);

  // Totais
  let totalDiferencaQtd = 0;
  let totalCusto = 0;
  let totalVenda = 0;

  lista.querySelectorAll('li').forEach(li => {
    const skuMatch = li.innerHTML.match(/SKU<\/b>: ([A-Z0-9-]+)/i);
    const sku = skuMatch ? skuMatch[1] : '';

    const produto = produtosSistema.find(p => p.sku.toUpperCase().startsWith(sku.toUpperCase()));
    const marca = produto?.marca || '-';
    const descricao = produto?.modelo || '-';
    const tamanho = produto?.tamanho || '-';
    const custo = produto?.custo || 0;
    const venda = produto?.venda || 0;

    const diffMatch = li.innerHTML.match(/Diferen√ßa<\/b>.*?>([-+0-9]+)/i);
    const diferenca = diffMatch ? parseInt(diffMatch[1]) : 0;

    conteudo += `
      <tr>
        <td>${sku}</td>
        <td>${marca}</td>
        <td>${descricao}</td>
        <td>${tamanho}</td>
        <td>${custo.toFixed(2)}</td>
        <td>${venda.toFixed(2)}</td>
        <td>${diferenca}</td>
      </tr>
    `;

    // S√≥ considera faltas (diferen√ßa negativa)
    if (diferenca < 0) {
      totalDiferencaQtd += Math.abs(diferenca);
      totalCusto += Math.abs(diferenca) * custo;
      totalVenda += Math.abs(diferenca) * venda;
    }
  });

  conteudo += `
        </tbody>
      </table>
      <br>
      <h4>Totais de Faltas</h4>
      <table>
        <tr>
          <th>Total de Produtos em Falta</th>
          <th>Total em Custo (R$)</th>
          <th>Total em Venda (R$)</th>
        </tr>
        <tr>
          <td>${totalDiferencaQtd}</td>
          <td>${totalCusto.toFixed(2)}</td>
          <td>${totalVenda.toFixed(2)}</td>
        </tr>
      </table>
    </div>
  `;

  const janela = window.open('', '', 'width=800,height=600');
  janela.document.write(`
    <html><head><title>Impress√£o Auditoria</title>
    <style>
      ${document.querySelector('style').innerHTML}
    </style>
    </head><body>${conteudo}</body></html>
  `);
  janela.document.close();
  janela.print();
}


// =========================================================================
// NOVO: Fun√ß√£o para filtrar a tabela de Estoque em tempo real (LIVE SEARCH)
// =========================================================================
function filtrarEstoque() {
    // 1. Pega o valor digitado e limpa espa√ßos
    const input = document.getElementById('inputPesquisaEstoque');
    if (!input) return;
    
    const filtro = input.value.toUpperCase().trim();
    const tabela = document.getElementById('corpoTabelaEstoque');
    const linhas = tabela.getElementsByTagName('tr');

    // Colunas de busca relevantes na tabela do Estoque (√≠ndices baseados em 0)
    // 0: SKU Sistema, 1: SKU Fabricante, 2: Marca, 3: G√™nero, 4: Modelo/Descri√ß√£o, 5: Cor, 6: Tamanho
    const indicesBusca = [0, 1, 2, 3, 4, 5, 6];

    // Itera por todas as linhas de dados (tr)
    for (let i = 0; i < linhas.length; i++) {
        let linhaVisivel = false;
        const celulas = linhas[i].getElementsByTagName('td');
        
        // Verifica se a linha tem c√©lulas de dados
        if (celulas.length > 0) {
            
            // Se o filtro estiver vazio, mostra a linha (caso comum)
            if (filtro === "") {
                linhaVisivel = true;
            } else {
                // Itera pelas colunas relevantes para a busca
                for (let j = 0; j < indicesBusca.length; j++) {
                    const indice = indicesBusca[j];
                    const celula = celulas[indice];
                    
                    if (celula) {
                        const textoCelula = celula.textContent || celula.innerText;
                        if (textoCelula.toUpperCase().indexOf(filtro) > -1) {
                            linhaVisivel = true; // Encontrado!
                            break; // N√£o precisa checar mais c√©lulas nesta linha
                        }
                    }
                }
            }

            // Aplica o filtro (mostra a linha, ou a esconde)
            linhas[i].style.display = linhaVisivel ? "" : "none";
        }
    }
}
// =========================================================================

       // === HIST√ìRICO AUTOM√ÅTICO DOS CAMPOS ===
const CAMPOS_HISTORICO = ['marca', 'modelo', 'cor', 'tamanho'];


// Atualiza o datalist conforme os valores salvos
function atualizarDatalist(campo) {
const lista = document.getElementById('lista' + campo.charAt(0).toUpperCase() + campo.slice(1));
lista.innerHTML = '';
const valores = JSON.parse(localStorage.getItem('historico_' + campo) || '[]');
valores.forEach(valor => {
const option = document.createElement('option');
option.value = valor;
lista.appendChild(option);
});
}

// Carrega os hist√≥ricos ao abrir o sistema
window.addEventListener('load', () => {
CAMPOS_HISTORICO.forEach(campo => atualizarDatalist(campo));
});


// Salva novos valores automaticamente
CAMPOS_HISTORICO.forEach(campo => {
const input = document.getElementById(campo);
input.addEventListener('change', () => {
let valores = JSON.parse(localStorage.getItem('historico_' + campo) || '[]');
const valor = input.value.trim();
if (valor && !valores.includes(valor)) {
valores.push(valor);
localStorage.setItem('historico_' + campo, JSON.stringify(valores));
atualizarDatalist(campo);
}
});
});
        // --- CONSTANTES E ARMAZENAMENTO ---
        const STORAGE_PRODUTOS = 'produtos';
        const STORAGE_CONSIGNACOES = 'consignacoes';
        const STORAGE_TROCAS = 'trocas'; // ‚¨ÖÔ∏è NOVA LINHA ADICIONADA
        let clienteConsignacaoAtual = null;
        let pacoteConsignacao = [];
        let clienteTrocaAtual = null; // ‚¨ÖÔ∏è NOVA LINHA ADICIONADA
        let produtosDevolvidos = []; // ‚¨ÖÔ∏è NOVA LINHA ADICIONADA
        let produtosNovos = []; // ‚¨ÖÔ∏è NOVA LINHA ADICIONADA

        // ‚úÖ ADICIONE ESTA LINHA AQUI:
        let consignacaoEmVisualizacao = null;  // ‚Üê NOVA LINHA
        let trocaAtualParaReimprimir = null; // ‚Üê ADICIONE ESTA LINHA

        const STORAGE_CARRINHO = 'carrinho';
        const STORAGE_CLIENTES = 'clientes';
        const STORAGE_CAIXA = 'vendasCaixa';
        const TAXA_CREDITO = 0.06; // 6%
        let clienteVendaAtual = null; // Armazena o objeto do cliente atualmente selecionado na tela de venda
        let totalCarrinhoBase = 0; // Armazena o total do carrinho SEM taxa

        // Vari√°vel global para rastrear o √∫ltimo SKU sequencial.
        let ultimoSkuSequencial = 1000; 

        // Fun√ß√£o que ser√° usada para gerar o SKU Prim√°rio (do Sistema)
        const gerarProximoSkuAutomatico = () => {
            // 1. Pega todos os produtos para encontrar o maior SKU atual
            const produtos = getDados(STORAGE_PRODUTOS);
            let maxSku = 1000; 
            
            // Procura o maior SKU num√©rico existente (assumindo que SKUs autom√°ticos s√£o num√©ricos)
            produtos.forEach(produto => {
                // Tenta converter o SKU para n√∫mero, usa 0 se falhar
                const skuNum = parseInt(produto.sku);
                if (!isNaN(skuNum) && skuNum > maxSku) {
                    maxSku = skuNum;
                }
            });

            // Garante que o pr√≥ximo SKU ser√° maior que o m√°ximo encontrado
            ultimoSkuSequencial = maxSku + 1;
            
            // Retorna como string, com padding para ter 5 d√≠gitos (ex: 01001)
            return String(ultimoSkuSequencial).padStart(5, '0'); 
        };

        // --- FUN√á√ïES DE MASCARAMENTO E FORMATO ---
        const formatarMoeda = (valor) => {
            return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };
        const formatarCpfVisual = (cpfLimpo) => {
            // Garante que o CPF tem 11 d√≠gitos para formatar
            if (cpfLimpo.length !== 11) {
                return cpfLimpo;
            }
            return cpfLimpo.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
        };
        const limparCpf = (cpf) => {
            // Remove tudo que n√£o for d√≠gito
            const cpfLimpo = cpf.replace(/\D/g, '');
            // Limita a 11 d√≠gitos
            return cpfLimpo.substring(0, 11);
        };
        // Fun√ß√£o aplicada no oninput para for√ßar a m√°scara
        const aplicarMascaraCpf = (input) => {
            let value = input.value.replace(/\D/g, ''); // Remove tudo que n√£o for d√≠gito
            // Limita a 11 d√≠gitos
            if (value.length > 11) {
                value = value.substring(0, 11);
            }
            // Aplica a formata√ß√£o visual (se houver d√≠gitos suficientes)
            if (value.length > 9) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})$/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/^(\d{3})(\d{3})$/, '$1.$2');
            }
            input.value = value;
        };
        // Fun√ß√£o para formatar o timestamp para Data e Hora (segura para navegadores)
        const formatarDataHoraSegura = (timestamp) => {
            const data = new Date(timestamp);
            const dataFormatada = formatarDataIso(data).split('-').reverse().join('/'); // DD/MM/YYYY
            const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            return `${dataFormatada} ${horaFormatada}`;
        };
        const formatarDataIso = (data) => {
            const ano = data.getFullYear();
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const dia = String(data.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        };
        const formatarMesIso = (data) => {
            const ano = data.getFullYear();
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            return `${ano}-${mes}`;
        };

        // --- FUN√á√ïES DE UTILIDADE GERAL ---
        // Fun√ß√£o gen√©rica para obter dados do localStorage
        const getDados = (chave) => {
            const dados = localStorage.getItem(chave);
            return dados ? JSON.parse(dados) : [];
        };
        // Fun√ß√£o gen√©rica para salvar dados no localStorage
        const salvarDados = (chave, dados) => {
            localStorage.setItem(chave, JSON.stringify(dados));
        };
        // NOVA FUN√á√ÉO: Abre o modal de cadastro de novo cliente a partir da venda
        const abrirModalCadastroNovoCliente = () => {
            // 1. Pega o CPF digitado na se√ß√£o de Venda (antes de fechar o modal)
            const cpfDoInputVenda = document.getElementById('cpfCliente').value;
            fecharModal('modalVendaSemCadastro');
            // 2. Preenche o campo do modal com o CPF e limpa os outros
            document.getElementById('vendaCpf').value = cpfDoInputVenda;
            document.getElementById('vendaNomeCliente').value = '';
            document.getElementById('vendaTelefone').value = '';
            // 3. Abre o modal de cadastro r√°pido
            abrirModal('modalCadastroClienteVenda');
        };

        // --- FUN√á√ïES DE GERA√á√ÉO DE RECIBO (NOVO) ---
        const gerarReciboHTML = (carrinho, totalFinal, nomeCliente, metodoPagamento) => {
            const dataVenda = formatarDataHoraSegura(new Date().getTime());
            let itensHTML = '';
            let totalBase = 0;
            carrinho.forEach(item => {
                const valorTotalItem = item.valorUnitario * item.quantidade;
                totalBase += item.valorUnitario * item.quantidade;
                // Limita a descri√ß√£o para caber no recibo t√©rmico
                const descricaoCurta = item.descricao.length > 25 ? item.descricao.substring(0, 22) + '...' : item.descricao;
                itensHTML += `
                <div style="display: flex; justify-content: space-between; font-size: 9pt; margin-bottom: 2px; ${
        item.descricao.toUpperCase().includes('B√îNUS (DESCONTO') 
            ? 'color: green; font-weight: bold;' 
            : ''
    }">
        <span>${item.quantidade}x ${item.sku}  ${item.descricao.replace(item.sku, '').trim()}</span>
        <span>${formatarMoeda(valorTotalItem)}</span>
    </div>`;
            });

            const recibo = `
            <div class="recibo-print-body" style="padding: 10px; margin: 0 auto; background-color: white;">
                <div class="recibo-header" style="text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000;">
                    <img src="image_df7b45.jpg" alt="Logo Anjos Kids" style="max-width: 80px; display: block; margin: 0 auto;">
                    <h4 style="margin: 5px 0 0 0; font-size: 11pt;">ANJOS KID'S</h4>
                    <p style="margin: 0 0 10px 0; font-size: 8pt;">O seu filho merece o melhor!</p>
                </div>
                
                <p style="font-size: 8pt; text-align: center; border-bottom: 1px dashed #000; padding-bottom: 5px;">
                    Comprovante de Venda N¬∞ ${new Date().getTime().toString().slice(-6)}
                </p>

                <div class="recibo-detalhes" style="margin-top: 5px; border-bottom: 1px dashed #000; padding-bottom: 10px;">
                    <p style="margin: 2px 0; font-size: 8pt;">Data: ${dataVenda}</p>
                    <p style="margin: 2px 0; font-size: 8pt;">Cliente: ${nomeCliente}</p>
                </div>

                <div class="recibo-itens" style="margin-top: 10px;">
                    <h5 style="margin: 0 0 5px 0; font-size: 10pt; text-align: center;">ITENS</h5>
                    ${itensHTML}
                </div>

                <div class="recibo-totais" style="margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px;">
                    <div style="display: flex; justify-content: space-between; font-size: 10pt;">
                        <span>SUBTOTAL:</span>
                        <span>${formatarMoeda(totalBase)}</span>
                    </div>
                    ${totalBase !== totalFinal ? 
    `<div style="display: flex; justify-content: space-between; font-size: 9pt; color: #dc3545;">
        <span>${metodoPagamento === 'CARTAO_CREDITO' ? 'OUTRAS TAXAS:' : 'TAXA DE ENTREGA:'}</span>
        <span>${formatarMoeda(totalFinal - totalBase)}</span>
    </div>` : ''}

                    <div style="display: flex; justify-content: space-between; font-size: 11pt; font-weight: bold; color: #3a7bd5; margin-top: 5px;">
                        <span>TOTAL:</span>
                        <span>${formatarMoeda(totalFinal)}</span>
                    </div>
                </div>
                
                <div class="recibo-pagamento" style="margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; text-align: center;">
                    <p style="margin: 2px 0; font-size: 9pt;">Chave Pix: CPF: 355.489.048-09 (Rosangela Camiloti) ${metodoPagamento}</p>
                    <p style="margin: 5px 0 0 0; font-size: 8pt;">Obrigado pela prefer√™ncia!</p>
                </div>
            </div>
            `;
            return recibo;
        };

        const imprimirRecibo = (carrinho, totalFinal, nomeCliente, metodoPagamento) => {
            const reciboHTML = gerarReciboHTML(carrinho, totalFinal, nomeCliente, metodoPagamento);
            const printWindow = window.open('', '', 'height=400,width=300');
            printWindow.document.write('<html><head><title>Recibo</title>');
            // Copia o estilo do CSS para impress√£o
            const style = document.querySelector('style').textContent;
            printWindow.document.write('<style>' + style + '</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(reciboHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        };

        // Fun√ß√£o de reimpress√£o de recibo (adicionada/corrigida)
const reimprimirReciboPorId = (transactionId) => {
    const vendas = getDados(STORAGE_CAIXA);
    const itensTransacao = vendas.filter(v => v.transactionId === transactionId);
    
    if (itensTransacao.length === 0) {
        alert('Transa√ß√£o n√£o encontrada para reimpress√£o.');
        return;
    }
    
    // ‚úÖ DETECTA SE √â UMA TROCA
    const ehTroca = itensTransacao.some(item => 
        item.tipoMovimento && item.tipoMovimento.startsWith('troca_')
    );
    
    if (ehTroca) {
        // ‚úÖ REIMPRIME TROCA (separa devolvidos e novos)
        const produtosDevolvidos = [];
        const produtosNovos = [];
        let diferenca = 0;
        
        itensTransacao.forEach(item => {
            if (item.tipoMovimento === 'troca_devolucao') {
                produtosDevolvidos.push({
                    sku: item.sku,
                    descricao: item.descricao.replace('üîÑ TROCA - DEVOLU√á√ÉO: ', ''),
                    quantidade: Math.abs(item.quantidade),
                    valorUnitario: item.valorUnitario,
                    valorTotal: Math.abs(item.valorTotal)
                });
            } else if (item.tipoMovimento === 'troca_novo') {
                produtosNovos.push({
                    sku: item.sku,
                    descricao: item.descricao.replace('üîÑ TROCA - NOVO PRODUTO: ', ''),
                    quantidade: item.quantidade,
                    valorUnitario: item.valorUnitario,
                    valorTotal: item.valorTotal
                });
            } else if (item.tipoMovimento === 'troca_diferenca') {
                diferenca = item.valorTotal;
            }
        });
        
        const clienteNome = itensTransacao[0].clienteNome || 'N√£o Identificado';
        imprimirReciboTroca(produtosDevolvidos, produtosNovos, diferenca, clienteNome);
        
    } else {
        // ‚úÖ REIMPRIME VENDA NORMAL
        let totalFinal = 0;
        const itensParaImpressao = itensTransacao.map(item => {
            totalFinal += item.valorTotal;
            return {
                sku: item.sku,
                descricao: item.descricao,
                quantidade: item.quantidade,
                valorUnitario: item.valorUnitario
            };
        });
        
        const clienteNome = itensTransacao[0].clienteNome || 'N√£o Identificado';
        const pagamento = itensTransacao[0].pagamento || 'Pix';
        
        valorFreteAtual = 0;
        imprimirRecibo(itensParaImpressao, totalFinal, clienteNome, pagamento);
    }
};

// NOVA FUN√á√ÉO: Imprimir Hist√≥rico de Compras do Cliente
const imprimirHistoricoCliente = () => {
    const nomeCliente = document.getElementById('historicoClienteNome').textContent;
    const cpfCliente = document.getElementById('historicoClienteCpf').textContent;
    const totalGasto = document.getElementById('historicoTotalGasto').textContent;
    const tabelaHistorico = document.getElementById('corpoTabelaHistoricoVendas').innerHTML;

    const conteudo = `
        <div class="print-report-body">
            <h3>Hist√≥rico de Compras do Cliente</h3>
            <p><strong>Cliente:</strong> ${nomeCliente} (CPF: ${cpfCliente})</p>
            <p><strong>Total Gasto:</strong> ${totalGasto}</p>
            <hr>
            ${tabelaHistorico}
        </div>
    `;

    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>Imprimir Hist√≥rico</title>');
    const style = document.querySelector('style').textContent;
    printWindow.document.write('<style>' + style + '</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(conteudo);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
};

        
        // NOVO: Fun√ß√£o para imprimir a tabela de estoque (apenas produtos com estoque)
        const imprimirEstoque = () => {
            const produtos = getDados(STORAGE_PRODUTOS);
            
            // Filtra apenas produtos COM estoque (maior que zero)
            const produtosComEstoque = produtos.filter(p => p.estoque > 0);
            
            if (produtosComEstoque.length === 0) {
                alert('‚ùå Nenhum produto com estoque dispon√≠vel para imprimir.');
                return;
            }
            
            // Ordena por SKU
            produtosComEstoque.sort((a, b) => a.sku.localeCompare(b.sku));
            
            let tabelaHTML = `
                <div class="print-report-body">
                    <h3>Relat√≥rio de Estoque Atual - Anjos Kid's</h3>
                    <p>Data de Emiss√£o: ${formatarDataHoraSegura(new Date().getTime())}</p>
                    <p><strong>üì¶ Produtos com estoque dispon√≠vel:</strong> ${produtosComEstoque.length}</p>
                    <table>
                        <thead>
                            <tr>
                               <th>SKU Sistema</th>
                              <th>SKU Fabricante</th>                              
                             <th>G√™nero</th>
                             <th>Marca/Descri√ß√£o</th>
                             <th>Custo</th>                                                                           
                            <th>Venda</th>
                            <th>Estoque</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            produtosComEstoque.forEach(produto => {
                const descricaoCompleta = `${produto.marca} (${produto.modelo} - ${produto.cor}/${produto.tamanho})`;
                const estoqueClass = produto.estoque < 5 ? 'low-stock' : '';

                tabelaHTML += `
                    <tr>
                        <td>${produto.sku}</td>
                        <td>${produto.skuFabricante || 'N/A'}</td>
                        <td>${produto.genero || '---'}</td>
                        <td>${descricaoCompleta}</td>
                        <td>${formatarMoeda(produto.custo)}</td>
                        <td>${formatarMoeda(produto.venda)}</td>
                        <td class="${estoqueClass}">${produto.estoque}</td>
                    </tr>
                `;
            });

            tabelaHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Imprimir Estoque</title>');
            // Copia os estilos de impress√£o do CSS
            const style = document.querySelector('style').textContent;
            printWindow.document.write('<style>' + style + '</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(tabelaHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        };

            
        // --- FUN√á√ïES DE NAVEGA√á√ÉO ---
        const mostrarSecao = (id, botao) => {
            document.querySelectorAll('.secao').forEach(secao => {
                secao.style.display = 'none';
            });
            document.getElementById(id).style.display = 'block';

            document.querySelectorAll('.menu button').forEach(btn => {
                btn.classList.remove('ativo');
            });
            if (botao) {
                botao.classList.add('ativo');
            }

            // Atualiza tabelas relevantes
            if (id === 'secao-estoque') {
                renderizarTabelaEstoque();
                calcularResumoEstoque();
                calcularResumosCaixa();   // ‚Üê essa linha √© OBRIGAT√ìRIA aqui
            } else if (id === 'secao-caixa') {
    // Define o filtro como di√°rio automaticamente
    document.getElementById('filtroCaixa').value = 'diario';
    document.getElementById('divFiltroDiario').style.display = 'block';
    document.getElementById('filtroDataDiaria').value = formatarDataIso(new Date());
    
    aplicarFiltroDiario(); // Aplica o filtro do dia
    calcularResumosCaixa();
}
        };

        const abrirModal = (idModal) => {
            document.getElementById(idModal).style.display = 'block';
        };

        const fecharModal = (idModal) => {
    const modal = document.getElementById(idModal);
    if (modal) {
        // Remove classe especial se existir
        modal.classList.remove('modal-sobreposto');
        modal.style.display = 'none';
    }
};

        // --- FUN√á√ïES DE PRODUTO/ESTOQUE ---

        // Fun√ß√£o para buscar um produto pelo SKU (Sistema ou Fabricante)
        const buscarProdutoPorSku = (skuOuCodFabrica) => {
            const produtos = getDados(STORAGE_PRODUTOS);
            // Remove espa√ßos e converte para mai√∫sculas para busca n√£o sens√≠vel a mai√∫sculas
            const termoBusca = skuOuCodFabrica.trim().toUpperCase(); 
            
            // Procura o produto onde o SKU do sistema OU o SKU do fabricante corresponda ao termo de busca
            return produtos.find(produto => 
                produto.sku.trim().toUpperCase() === termoBusca || 
                (produto.skuFabricante && produto.skuFabricante.trim().toUpperCase() === termoBusca)
            );
        };

        const formCadastroProduto = document.getElementById('formCadastroProduto');
        formCadastroProduto.addEventListener('submit', (e) => {
            e.preventDefault();

// --- RECUPERA OS CAMPOS SALVOS (MARCA, MODELO, COR, TAMANHO) ---
const CAMPOS_PADRAO = ['marca', 'modelo', 'cor', 'tamanho'];
window.addEventListener('load', () => {
    CAMPOS_PADRAO.forEach(campo => {
        const valor = localStorage.getItem('padrao_' + campo);
        if (valor) document.getElementById(campo).value = valor;
    });
});

// --- SALVA AUTOMATICAMENTE O TEXTO DIGITADO EM CADA CAMPO ---
CAMPOS_PADRAO.forEach(campo => {
    const input = document.getElementById(campo);
    input.addEventListener('input', () => {
        localStorage.setItem('padrao_' + campo, input.value);
    });
});

            // 1. Define o SKU Prim√°rio (System-Generated)
            const skuAutoGerado = gerarProximoSkuAutomatico(); 
            
            // 2. Obt√©m o SKU do Fabricante (Manual), que agora √© opcional
            const skuManual = document.getElementById('skuProduto').value.trim(); // Reutilizando o ID do input

            // 3. Valida√ß√£o: Verifica se o SKU do Fabricante (se preenchido) j√° existe
            if (skuManual) {
                // A fun√ß√£o buscarProdutoPorSku j√° verifica nos dois campos (SKU Sistema e SKU Fabricante)
                const produtoExistente = buscarProdutoPorSku(skuManual);
                
                if (produtoExistente) {
                     alert(`Erro: O C√≥digo do Fabricante (SKU Manual) '${skuManual}' j√° est√° cadastrado como SKU do Sistema ou SKU do Fabricante de outro produto. Por favor, verifique.`);
                     return;
                }
            }

            // 4. Coleta os demais dados
            const marca = document.getElementById('marca').value;
            const modelo = document.getElementById('modelo').value;
            const genero = document.getElementById('genero').value;
            const cor = document.getElementById('cor').value;
            const tamanho = document.getElementById('tamanho').value;
            const custo = parseFloat(document.getElementById('custo').value);
            const venda = parseFloat(document.getElementById('venda').value);
            const quantidadeInicial = parseInt(document.getElementById('quantidadeInicial').value);

            const novoProduto = { genero,
                // SKU Prim√°rio (chave para Vendas/Estoque) √© sempre o gerado pelo sistema
                sku: skuAutoGerado, 
                // SKU Secund√°rio (do Fabricante)
                skuFabricante: skuManual, 
                marca,
                modelo,
                cor,
                tamanho,
                custo,
                venda,
                estoque: quantidadeInicial,
            };
            
            // 5. Salva, limpa e notifica
            const produtos = getDados(STORAGE_PRODUTOS);
            produtos.push(novoProduto);
            salvarDados(STORAGE_PRODUTOS, produtos);

            // Atualiza o display do SKU autom√°tico
            document.getElementById('skuAutoDisplay').value = 'Ser√° gerado automaticamente';
            
            // Limpa o formul√°rio e re-renderiza a tabela (se estiver vis√≠vel)
            formCadastroProduto.reset();
            renderizarTabelaEstoque(); 
            alert('Produto cadastrado com sucesso! SKU do Sistema (Prim√°rio): ' + skuAutoGerado + (skuManual ? ` | SKU do Fabricante: ${skuManual}` : ''));
        });


        
// ---------- Substituir / adicionar esta vers√É¬£o de calcularResumoEstoque ----------
function calcularResumoEstoque() {
    const produtos = getDados(STORAGE_PRODUTOS);
    let totalQtd = 0, totalCusto = 0, totalVenda = 0;
    produtos.forEach(p => {
        totalQtd += p.estoque;
        totalCusto += p.estoque * p.custo;
        totalVenda += p.estoque * p.venda;
    });

    // Calcula o lucro e percentual
    const lucroEstoque = totalVenda - totalCusto;
    const percentualLucroEstoque = totalCusto > 0 ? ((lucroEstoque / totalCusto) * 100).toFixed(1) : 0;

    const elQtd = document.getElementById('resumoQtdEstoque');
    const elCusto = document.getElementById('resumoCustoEstoque');
    const elVenda = document.getElementById('resumoVendaEstoque');
    const elLucroVenda = document.getElementById('resumoLucroVendaEstoque'); // NOVO elemento
    
    if (!elQtd || !elCusto || !elVenda) return;

    elQtd.dataset.value = totalQtd;
    elCusto.dataset.value = totalCusto;
    elVenda.dataset.value = totalVenda;
    if (elLucroVenda) {
        elLucroVenda.dataset.lucro = lucroEstoque;
        elLucroVenda.dataset.percentual = percentualLucroEstoque;
    }

    const mascarado = localStorage.getItem('estoque_valores_mascarados') === 'true';

    if (mascarado) {
        elQtd.textContent = '‚Ä¢‚Ä¢‚Ä¢';
        elCusto.textContent = '‚Ä¢‚Ä¢‚Ä¢';
        elVenda.textContent = '‚Ä¢‚Ä¢‚Ä¢';
        if (elLucroVenda) elLucroVenda.textContent = '‚Ä¢‚Ä¢‚Ä¢';
    } else {
        elQtd.textContent = totalQtd;
        elCusto.textContent = formatarMoeda(totalCusto);
        elVenda.textContent = formatarMoeda(totalVenda);
        if (elLucroVenda) {
            elLucroVenda.textContent = `Lucro: ${formatarMoeda(lucroEstoque)} (${percentualLucroEstoque}%)`;
        }
    }
}

// ---------- Fun√ß√£o para alternar mostrar/ocultar valores ----------
function atualizarExibicaoValores() {
    const elQtd = document.getElementById('resumoQtdEstoque');
    const elCusto = document.getElementById('resumoCustoEstoque');
    const elVenda = document.getElementById('resumoVendaEstoque');
    const elLucroVenda = document.getElementById('resumoLucroVendaEstoque'); // NOVO
    
    if (!elQtd || !elCusto || !elVenda) return;

    const mascarado = localStorage.getItem('estoque_valores_mascarados') === 'true';

    if (mascarado) {
        elQtd.textContent = '‚Ä¢‚Ä¢‚Ä¢';
        elCusto.textContent = '‚Ä¢‚Ä¢‚Ä¢';
        elVenda.textContent = '‚Ä¢‚Ä¢‚Ä¢';
        if (elLucroVenda) elLucroVenda.textContent = '‚Ä¢‚Ä¢‚Ä¢';
        document.getElementById('toggleValoresEstoque').textContent = 'üîì Mostrar Valores';
    } else {
        const vQtd = elQtd.dataset.value !== undefined ? elQtd.dataset.value : elQtd.textContent;
        const vCusto = elCusto.dataset.value !== undefined ? parseFloat(elCusto.dataset.value) : 0;
        const vVenda = elVenda.dataset.value !== undefined ? parseFloat(elVenda.dataset.value) : 0;

        elQtd.textContent = vQtd;
        elCusto.textContent = formatarMoeda(vCusto);
        elVenda.textContent = formatarMoeda(vVenda);

        // NOVO: Restaura o lucro quando mostrar valores
        if (elLucroVenda) {
            const lucro = elLucroVenda.dataset.lucro !== undefined ? parseFloat(elLucroVenda.dataset.lucro) : 0;
            const percentual = elLucroVenda.dataset.percentual !== undefined ? elLucroVenda.dataset.percentual : 0;
            elLucroVenda.textContent = `Lucro: ${formatarMoeda(lucro)} (${percentual}%)`;
        }

        document.getElementById('toggleValoresEstoque').textContent = 'üîí Ocultar Valores';
    }
}

function toggleMostrarValoresEstoque() {
    const atual = localStorage.getItem('estoque_valores_mascarados') === 'true';
    localStorage.setItem('estoque_valores_mascarados', (!atual).toString());
    atualizarExibicaoValores();
}

// ---------- Nova fun√ß√£o para alternar exibi√ß√£o de estoque zerado ----------
function atualizarBotaoEstoqueZerado() {
    const btn = document.getElementById('toggleEstoqueZerado');
    if (!btn) return;
    
    const ocultarZerado = localStorage.getItem('estoque_ocultar_zerado') === 'true';
    
    if (ocultarZerado) {
        btn.textContent = 'üö´ Ocultar Estoque Zerado';
        btn.style.backgroundColor = '#28a745'; // Verde quando est√° mostrando tudo
    } else {
        btn.textContent = 'üëÅÔ∏è Mostrar Estoque Zerado';
        btn.style.backgroundColor = '#dc3545'; // Vermelho quando est√° ocultando
    }
}

function toggleMostrarEstoqueZerado() {
    const atual = localStorage.getItem('estoque_ocultar_zerado') === 'true';
    localStorage.setItem('estoque_ocultar_zerado', (!atual).toString());
    atualizarBotaoEstoqueZerado();
    renderizarTabelaEstoque(); // Re-renderiza a tabela com o novo filtro
}

// Conecta os bot√µes e inicializa quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    const btnValores = document.getElementById('toggleValoresEstoque');
    if (btnValores) {
        btnValores.addEventListener('click', toggleMostrarValoresEstoque);
    }
    
    const btnEstoqueZerado = document.getElementById('toggleEstoqueZerado');
    if (btnEstoqueZerado) {
        btnEstoqueZerado.addEventListener('click', toggleMostrarEstoqueZerado);
    }
    
    const checkbox = document.getElementById('checkNaoInformarCPF');
    if (checkbox) {
        checkbox.addEventListener('change', gerenciarCampoCPF);
    }
    
    atualizarExibicaoValores();
    atualizarBotaoEstoqueZerado(); // Inicializa o estado do novo bot√£o
});


const renderizarTabelaEstoque = () => {
            const produtos = getDados(STORAGE_PRODUTOS);
            const corpoTabelaEstoque = document.getElementById('corpoTabelaEstoque');
            corpoTabelaEstoque.innerHTML = '';
            atualizarResumoGeneroTamanho();

            // Verifica se deve ocultar produtos com estoque zerado
            const ocultarZerado = localStorage.getItem('estoque_ocultar_zerado') === 'true';

            produtos.forEach(produto => {
                // Se a op√ß√£o de ocultar estoque zerado est√° ativa E o estoque √© 0, pula este produto
                if (ocultarZerado && produto.estoque === 0) {
                    return; // N√£o renderiza esta linha
                }

                const linha = corpoTabelaEstoque.insertRow();
   
            // Adiciona classe CSS baseada no g√™nero
            if (produto.genero) {
            const generoLower = produto.genero.toLowerCase();
            if (generoLower === 'feminino') {
            linha.classList.add('genero-feminino');
            } else if (generoLower === 'masculino') {
            linha.classList.add('genero-masculino');
       }
   }
   
   // SKU Sistema
   linha.insertCell().textContent = produto.sku;
                
                // SKU Fabricante (NOVO CAMPO)
                linha.insertCell().textContent = produto.skuFabricante ? produto.skuFabricante : 'N/A';
                
                linha.insertCell().textContent = produto.marca;
                linha.insertCell().textContent = produto.genero || '---';
                linha.insertCell().textContent = `${produto.modelo}`;
                linha.insertCell().textContent = produto.cor;
                linha.insertCell().textContent = produto.tamanho;
                linha.insertCell().textContent = formatarMoeda(produto.custo);
                linha.insertCell().textContent = formatarMoeda(produto.venda);
                
                // Estoque com destaque
                const celulaEstoque = linha.insertCell();
                celulaEstoque.textContent = produto.estoque;
                if (produto.estoque < 5) {
                    celulaEstoque.style.color = '#dc3545'; // Vermelho para baixo estoque
                    celulaEstoque.style.fontWeight = 'bold';
                }

                // A√ß√µes
                const celulaAcao = linha.insertCell();
                const btnEditar = document.createElement('button');
                btnEditar.innerHTML = '<i class="fas fa-edit"></i>';
                btnEditar.className = 'btn-acao btn-small-icon';
                btnEditar.title = 'Editar';
                btnEditar.onclick = () => abrirModalEdicaoProduto(produto.sku);
                
                const btnRemover = document.createElement('button');
                btnRemover.innerHTML = '<i class="fas fa-trash-alt"></i>';
                btnRemover.className = 'btn-remover btn-small-icon';
                btnRemover.title = 'Remover';
                btnRemover.onclick = () => removerProduto(produto.sku);

                celulaAcao.appendChild(btnEditar);
                celulaAcao.appendChild(btnRemover);
            });
        };
        
        const abrirModalEdicaoProduto = (skuOriginal) => {
            const produto = getDados(STORAGE_PRODUTOS).find(p => p.sku === skuOriginal);
            if (!produto) {
                alert('Produto n√£o encontrado!');
                return;
            }

            document.getElementById('editSkuOriginal').value = produto.sku;
            document.getElementById('editSku').value = produto.sku;
            
            // NOVO: Carregar SKU Fabricante
            document.getElementById('editSkuFabricante').value = produto.skuFabricante || ''; 
            
            document.getElementById('editSkuOriginal').value = produto.sku;
  document.getElementById('editSku').value = produto.sku;
  document.getElementById('editSkuFabricante').value = produto.skuFabricante;
  document.getElementById('editMarca').value = produto.marca;
  document.getElementById('editModelo').value = produto.modelo;
  document.getElementById('editCor').value = produto.cor;
  document.getElementById('editTamanho').value = produto.tamanho;
  document.getElementById('editCusto').value = produto.custo || 0;
  document.getElementById('editVenda').value = produto.venda || 0;
  document.getElementById('editQuantidade').value = produto.estoque || 0;
  document.getElementById('modalEdicaoProduto').style.display = 'block';

            abrirModal('modalEdicaoProduto');
        };

        const formEdicaoProduto = document.getElementById('formEdicaoProduto');
        formEdicaoProduto.addEventListener('submit', (e) => {
            e.preventDefault();
            const skuOriginal = document.getElementById('editSkuOriginal').value;
            const produtos = getDados(STORAGE_PRODUTOS);
            const produto = produtos.find(p => p.sku === skuOriginal);
            
            if (!produto) return;

            // NOVO: Coleta o SKU do Fabricante
            const novoSkuFabricante = document.getElementById('editSkuFabricante').value.trim();
            
            // NOVO: Valida√ß√£o para garantir que o SKU Fabricante n√£o est√° sendo usado como SKU prim√°rio ou secund√°rio de OUTRO produto
            if (novoSkuFabricante) {
                const produtoExistente = buscarProdutoPorSku(novoSkuFabricante);
                
                // Se um produto for encontrado E o SKU Prim√°rio dele for diferente do SKU que estamos editando
                if (produtoExistente && produtoExistente.sku !== skuOriginal) {
                     alert(`Erro: O C√≥digo do Fabricante (SKU Manual) '${novoSkuFabricante}' j√° est√° cadastrado como SKU de outro produto. Por favor, verifique.`);
                     return;
                }
            }
            
            // Atualiza os dados
            produto.skuFabricante = novoSkuFabricante; // Salva o novo SKU Fabricante (pode ser vazio)
            produto.marca = document.getElementById('editMarca').value;
            produto.modelo = document.getElementById('editModelo').value;
            produto.cor = document.getElementById('editCor').value;
            produto.tamanho = document.getElementById('editTamanho').value;
            produto.custo = parseFloat(document.getElementById('editCusto').value);
            produto.venda = parseFloat(document.getElementById('editVenda').value);
            produto.estoque = parseInt(document.getElementById('editQuantidade').value);

            salvarDados(STORAGE_PRODUTOS, produtos);
            fecharModal('modalEdicaoProduto');
            renderizarTabelaEstoque();
            alert('Produto atualizado com sucesso!');
        });
        
        const removerProduto = (sku) => {
            if (confirm(`Tem certeza que deseja remover o produto com SKU ${sku}? Esta a√ß√£o √© irrevers√≠vel e pode afetar o hist√≥rico de vendas.`)) {
                let produtos = getDados(STORAGE_PRODUTOS);
                produtos = produtos.filter(p => p.sku !== sku);
                salvarDados(STORAGE_PRODUTOS, produtos);
                renderizarTabelaEstoque();
                alert('Produto removido.');
            }
        };

        // --- FUN√á√ïES DE CONSULTA R√ÅPIDA (USAM A NOVA BUSCARPRODUTOPORSKU) ---
        const consultarProdutoPorSku = () => {
    const skuInput = document.getElementById('skuConsulta').value.trim();
    if (skuInput === '') {
        // Limpa os campos se o input estiver vazio
        document.getElementById('consultaDescricao').textContent = 'Aguardando a digita√ß√£o do SKU...';
        document.getElementById('consultaPreco').textContent = '---';
        document.getElementById('consultaEstoque').textContent = '---';
        document.getElementById('consultaSkuSistema').textContent = '---';
        document.getElementById('consultaSkuFabricante').textContent = '---';
        document.getElementById('consultaVendas').textContent = '---'; // Novo
        document.getElementById('consultaConsignacoes').textContent = '---'; // Novo
        return;
    }

    const produtos = getDados(STORAGE_PRODUTOS);
    const produto = produtos.find(p => p.sku === skuInput || p.skuFabricante === skuInput);

    if (produto) {
        document.getElementById('consultaDescricao').textContent = `${produto.marca} ${produto.modelo} ${produto.cor} ${produto.tamanho}`;
        document.getElementById('consultaPreco').textContent = formatarMoeda(produto.venda);
        document.getElementById('consultaEstoque').textContent = produto.estoque;
        document.getElementById('consultaSkuSistema').textContent = produto.sku;
        document.getElementById('consultaSkuFabricante').textContent = produto.skuFabricante || 'N√£o informado';

        // Novo: Verifica em vendas (STORAGE_CAIXA)
        const vendas = getDados(STORAGE_CAIXA) || [];
        const vendasComSku = vendas.filter(v => v.sku === produto.sku);
        let vendasInfo = vendasComSku.length > 0 
            ? `${vendasComSku.length} registro(s) de venda. √öltima em ${vendasComSku[vendasComSku.length - 1]?.data || 'desconhecida'}.`
            : 'Nenhuma venda registrada.';

        document.getElementById('consultaVendas').textContent = vendasInfo;

        // Novo: Verifica em consigna√ß√µes pendentes (STORAGE_CONSIGNACOES)
        const consignacoes = getDados(STORAGE_CONSIGNACOES) || [];
        let qtdConsignada = 0;
        let consignacoesInfo = 'Nenhuma consigna√ß√£o pendente.';

        consignacoes.filter(c => c.status === 'pendente').forEach(cons => {
            cons.itens.forEach(item => {
                if (item.sku === produto.sku) {
                    qtdConsignada += item.quantidade;
                }
            });
        });

        if (qtdConsignada > 0) {
    consignacoesInfo = `‚ö†Ô∏è ${qtdConsignada} unidade(s) em consigna√ß√£o pendente!`;
}

const elementoConsignacoes = document.getElementById('consultaConsignacoes');
elementoConsignacoes.textContent = consignacoesInfo;
// Mant√©m o estilo vermelho e negrito se houver consigna√ß√µes
if (qtdConsignada > 0) {
    elementoConsignacoes.style.color = '#dc3545';
    elementoConsignacoes.style.fontWeight = 'bold';
} else {
    elementoConsignacoes.style.color = '';
    elementoConsignacoes.style.fontWeight = '';
}

        document.getElementById('consultaConsignacoes').textContent = consignacoesInfo;

    } else {
        // Limpa se n√£o encontrado
        document.getElementById('consultaDescricao').textContent = 'Produto n√£o encontrado!';
        document.getElementById('consultaPreco').textContent = '---';
        document.getElementById('consultaEstoque').textContent = '---';
        document.getElementById('consultaSkuSistema').textContent = '---';
        document.getElementById('consultaSkuFabricante').textContent = '---';
        document.getElementById('consultaVendas').textContent = '---'; // Novo
        document.getElementById('consultaConsignacoes').textContent = '---'; // Novo
    }
};


        // --- FUN√á√ïES DE VENDA (USAM A NOVA BUSCARPRODUTOPORSKU) ---

        let produtoEmVenda = null; // Armazena o produto detalhado da venda

        const exibirDetalhesProduto = () => {
            const skuVenda = document.getElementById('skuVenda').value.trim();
            const form = document.getElementById('formAdicionarItem');
            
            if (skuVenda.length < 3) {
                form.style.border = 'none'; 
                produtoEmVenda = null;
                return;
            }

            const produto = buscarProdutoPorSku(skuVenda);
            
            if (produto) {
                form.style.border = '3px solid #28a745'; // Verde
                produtoEmVenda = produto;
            } else {
                form.style.border = '3px solid #dc3545'; // Vermelho
                produtoEmVenda = null;
            }
        };
        
        const adicionarItemCarrinho = (produto, quantidade = 1) => {
    if (!produto) {
        alert('Erro: Produto inv√°lido ou n√£o encontrado.');
        return;
    }

    // Permitir vender mesmo com estoque zerado ou negativo
    if (produto.estoque <= 0) {
        alert(`‚ö†Ô∏è Estoque zerado (${produto.estoque}). Venda permitida ‚Äî o estoque ficar√° negativo.`);
    }

    const carrinho = getDados(STORAGE_CARRINHO);
    const itemExistente = carrinho.find(item => item.sku === produto.sku);
     
    if (itemExistente) {
        // Agora soma normalmente, mesmo que estoque esteja zerado
        itemExistente.quantidade += quantidade;
    } else {
        carrinho.push({
            sku: produto.sku,
            descricao: `${produto.sku} - ${produto.marca} - ${produto.modelo} - ${produto.cor} - ${produto.tamanho}`,
           valorUnitario: (function() {
        const precoManualRaw = document.getElementById('precoVendaManual') ? document.getElementById('precoVendaManual').value : '';
        const precoManual = parseFloat(precoManualRaw);
        return (!isNaN(precoManual) && precoManual > 0) ? precoManual : produto.venda;
    })(),
            quantidade: quantidade,
            skuFabricante: produto.skuFabricante || 'N/A'
        });
    }

    salvarDados(STORAGE_CARRINHO, carrinho);
    renderizarCarrinho();
};

        const formAdicionarItem = document.getElementById('formAdicionarItem');
        formAdicionarItem.addEventListener('submit', (e) => {
            e.preventDefault();
            if (produtoEmVenda) {
                adicionarItemCarrinho(produtoEmVenda);
                document.getElementById('skuVenda').value = '';
                if (document.getElementById('precoVendaManual')) {
            document.getElementById('precoVendaManual').value = '';
        }
                exibirDetalhesProduto(); // Limpa a borda
            } else {
                alert('Produto n√£o encontrado ou SKU inv√°lido.');
            }
        });

        const renderizarCarrinho = () => {
            const carrinho = getDados(STORAGE_CARRINHO);
            const corpoTabelaCarrinho = document.getElementById('corpoTabelaCarrinho');
            corpoTabelaCarrinho.innerHTML = '';
            totalCarrinhoBase = 0;

            if (carrinho.length === 0) {
                corpoTabelaCarrinho.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #888;">Nenhum item no carrinho.</td></tr>';
                document.getElementById('totalCarrinho').textContent = formatarMoeda(0);
                return;
            }

            carrinho.forEach(item => {
                const linha = corpoTabelaCarrinho.insertRow();
                const valorTotalItem = item.valorUnitario * item.quantidade;
                totalCarrinhoBase += valorTotalItem;

                // Item (Coluna 1)
                linha.insertCell().textContent = item.descricao;
                
                // Qtd (Coluna 2)
                linha.insertCell().textContent = item.quantidade;

                // Valor (Coluna 3)
                linha.insertCell().textContent = formatarMoeda(valorTotalItem);

                // A√ß√£o (Coluna 4)
                const celulaAcao = linha.insertCell();
                celulaAcao.style.textAlign = 'center';

                const btnRemover = document.createElement('button');
                btnRemover.innerHTML = '<i class="fas fa-trash-alt"></i>';
                btnRemover.className = 'btn-remover btn-small-icon';
                btnRemover.title = 'Remover Item';
                btnRemover.onclick = () => removerItemCarrinho(item.sku);
                
                const btnMenos = document.createElement('button');
                btnMenos.innerHTML = '<i class="fas fa-minus"></i>';
                btnMenos.className = 'btn-acao btn-small-icon';
                btnMenos.title = 'Diminuir Qtd';
                btnMenos.onclick = () => ajustarQuantidadeCarrinho(item.sku, -1);
                
                const btnMais = document.createElement('button');
                btnMais.innerHTML = '<i class="fas fa-plus"></i>';
                btnMais.className = 'btn-acao btn-small-icon';
                btnMais.title = 'Aumentar Qtd';
                btnMais.onclick = () => ajustarQuantidadeCarrinho(item.sku, 1);

                celulaAcao.appendChild(btnMenos);
                celulaAcao.appendChild(btnMais);
                celulaAcao.appendChild(btnRemover);
            });

            document.getElementById('totalCarrinho').textContent = formatarMoeda(totalCarrinhoBase);
        };

        const ajustarQuantidadeCarrinho = (sku, mudanca) => {
            const carrinho = getDados(STORAGE_CARRINHO);
            const item = carrinho.find(i => i.sku === sku);
            const produtos = getDados(STORAGE_PRODUTOS);
            const produtoEstoque = produtos.find(p => p.sku === sku);

            if (item && produtoEstoque) {
                const novaQuantidade = item.quantidade + mudanca;

                if (novaQuantidade <= 0) {
                    removerItemCarrinho(sku);
                    return;
                }
                
                if (mudanca > 0 && produtoEstoque.estoque <= 0) {
    if (!confirm(`‚ö†Ô∏è Estoque zerado...`)) {
        return;  // ‚úÖ S√ì BLOQUEIA SE CANCELAR
    }
}

                item.quantidade = novaQuantidade;
                salvarDados(STORAGE_CARRINHO, carrinho);
                renderizarCarrinho();
            }
        };

        const removerItemCarrinho = (sku) => {
            let carrinho = getDados(STORAGE_CARRINHO);
            carrinho = carrinho.filter(item => item.sku !== sku);
            salvarDados(STORAGE_CARRINHO, carrinho);
            renderizarCarrinho();
        };

        // --- LIMPAR CARRINHO ---
const limparCarrinho = () => {
    salvarDados(STORAGE_CARRINHO, []); // Limpa o carrinho no storage
    renderizarCarrinho(); // Renderiza a tabela vazia
    clienteVendaAtual = null; // Limpa o cliente selecionado
    document.getElementById('cpfCliente').value = '';
    document.getElementById('infoCliente').textContent = 'Cliente: N√£o identificado';

    // CORRE√á√ÉO: Fecha todos os modais de venda/cliente para garantir a limpeza da tela.
    fecharModal('modalCadastroClienteVenda'); 
    fecharModal('modalVendaSemCadastro'); 
    fecharModal('modalConfirmacaoVenda');
    valorFreteAtual = 0; // Zera o frete para a pr√≥xima venda
    totalCarrinhoBase = 0; // Garante que o total base tamb√©m comece do zero
    document.getElementById("totalCarrinho").textContent = formatarMoeda(0);
    alert('Carrinho limpo e venda cancelada.');
};

        // --- FUN√á√ïES DE CLIENTE ---
        const buscarClientePorCpf = (cpf) => {
            const clientes = getDados(STORAGE_CLIENTES);
            const cpfLimpo = limparCpf(cpf);
            return clientes.find(cliente => cliente.cpf === cpfLimpo);
        };
        
        const validarClienteVenda = () => {
            const cpfOuNomeInput = document.getElementById('cpfCliente').value.trim();
            const infoClienteP = document.getElementById('infoCliente');
            const cpfLimpo = limparCpf(cpfOuNomeInput);
            clienteVendaAtual = null;

            if (!cpfLimpo || cpfLimpo.length < 11) {
                // Se n√£o √© CPF, trata como nome (apenas para exibi√ß√£o)
                if (cpfOuNomeInput.length > 0) {
                    infoClienteP.textContent = `Cliente: ${cpfOuNomeInput} (Sem cadastro/CPF)`;
                } else {
                    infoClienteP.textContent = 'Cliente: N√£o identificado';
                }
                clienteVendaAtual = { nome: cpfOuNomeInput || 'Cliente N√£o Identificado', cpf: null };
                return;
            }

            const cliente = buscarClientePorCpf(cpfLimpo);

            if (cliente) {
                infoClienteP.textContent = `Cliente: ${cliente.nome} (CPF: ${formatarCpfVisual(cliente.cpf)})`;
                clienteVendaAtual = cliente;
            } else {
                infoClienteP.textContent = `CPF: ${formatarCpfVisual(cpfLimpo)} - N√ÉO ENCONTRADO!`;
                clienteVendaAtual = { nome: null, cpf: cpfLimpo }; // Armazena o CPF n√£o cadastrado
            }
        };

        const formCadastroCliente = document.getElementById('formCadastroCliente');
        formCadastroCliente.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const cpfInput = document.getElementById('cpf');
            const cpfLimpo = limparCpf(cpfInput.value);

            if (cpfLimpo.length !== 11) {
                 alert('O CPF deve conter 11 d√≠gitos.');
                 return;
            }
            
            // Verifica se o cliente j√° existe
            if (buscarClientePorCpf(cpfLimpo)) {
                alert('Erro: J√° existe um cliente cadastrado com este CPF.');
                return;
            }

            const novoCliente = {
                nome: document.getElementById('nomeCliente').value,
                cpf: cpfLimpo,
                telefone: document.getElementById('telefone').value,
                rua: document.getElementById('rua').value,
                numero: document.getElementById('numero').value,
                bairro: document.getElementById('bairro').value,
                cep: document.getElementById('cep').value,
                cadastro: new Date().getTime()
            };

            const clientes = getDados(STORAGE_CLIENTES);
            clientes.push(novoCliente);
            salvarDados(STORAGE_CLIENTES, clientes);
            
            formCadastroCliente.reset();
            renderizarTabelaClientes();
            alert('Cliente cadastrado com sucesso!');
            
            const checkboxCPF = document.getElementById('checkNaoInformarCPF');
            const campoCPFForm = document.getElementById('cpf');
            if (checkboxCPF) checkboxCPF.checked = false;
            if (campoCPFForm) {
                campoCPFForm.disabled = false;
                campoCPFForm.style.backgroundColor = '';
                campoCPFForm.style.cursor = '';
                campoCPFForm.setAttribute('required', 'required');
            }
        });
        
        // ... [Resto das fun√ß√µes de Cliente, Venda, Caixa e Exporta√ß√£o/Importa√ß√£o]
        
        const renderizarTabelaClientes = () => {
            const clientes = getDados(STORAGE_CLIENTES);
            const corpoTabelaClientes = document.getElementById('corpoTabelaClientes');
            corpoTabelaClientes.innerHTML = '';

            clientes.forEach(cliente => {
                const linha = corpoTabelaClientes.insertRow();
                linha.insertCell().textContent = cliente.nome;
                linha.insertCell().textContent = formatarCpfVisual(cliente.cpf);
                linha.insertCell().textContent = cliente.telefone;
                
                // Endere√ßo
                const endereco = `${cliente.rua || ''}${cliente.numero ? ', ' + cliente.numero : ''}${cliente.bairro ? ' - ' + cliente.bairro : ''}${cliente.cep ? ' (' + cliente.cep + ')' : ''}`;
                linha.insertCell().textContent = endereco.trim() || 'N/A';

                // A√ß√µes
                const celulaAcao = linha.insertCell();
                
                const btnHistorico = document.createElement('button');
                btnHistorico.innerHTML = '<i class="fas fa-history"></i>';
                btnHistorico.className = 'btn-acao btn-small-icon';
                btnHistorico.title = 'Ver Hist√≥rico';
                btnHistorico.onclick = () => abrirModalHistoricoVendas(cliente.cpf);
                
                const btnEditar = document.createElement('button');
                btnEditar.innerHTML = '<i class="fas fa-edit"></i>';
                btnEditar.className = 'btn-acao btn-small-icon';
                btnEditar.title = 'Editar';
                btnEditar.onclick = () => abrirModalEdicaoCliente(cliente.cpf);
                
                const btnRemover = document.createElement('button');
                btnRemover.innerHTML = '<i class="fas fa-trash-alt"></i>';
                btnRemover.className = 'btn-remover btn-small-icon';
                btnRemover.title = 'Remover';
                btnRemover.onclick = () => removerCliente(cliente.cpf);

                celulaAcao.appendChild(btnHistorico);
                celulaAcao.appendChild(btnEditar);
                celulaAcao.appendChild(btnRemover);
            });
        };
        
        const abrirModalEdicaoCliente = (cpfOriginal) => {
            const cliente = buscarClientePorCpf(cpfOriginal);
            if (!cliente) {
                alert('Cliente n√£o encontrado!');
                return;
            }

            document.getElementById('editCpfOriginal').value = cliente.cpf;
            document.getElementById('editNomeCliente').value = cliente.nome;
            document.getElementById('editCpf').value = formatarCpfVisual(cliente.cpf); // Exibe formatado, mas o valor real √© o original
            document.getElementById('editTelefone').value = cliente.telefone;
            document.getElementById('editRua').value = cliente.rua;
            document.getElementById('editNumero').value = cliente.numero;
            document.getElementById('editBairro').value = cliente.bairro;
            document.getElementById('editCep').value = cliente.cep;

            abrirModal('modalEdicaoCliente');
        };

        const formEdicaoCliente = document.getElementById('formEdicaoCliente');
        formEdicaoCliente.addEventListener('submit', (e) => {
            e.preventDefault();
            const cpfOriginal = document.getElementById('editCpfOriginal').value;
            const clientes = getDados(STORAGE_CLIENTES);
            const cliente = clientes.find(c => c.cpf === cpfOriginal);
            
            if (!cliente) return;

            cliente.nome = document.getElementById('editNomeCliente').value;
            // CPF n√£o pode ser editado (campo disabled), mas a m√°scara √© aplicada.
            cliente.telefone = document.getElementById('editTelefone').value;
            cliente.rua = document.getElementById('editRua').value;
            cliente.numero = document.getElementById('editNumero').value;
            cliente.bairro = document.getElementById('editBairro').value;
            cliente.cep = document.getElementById('editCep').value;

            salvarDados(STORAGE_CLIENTES, clientes);
            fecharModal('modalEdicaoCliente');
            renderizarTabelaClientes();
            alert('Cliente atualizado com sucesso!');
        });

        const removerCliente = (cpf) => {
            if (confirm(`Tem certeza que deseja remover o cliente com CPF ${formatarCpfVisual(cpf)}?`)) {
                let clientes = getDados(STORAGE_CLIENTES);
                clientes = clientes.filter(c => c.cpf !== cpf);
                salvarDados(STORAGE_CLIENTES, clientes);
                renderizarTabelaClientes();
                alert('Cliente removido.');
            }
        };

        // --- FUN√á√ïES DE FINALIZA√á√ÉO DE VENDA ---
        const iniciarFinalizacaoVenda = () => {
            const carrinho = getDados(STORAGE_CARRINHO);
            if (carrinho.length === 0) {
                alert('O carrinho est√° vazio.');
                return;
            }
            
            // 1. Pega o cliente validado no input (pode ser um objeto com nome:null, cpf:null)
            const cliente = clienteVendaAtual; 
            
            if (cliente && cliente.cpf) {
                // Se foi digitado um CPF
                const clienteCadastrado = buscarClientePorCpf(cliente.cpf);
                
                if (clienteCadastrado) {
                    // CPF Cadastrado -> Abre modal de confirma√ß√£o
                    abrirModalConfirmacao(clienteCadastrado);
                } else {
                    // CPF N√£o Cadastrado -> Abre modal de venda sem cadastro
                    abrirModal('modalVendaSemCadastro');
                }
            } else {
                // Sem CPF digitado -> Abre modal de confirma√ß√£o (com cliente 'N√£o Identificado')
                abrirModalConfirmacao(cliente);
            }
        };
        
        const abrirModalConfirmacaoSemCadastro = () => {
            fecharModal('modalVendaSemCadastro');
            // Usa o clienteVendaAtual (que pode ter o nome digitado, ou ser "N√£o Identificado")
            abrirModalConfirmacao(clienteVendaAtual); 
        };
        
        const abrirModalConfirmacao = (cliente) => {
            // Se o nome do cliente n√£o estiver dispon√≠vel, usa a informa√ß√£o de "N√£o Identificado"
            const nomeExibicao = cliente.nome || (cliente.cpf ? `CPF: ${formatarCpfVisual(cliente.cpf)} (N√£o Cadastrado)` : 'Cliente N√£o Identificado');
            
            document.getElementById('confirmNomeCliente').textContent = nomeExibicao;
            document.getElementById('confirmCpfCliente').textContent = cliente.cpf ? formatarCpfVisual(cliente.cpf) : 'N/A';
            document.getElementById('metodoPagamento').value = 'DINHEIRO'; // Reseta para Dinheiro
            
            // Calcula e exibe o total (sem taxa no in√≠cio)
            document.getElementById('confirmTotalVenda').textContent = formatarMoeda(totalCarrinhoBase);
            document.getElementById('alertaTaxaCredito').style.display = 'none';

            abrirModal('modalConfirmacaoVenda');
        };

        const atualizarTotalModal = () => {
            const metodo = document.getElementById('metodoPagamento').value;
            let totalFinal = totalCarrinhoBase;
            const alerta = document.getElementById('alertaTaxaCredito');

            if (metodo === 'CARTAO_CREDITO') {
                const taxa = totalCarrinhoBase * TAXA_CREDITO;
                totalFinal += taxa;
                alerta.textContent = `AVISO: Taxa de cr√©dito de ${TAXA_CREDITO * 100}% aplicada (${formatarMoeda(taxa)})`;
                alerta.style.display = 'block';
            } else {
                alerta.style.display = 'none';
            }

            document.getElementById('confirmTotalVenda').textContent = formatarMoeda(totalFinal);
        };

// --- FUN√á√ÉO PARA ADICIONAR FRETE ---
let valorFreteAtual = 0;

function adicionarFrete() {
    const valor = parseFloat(prompt("Informe o valor do frete (em R$):", "0"));
    if (isNaN(valor) || valor < 0) {
        alert("Valor inv√°lido. Tente novamente.");
        return;
    }
    valorFreteAtual = valor;
    totalCarrinhoBase += valorFreteAtual;
    document.getElementById("totalCarrinho").textContent = formatarMoeda(totalCarrinhoBase);
    alert(`Frete de ${formatarMoeda(valorFreteAtual)} adicionado ao total.`);
}
        
        const finalizarVenda = (isCadastroRapido) => {
            // Se a chamada veio do modal de cadastro r√°pido, preciso garantir que o clienteVendaAtual est√° atualizado
            if (isCadastroRapido) {
                const cpfInput = document.getElementById('vendaCpf').value;
                clienteVendaAtual = buscarClientePorCpf(limparCpf(cpfInput));
                if (!clienteVendaAtual) {
                    alert('Erro: Cliente n√£o encontrado ap√≥s cadastro. Tente novamente.');
                    return;
                }
                fecharModal('modalCadastroClienteVenda');
            }

// CORRE√á√ÉO: Fechar o modal de cadastro de cliente ap√≥s a finaliza√ß√£o
    fecharModal('modalCadastroClienteVenda');
            
            const carrinho = getDados(STORAGE_CARRINHO);
            const metodoPagamento = document.getElementById('metodoPagamento').value;
            let totalFinal = totalCarrinhoBase;

            if (metodoPagamento === 'CARTAO_CREDITO') {
                totalFinal = totalCarrinhoBase * (1 + TAXA_CREDITO);
            }

            // 1. Atualiza Estoque
            const produtos = getDados(STORAGE_PRODUTOS);
            carrinho.forEach(itemVenda => {
                const produtoEstoque = produtos.find(p => p.sku === itemVenda.sku);
                if (produtoEstoque) {
                    produtoEstoque.estoque -= itemVenda.quantidade;
                }
            });
            salvarDados(STORAGE_PRODUTOS, produtos);
            
            // 2. Salva no Caixa (Hist√≥rico de Vendas)
            const vendasCaixa = getDados(STORAGE_CAIXA);
            const dataVenda = new Date();
            const transactionId = dataVenda.getTime(); // ID √öNICO DA TRANSA√á√ÉO

            carrinho.forEach(itemVenda => {
                // Salva cada item como um registro de venda
                vendasCaixa.push({
                    id: vendasCaixa.length + 1, // ID sequencial simples
                    transactionId: transactionId, // NOVO: ID da Transa√ß√£o
                    timestamp: dataVenda.getTime(),
                    data: formatarDataIso(dataVenda),
                    hora: dataVenda.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                    sku: itemVenda.sku, // SKU do Sistema
                    descricao: itemVenda.descricao,
                    quantidade: itemVenda.quantidade,
                    valorTotal: itemVenda.valorUnitario * itemVenda.quantidade, // Valor total do item
                    valorUnitario: itemVenda.valorUnitario,
                    clienteNome: (clienteVendaAtual && clienteVendaAtual.nome && clienteVendaAtual.nome.trim() !== '') 
    ? clienteVendaAtual.nome 
    : (document.getElementById('cpfCliente').value.trim() || 'Cliente N√£o Identificado'),
                    clienteCpf: clienteVendaAtual.cpf,
                    pagamento: metodoPagamento,
                    totalTransacao: totalFinal, // NOVO: Total final da transa√ß√£o
                });
            });
            salvarDados(STORAGE_CAIXA, vendasCaixa);
            
            // 3. Calcular o nome para o recibo ANTES de resetar campos
const nomeClienteRecibo = (clienteVendaAtual && clienteVendaAtual.nome && clienteVendaAtual.nome.trim() !== '')
    ? clienteVendaAtual.nome
    : (clienteVendaAtual && clienteVendaAtual.cpf
        ? formatarCpfVisual(clienteVendaAtual.cpf)
        : (document.getElementById('cpfCliente').value.trim() || 'N√£o Identificado'));

// 4. Limpa e finaliza (a limpeza pode ocorrer, j√° temos o nome salvo)
salvarDados(STORAGE_CARRINHO, []);
renderizarCarrinho();
document.getElementById('cpfCliente').value = '';
validarClienteVenda(); // Reseta o cliente (ok ‚Äî j√° calculamos o nome para o recibo)
fecharModal('modalConfirmacaoVenda');

// 5. Imprime recibo e notifica usando o nome salvo
imprimirRecibo(carrinho, totalFinal, nomeClienteRecibo, metodoPagamento);
alert(`Venda finalizada com sucesso! Total: ${formatarMoeda(totalFinal)}`);


            // Atualiza o estoque se a se√ß√£o estiver vis√≠vel
            if (document.getElementById('secao-estoque').style.display === 'block') {
                renderizarTabelaEstoque();
            }
            // Atualiza o caixa
            renderizarTabelaCaixa();
            calcularResumosCaixa();
        };

        const formCadastroClienteVenda = document.getElementById('formCadastroClienteVenda');
        formCadastroClienteVenda.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const cpfInput = document.getElementById('vendaCpf');
            const cpfLimpo = limparCpf(cpfInput.value);

            if (cpfLimpo.length !== 11) {
                 alert('O CPF deve conter 11 d√≠gitos.');
                 return;
            }
            
            // 1. Verifica se j√° existe (Dupla checagem)
            if (buscarClientePorCpf(cpfLimpo)) {
                alert('Erro: J√° existe um cliente cadastrado com este CPF. Finalizando a venda com o cadastro existente.');
            } else {
                // 2. Cadastra o novo cliente (apenas com Nome/CPF/Telefone)
                const novoCliente = {
                    nome: document.getElementById('vendaNomeCliente').value,
                    cpf: cpfLimpo,
                    telefone: document.getElementById('vendaTelefone').value,
                    rua: '', numero: '', bairro: '', cep: '',
                    cadastro: new Date().getTime()
                };

                const clientes = getDados(STORAGE_CLIENTES);
                clientes.push(novoCliente);
                salvarDados(STORAGE_CLIENTES, clientes);
                alert('Cliente cadastrado com sucesso!');
            }
            
            // 3. Define o cliente atual e abre o modal de confirma√ß√£o para finalizar
            clienteVendaAtual = buscarClientePorCpf(limparCpf(cpfInput.value)); // Pega o objeto de volta
            
            // Usa a fun√ß√£o auxiliar para abrir o modal de confirma√ß√£o
            abrirModalConfirmacao(clienteVendaAtual);
        });

        // --- FUN√á√ïES DE CAIXA/RELAT√ìRIO ---
        const alternarFiltrosCaixa = (valor) => {
            document.getElementById('divFiltroDiario').style.display = 'none';
            document.getElementById('divFiltroMensal').style.display = 'none';
            
            if (valor === 'diario') {
                document.getElementById('divFiltroDiario').style.display = 'block';
                // Define a data atual como padr√£o no filtro di√°rio
                document.getElementById('filtroDataDiaria').value = formatarDataIso(new Date());
                aplicarFiltroDiario();
            } else if (valor === 'mensal') {
                document.getElementById('divFiltroMensal').style.display = 'block';
                // Define o m√™s atual como padr√£o no filtro mensal
                document.getElementById('filtroDataMensal').value = formatarMesIso(new Date());
                aplicarFiltroMensal();
            } else {
                 renderizarTabelaCaixa();
                 calcularResumosCaixa();
            }
        };
        
        const aplicarFiltroDiario = () => {
            renderizarTabelaCaixa();
            calcularResumosCaixa();
        };
        
        const aplicarFiltroMensal = () => {
            renderizarTabelaCaixa();
            calcularResumosCaixa();
        };

        const renderizarTabelaCaixa = () => {
    const vendas = getDados(STORAGE_CAIXA);
    const produtos = getDados(STORAGE_PRODUTOS);
    const corpoTabelaCaixa = document.getElementById('corpoTabelaCaixa');
    corpoTabelaCaixa.innerHTML = '';
    
    const filtro = document.getElementById('filtroCaixa').value;
    let vendasFiltradas = vendas;
    let totalVendasPeriodo = 0;
    let totalItensPeriodo = 0;
    let totalCustoPeriodo = 0;

    if (filtro === 'diario') {
        const dataFiltro = document.getElementById('filtroDataDiaria').value;
        if (dataFiltro) {
            vendasFiltradas = vendas.filter(venda => venda.data === dataFiltro);
        }
    } else if (filtro === 'mensal') {
        const mesFiltro = document.getElementById('filtroDataMensal').value;
        if (mesFiltro) {
            vendasFiltradas = vendas.filter(venda => venda.data.startsWith(mesFiltro));
        }
    }
    
    // ‚úÖ AGRUPA VENDAS POR TRANSACTION ID
    const transacoesAgrupadas = {};
    vendasFiltradas.forEach(venda => {
        const txId = venda.transactionId || venda.id;
        
        if (!transacoesAgrupadas[txId]) {
            transacoesAgrupadas[txId] = {
                transactionId: txId,
                data: venda.data,
                hora: venda.hora,
                clienteNome: venda.clienteNome,
                pagamento: venda.pagamento,
                itens: [],
                totalTransacao: 0,
                quantidadeTotal: 0
            };
        }
        
        transacoesAgrupadas[txId].itens.push({
            sku: venda.sku,
            descricao: venda.descricao,
            quantidade: venda.quantidade,
            valorTotal: venda.valorTotal
        });
        
        transacoesAgrupadas[txId].totalTransacao += venda.valorTotal;
        transacoesAgrupadas[txId].quantidadeTotal += venda.quantidade;
    });
    
    // ‚úÖ RENDERIZA CADA TRANSA√á√ÉO COMO UMA LINHA √öNICA
    Object.values(transacoesAgrupadas).forEach(transacao => {
    // ‚úÖ IGNORA TROCAS no resumo do filtro
    if (transacao.itens.some(item => item.descricao && item.descricao.includes('üîÑ TROCA'))) {
        return; // Pula esta transa√ß√£o se for uma troca
    }
    
    totalVendasPeriodo += transacao.totalTransacao;
    totalItensPeriodo += transacao.quantidadeTotal;
        
        transacao.itens.forEach(item => {
            const produto = produtos.find(p => p.sku === item.sku);
            const custoProduto = produto ? produto.custo : 0;
            totalCustoPeriodo += custoProduto * item.quantidade;
        });
        
        const linha = corpoTabelaCaixa.insertRow();
        
        linha.insertCell().textContent = transacao.data;
linha.insertCell().textContent = transacao.hora;

const celulaSku = linha.insertCell();
let skusHtml = '';
transacao.itens.forEach((item, index) => {
    skusHtml += `<div style="padding: 6px 0; min-height: 28px; display: flex; align-items: center; ${index > 0 ? 'border-top: 1px dashed #ddd;' : ''}">
        ${item.sku}
    </div>`;
});
celulaSku.innerHTML = skusHtml;

const celulaDescricao = linha.insertCell();
let descricaoHtml = '';
transacao.itens.forEach((item, index) => {
    const valorUnitario = item.valorTotal / item.quantidade;
    descricaoHtml += `<div style="padding: 6px 0; min-height: 28px; display: flex; align-items: center; ${index > 0 ? 'border-top: 1px dashed #ddd;' : ''}">
        <strong>${item.quantidade}x</strong> ${item.descricao} <strong>(${formatarMoeda(valorUnitario)})</strong>
    </div>`;
});
celulaDescricao.innerHTML = descricaoHtml;

const celulaQtd = linha.insertCell();
celulaQtd.textContent = transacao.quantidadeTotal;
celulaQtd.style.textAlign = 'center';
celulaQtd.style.fontWeight = 'bold';
celulaQtd.style.verticalAlign = 'middle';

// ‚úÖ COLUNA Valor Unit√°rio - ALINHADA COM DESCRI√á√ÉO
// ‚úÖ COLUNA Subtotal (Qtd x Unit√°rio)
const celulaValorUnit = linha.insertCell();
let valoresUnitHtml = '';
transacao.itens.forEach((item, index) => {
    valoresUnitHtml += `<div style="padding: 6px 0; min-height: 28px; display: flex; align-items: center; justify-content: flex-end; ${index > 0 ? 'border-top: 1px dashed #ddd;' : ''}">
        ${formatarMoeda(item.valorTotal)}
    </div>`;
});
celulaValorUnit.innerHTML = valoresUnitHtml;

const celulaValor = linha.insertCell();
celulaValor.textContent = formatarMoeda(transacao.totalTransacao);
celulaValor.style.fontWeight = 'bold';
celulaValor.style.color = '#28a745';
celulaValor.style.verticalAlign = 'middle';
        celulaValor.style.fontWeight = 'bold';
        celulaValor.style.color = '#28a745';
        
        linha.insertCell().textContent = transacao.clienteNome;
        linha.insertCell().textContent = transacao.pagamento;
        
        const celulaAcao = linha.insertCell();
        
        const btnReimprimir = document.createElement('button');
        btnReimprimir.innerHTML = '<i class="fas fa-receipt"></i>';
        btnReimprimir.className = 'btn-acao btn-small-icon';
        btnReimprimir.title = 'Reimprimir Recibo';
        btnReimprimir.style.backgroundColor = '#ffc107';
        btnReimprimir.onclick = () => reimprimirReciboPorId(transacao.transactionId);
        celulaAcao.appendChild(btnReimprimir);
        
        const btnEstornar = document.createElement('button');
        btnEstornar.innerHTML = '<i class="fas fa-trash-alt"></i>';
        btnEstornar.className = 'btn-remover btn-small-icon';
        btnEstornar.title = 'Estornar Venda Completa';
        btnEstornar.onclick = () => estornarTransacao(transacao.transactionId);
        celulaAcao.appendChild(btnEstornar);
    });

    const lucroPeriodo = totalVendasPeriodo - totalCustoPeriodo;
    const percentualLucro = totalCustoPeriodo > 0 ? ((lucroPeriodo / totalCustoPeriodo) * 100).toFixed(1) : 0;

    document.getElementById('resumoTotalVendas').textContent = formatarMoeda(totalVendasPeriodo);
    document.getElementById('resumoTotalItens').textContent = totalItensPeriodo;
    let ticketMedio = totalItensPeriodo > 0 ? totalVendasPeriodo / totalItensPeriodo : 0;
    document.getElementById('resumoTicketMedio').textContent = formatarMoeda(ticketMedio);
    
     // ‚ú® NOVO: Calcula trocas do per√≠odo filtrado
let totalTrocasPeriodo = 0;
const trocas = getDados(STORAGE_TROCAS) || [];

trocas.forEach(troca => {
    // ‚úÖ Ignora trocas estornadas
    if (troca.status === 'estornada') return;
    
    // ‚úÖ Filtra pelo per√≠odo selecionado
    let incluirTroca = false;
    if (filtro === 'diario' && troca.data === document.getElementById('filtroDataDiaria').value) {
        incluirTroca = true;
    } else if (filtro === 'mensal' && troca.data.startsWith(document.getElementById('filtroDataMensal').value)) {
        incluirTroca = true;
    } else if (filtro === 'todos') {
        incluirTroca = true;
    }
    
    if (incluirTroca) {
        totalTrocasPeriodo += Math.abs(troca.diferenca);
    }
});

      // ‚ú® NOVO: Calcula Faturamento Total (Vendas + Trocas do Per√≠odo)
const faturamentoTotalPeriodo = totalVendasPeriodo + totalTrocasPeriodo;
document.getElementById('resumoFaturamentoTotal').textContent = formatarMoeda(faturamentoTotalPeriodo);

// ‚úÖ NOVO: Calcula Ticket M√©dio COM Trocas
// Soma a quantidade de itens vendidos + diferen√ßa de trocas (quando cliente leva mais)
let totalItensComTrocas = totalItensPeriodo;

// Filtra as trocas do per√≠odo atual
const trocasFiltradas = [];
if (filtro === 'diario') {
    const dataFiltro = document.getElementById('filtroDataDiaria').value;
    if (dataFiltro) {
        trocasFiltradas.push(...trocas.filter(t => t.data === dataFiltro && t.status !== 'estornada'));
    }
} else if (filtro === 'mensal') {
    const mesFiltro = document.getElementById('filtroDataMensal').value;
    if (mesFiltro) {
        trocasFiltradas.push(...trocas.filter(t => t.data.startsWith(mesFiltro) && t.status !== 'estornada'));
    }
} else {
    trocasFiltradas.push(...trocas.filter(t => t.status !== 'estornada'));
}

// ‚úÖ CORRE√á√ÉO: Para cada troca, soma a DIFEREN√áA POSITIVA (quando cliente leva mais)
trocasFiltradas.forEach(troca => {
    let qtdDevolvidos = 0;
    let qtdNovos = 0;
    troca.produtosDevolvidos.forEach(p => qtdDevolvidos += p.quantidade);
    troca.produtosNovos.forEach(p => qtdNovos += p.quantidade);
    
    // Calcula a diferen√ßa (pode ser positiva, negativa ou zero)
    const diferencaQtd = qtdNovos - qtdDevolvidos;
    
    // ‚úÖ Se a diferen√ßa for positiva (cliente levou mais), adiciona ao total
    if (diferencaQtd > 0) {
        totalItensComTrocas += diferencaQtd;
    }
});

// Atualiza o display com o total incluindo trocas
document.getElementById('resumoTotalItensComTrocas').textContent = `C/ Trocas: ${totalItensComTrocas}`;

const ticketMedioComTrocas = totalItensComTrocas > 0 ? faturamentoTotalPeriodo / totalItensComTrocas : 0;
document.getElementById('resumoTicketMedioComTrocas').textContent = `Ticket c/ troca: ${formatarMoeda(ticketMedioComTrocas)}`;

document.getElementById('resumoTrocasPeriodo').textContent = formatarMoeda(totalTrocasPeriodo);
};

        const calcularResumosCaixa = () => {
    const vendas = getDados(STORAGE_CAIXA);
    const produtos = getDados(STORAGE_PRODUTOS);
    const dataHoje = formatarDataIso(new Date());
    const mesHoje = formatarMesIso(new Date());
    const anoHoje = new Date().getFullYear().toString();
    
    const dataOntem = formatarDataIso(new Date(new Date().setDate(new Date().getDate() - 1)));

    const hoje = new Date();
    const diaSemana = hoje.getDay();
    const inicioSemana = new Date(hoje);
    inicioSemana.setDate(hoje.getDate() - (diaSemana === 0 ? 6 : diaSemana - 1));
    const dataInicioSemana = formatarDataIso(inicioSemana);

    let totalDia = 0, totalCustoDia = 0;
    let totalDiaAnterior = 0, totalCustoDiaAnterior = 0;
    let totalSemana = 0, totalCustoSemana = 0;
    let totalMes = 0, totalCustoMes = 0;
    let totalAno = 0, totalCustoAno = 0;
    let totalGeralTodosPeriodos = 0;        // ‚Üê ADICIONE ESTA LINHA
    let totalCustoGeralTodosPeriodos = 0;   // ‚Üê ADICIONE ESTA LINHA

    vendas.forEach(venda => {
    // ‚úÖ IGNORA REGISTROS DE TROCA no c√°lculo de vendas normais
    if (venda.tipoMovimento && venda.tipoMovimento.startsWith('troca_')) {
        return; // Pula esta itera√ß√£o
    }
    
    const produto = produtos.find(p => p.sku === venda.sku);
    const custoProduto = produto ? produto.custo : 0;
    const custoTotalItem = custoProduto * venda.quantidade;
    
    if (venda.data === dataHoje) {
        totalDia += venda.valorTotal;
        totalCustoDia += custoTotalItem;
    }
        if (venda.data === dataOntem) {
        totalDiaAnterior += venda.valorTotal;
        totalCustoDiaAnterior += custoTotalItem;
    }
    if (venda.data >= dataInicioSemana && venda.data <= dataHoje) {
        totalSemana += venda.valorTotal;
        totalCustoSemana += custoTotalItem;
    }
    if (venda.data.startsWith(mesHoje)) {
        totalMes += venda.valorTotal;
        totalCustoMes += custoTotalItem;
    }
    if (venda.data.startsWith(anoHoje)) {
        totalAno += venda.valorTotal;
        totalCustoAno += custoTotalItem;
    }

    // ‚Üê ADICIONE ESTAS DUAS LINHAS AQUI:
    totalGeralTodosPeriodos += venda.valorTotal;
    totalCustoGeralTodosPeriodos += custoTotalItem;
    });

    // Calcula lucros
    const lucroDia = totalDia - totalCustoDia;
    const percentualLucroDia = totalCustoDia > 0 ? ((lucroDia / totalCustoDia) * 100).toFixed(1) : 0;
    
    const lucroDiaAnterior = totalDiaAnterior - totalCustoDiaAnterior;
    const percentualLucroDiaAnterior = totalCustoDiaAnterior > 0 ? ((lucroDiaAnterior / totalCustoDiaAnterior) * 100).toFixed(1) : 0;
    
    const lucroSemana = totalSemana - totalCustoSemana;
    const percentualLucroSemana = totalCustoSemana > 0 ? ((lucroSemana / totalCustoSemana) * 100).toFixed(1) : 0;
    
    const lucroMes = totalMes - totalCustoMes;
    const percentualLucroMes = totalCustoMes > 0 ? ((lucroMes / totalCustoMes) * 100).toFixed(1) : 0;
    
    const lucroAno = totalAno - totalCustoAno;
    const percentualLucroAno = totalCustoAno > 0 ? ((lucroAno / totalCustoAno) * 100).toFixed(1) : 0;

    // Atualiza valores na tela
    document.getElementById('resumoDiaTotalVendas').textContent = formatarMoeda(totalDia);
    document.getElementById('resumoDiaAnteriorTotalVendas').textContent = formatarMoeda(totalDiaAnterior);
    document.getElementById('resumoSemanaTotalVendas').textContent = formatarMoeda(totalSemana);
    document.getElementById('resumoMesTotalVendas').textContent = formatarMoeda(totalMes);
    document.getElementById('resumoAnoTotalVendas').textContent = formatarMoeda(totalAno);
    
    // ‚≠ê ATUALIZA OS LUCROS (NOVAS LINHAS)
    document.getElementById('resumoDiaLucro').textContent = `Lucro: ${formatarMoeda(lucroDia)} (${percentualLucroDia}%)`;
    document.getElementById('resumoDiaAnteriorLucro').textContent = `Lucro: ${formatarMoeda(lucroDiaAnterior)} (${percentualLucroDiaAnterior}%)`;
    document.getElementById('resumoSemanaLucro').textContent = `Lucro: ${formatarMoeda(lucroSemana)} (${percentualLucroSemana}%)`;
    document.getElementById('resumoMesLucro').textContent = `Lucro: ${formatarMoeda(lucroMes)} (${percentualLucroMes}%)`;
    document.getElementById('resumoAnoLucro').textContent = `Lucro: ${formatarMoeda(lucroAno)} (${percentualLucroAno}%)`;
    
    // Consigna√ß√£o e totais gerais - CALCULA TOTAL E SALDO A RECEBER
let totalConsignacao = 0;
let totalConsignacaoPago = 0;
let totalCustoConsignacao = 0; // ‚úÖ NOVA LINHA ADICIONADA
const consignacoes = getDados(STORAGE_CONSIGNACOES) || [];

consignacoes.filter(c => c.status === 'pendente').forEach(cons => {
    // Calcula o total da consigna√É¬ß√É¬£o
    let totalCons = 0;
    cons.itens.forEach(item => {
        totalCons += item.valorUnitario * item.quantidade;
        
        // ‚úÖ NOVO BLOCO: Calcula o custo da consigna√ß√£o
        const produto = produtos.find(p => p.sku === item.sku);
        if (produto) {
            totalCustoConsignacao += produto.custo * item.quantidade;
        }
    });
    
    totalConsignacao += totalCons;
    totalConsignacaoPago += (cons.valorPago || 0);
});

const saldoConsignacao = totalConsignacao - totalConsignacaoPago;

// ‚úÖ NOVO: Calcula lucro da consigna√ß√£o
const lucroConsignacao = totalConsignacao - totalCustoConsignacao;
const percentualLucroConsignacao = totalCustoConsignacao > 0 
    ? ((lucroConsignacao / totalCustoConsignacao) * 100).toFixed(1) 
    : 0;

document.getElementById('resumoTotalConsignacao').textContent = formatarMoeda(totalConsignacao);
document.getElementById('resumoConsignacaoSaldo').textContent = formatarMoeda(saldoConsignacao);

    // ‚úÖ CALCULA TROCAS CORRETAMENTE (IGNORA ESTORNADAS)
const trocas = getDados(STORAGE_TROCAS) || [];
let totalTrocas = 0;
let lucroTrocas = 0;

trocas.forEach(troca => {
    if (troca.status === 'estornada') return;
    
    if (troca.data.startsWith(anoHoje)) {
        // Soma a diferen√ßa absoluta ao faturamento
        totalTrocas += Math.abs(troca.diferenca);
        
        // ‚úÖ C√ÅLCULO CORRETO DO LUCRO DA TROCA
        let custoDevolvidos = 0;
        let custoNovos = 0;
        
        // Calcula custo dos produtos devolvidos
        troca.produtosDevolvidos.forEach(item => {
            const prod = produtos.find(p => p.sku === item.sku);
            if (prod) {
                custoDevolvidos += prod.custo * item.quantidade;
            }
        });
        
        // Calcula custo dos produtos novos
        troca.produtosNovos.forEach(item => {
            const prod = produtos.find(p => p.sku === item.sku);
            if (prod) {
                custoNovos += prod.custo * item.quantidade;
            }
        });
        
        // ‚úÖ LUCRO REAL = diferen√ßa - (custo dos novos - custo dos devolvidos)
        const lucroRealTroca = troca.diferenca - (custoNovos - custoDevolvidos);
        lucroTrocas += lucroRealTroca;
    }
});

// ‚úÖ CORRE√á√ÉO: Faturamento Geral = TODAS as vendas de TODOS os anos
const faturamentoGeralSemTrocas = totalGeralTodosPeriodos; // ‚Üê MUDOU AQUI
const lucroGeralSemTrocas = totalGeralTodosPeriodos - totalCustoGeralTodosPeriodos; // ‚Üê MUDOU AQUI

// Recalcula o percentual considerando TODAS as vendas
const custoTotal = totalCustoGeralTodosPeriodos; // ‚Üê MUDOU AQUI
const percentualLucroGeral = custoTotal > 0 
    ? ((lucroGeralSemTrocas / custoTotal) * 100).toFixed(1) 
    : 0;

document.getElementById('resumoFaturamentoGeral').textContent = formatarMoeda(faturamentoGeralSemTrocas);
document.getElementById('resumoLucroGeral').textContent = 
    `Lucro: ${formatarMoeda(lucroGeralSemTrocas)} (${percentualLucroGeral}%)`;

// ‚úÖ NOVO: CALCULA LUCRO TOTAL (VENDAS + CONSIGNA√á√ÉO)
const lucroTotalGeral = lucroGeralSemTrocas + lucroConsignacao;
const custoTotalGeral = totalCustoGeralTodosPeriodos + totalCustoConsignacao;
const percentualLucroTotalGeral = custoTotalGeral > 0 
    ? ((lucroTotalGeral / custoTotalGeral) * 100).toFixed(1) 
    : 0;

// ‚úÖ Total Geral = Vendas + Consigna√ß√£o (SEM trocas)
const totalGeral = faturamentoGeralSemTrocas + totalConsignacao;

// ‚úÖ ATUALIZA CARD TOTAL GERAL COM LUCRO
const elemTotalGeral = document.getElementById('resumoTotalGeral');
elemTotalGeral.innerHTML = `
    <div style="font-size: 1.4em; font-weight: bold;">${formatarMoeda(totalGeral)}</div>
    <div style="font-size: 0.9em; margin-top: 5px; color: #155724;">
        Lucro: ${formatarMoeda(lucroTotalGeral)} (${percentualLucroTotalGeral}%)
    </div>
`;

document.getElementById('resumoTotalTrocas').textContent = formatarMoeda(totalTrocas);
    };      
        const abrirModalEdicaoCaixa = (idVenda) => {
            const vendas = getDados(STORAGE_CAIXA);
            const venda = vendas.find(v => v.id === idVenda);
            
            if (!venda) {
                alert('Venda n√£o encontrada.');
                return;
            }

            document.getElementById('editCaixaId').value = venda.id;
            document.getElementById('editCaixaSku').value = venda.sku;
            document.getElementById('editCaixaQtdOriginal').value = venda.quantidade;
            document.getElementById('editCaixaDescricao').textContent = venda.descricao;
            document.getElementById('editCaixaNovaQtd').value = venda.quantidade;
            document.getElementById('editCaixaNovoCliente').value = venda.clienteCpf || venda.clienteNome; // Preenche com CPF ou Nome

            abrirModal('modalEdicaoCaixa');
        };
        
        const formEdicaoCaixa = document.getElementById('formEdicaoCaixa');
        formEdicaoCaixa.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const idVenda = parseInt(document.getElementById('editCaixaId').value);
            const sku = document.getElementById('editCaixaSku').value;
            const qtdOriginal = parseInt(document.getElementById('editCaixaQtdOriginal').value);
            const novaQtd = parseInt(document.getElementById('editCaixaNovaQtd').value);
            const novoCliente = document.getElementById('editCaixaNovoCliente').value.trim();

            const produtos = getDados(STORAGE_PRODUTOS);
            const produto = produtos.find(p => p.sku === sku);
            const vendas = getDados(STORAGE_CAIXA);
            const venda = vendas.find(v => v.id === idVenda);
            
            if (!produto || !venda) {
                alert('Erro: Dados da venda ou produto inconsistentes.');
                return;
            }
            
            const diferencaQtd = novaQtd - qtdOriginal;
            
            // Checa estoque (s√≥ se estiver aumentando a venda)
            if (diferencaQtd > 0 && produto.estoque < diferencaQtd) {
                alert(`Aumento de quantidade n√£o permitido. Estoque restante: ${produto.estoque}`);
                return;
            }
            
            // 1. Atualiza Estoque
            produto.estoque -= diferencaQtd; 
            salvarDados(STORAGE_PRODUTOS, produtos);

            // 2. Atualiza Venda no Caixa
            venda.quantidade = novaQtd;
            venda.valorTotal = novaQtd * venda.valorUnitario;
            
            // Atualiza Cliente
            const clienteCadastrado = buscarClientePorCpf(novoCliente);
            if (clienteCadastrado) {
                 venda.clienteNome = clienteCadastrado.nome;
                 venda.clienteCpf = clienteCadastrado.cpf;
            } else {
                 venda.clienteNome = novoCliente || 'Cliente N√£o Identificado';
                 venda.clienteCpf = limparCpf(novoCliente).length === 11 ? limparCpf(novoCliente) : null;
            }

            // O total da transa√ß√£o em si precisaria ser recalculado se mais de um item fizesse parte dela.
            // Para simplificar, neste caso de edi√ß√£o de item, apenas o valor do item √© atualizado.
            
            salvarDados(STORAGE_CAIXA, vendas);
            
            fecharModal('modalEdicaoCaixa');
            renderizarTabelaCaixa();
            calcularResumosCaixa();
            if (document.getElementById('secao-estoque').style.display === 'block') {
                renderizarTabelaEstoque();
            }
            alert(`Venda ID ${idVenda} ajustada com sucesso!`);
        });

        const estornarTransacao = (transactionId) => {
    if (!confirm(`Tem certeza que deseja ESTORNAR (remover) a transa√ß√£o ID ${transactionId}? Todos os itens ser√£o removidos e o estoque reposto.`)) {
        return;
    }
    
    let vendas = getDados(STORAGE_CAIXA);
    const itensTransacao = vendas.filter(v => v.transactionId === transactionId);
    
    if (itensTransacao.length === 0) {
        alert('Transa√ß√£o n√£o encontrada.');
        return;
    }
    
    const produtos = getDados(STORAGE_PRODUTOS);
    
    // 1. Rep√µe Estoque para TODOS os itens da transa√ß√£o
    itensTransacao.forEach(venda => {
        const produto = produtos.find(p => p.sku === venda.sku);
        if (produto) {
            produto.estoque += venda.quantidade;
        }
    });
    salvarDados(STORAGE_PRODUTOS, produtos);

    // 2. Remove TODAS as linhas da transa√ß√£o do Caixa
    vendas = vendas.filter(v => v.transactionId !== transactionId);
    salvarDados(STORAGE_CAIXA, vendas);
    
    renderizarTabelaCaixa();
    calcularResumosCaixa();
    if (document.getElementById('secao-estoque').style.display === 'block') {
        renderizarTabelaEstoque();
    }
    alert(`Transa√ß√£o ID ${transactionId} estornada com sucesso! Estoque reposto para todos os itens.`);
};

       // --- FUN√á√ïES DE CONSIGNA√á√ÉO ---

const exibirDetalhesProdutoConsignacao = () => {
    const skuInput = document.getElementById('skuConsignacao').value.trim();
    if (skuInput === '') {
        document.getElementById('detalhesConsignacao').innerHTML = '';  // Limpa se vazio
        return;
    }

    const produtos = getDados(STORAGE_PRODUTOS);
    const produto = produtos.find(p => p.sku === skuInput || p.skuFabricante === skuInput);

    if (produto) {
        const descricao = `${produto.sku} - ${produto.marca} ${produto.modelo} ${produto.cor} ${produto.tamanho}`;
        document.getElementById('detalhesConsignacao').innerHTML = `
            <p><strong>SKU do Produto:</strong> ${produto.sku}</p>  <!-- NOVA LINHA ADICIONADA AQUI -->
            <p><strong>Descri√ß√£o:</strong> ${descricao}</p>
            <p><strong>Estoque:</strong> ${produto.estoque}</p>
            <p><strong>Pre√ßo:</strong> ${formatarMoeda(produto.venda)}</p>
        `;
    } else {
        document.getElementById('detalhesConsignacao').innerHTML = '<p style="color: red;">Produto n√£o encontrado!</p>';
    }
};

document.getElementById('formAdicionarItemConsignacao').addEventListener('submit', (e) => {
    e.preventDefault();
    const skuInput = document.getElementById('skuConsignacao').value.trim();
    const produtos = getDados(STORAGE_PRODUTOS);
    const produto = produtos.find(p => p.sku === skuInput || p.skuFabricante === skuInput);

    if (!produto) {
        alert('Produto n√£o encontrado!');
        return;
    }

    if (produto.estoque <= 0) {
    alert(`‚ö†Ô∏è Estoque zerado (${produto.estoque}). Item ser√° adicionado e poder√° ficar negativo.`);
    }

    // Adiciona ao pacote tempor√°rio (quantidade fixa 1 por padr√£o, ou prompt para qtd)
let quantidade = parseInt(prompt('Informe a quantidade:', '1'));
if (isNaN(quantidade)) quantidade = 1;

// Valida quantidade m√≠nima
if (quantidade <= 0) {
    alert('Quantidade inv√°lida! Deve ser maior que zero.');
    return;
}

// Se o estoque for positivo, mant√©m a valida√ß√£o de n√£o permitir quantidade maior que o dispon√≠vel.
// Se o estoque for zero ou negativo, permite (vai ficar negativo no estoque quando finalizar a consigna√ß√£o).
if (produto.estoque > 0 && quantidade > produto.estoque) {
    alert(`Quantidade inv√°lida! Estoque dispon√≠vel: ${produto.estoque}`);
    return;
}

// Opcional: avisar quando vai ficar negativo
if (produto.estoque <= 0 || quantidade > produto.estoque) {
    alert(`‚ö†Ô∏è Aviso: este item tem estoque ${produto.estoque} ‚Äî a consigna√ß√£o poder√° deixar o estoque negativo.`);
}


    // Verifica se h√° remarca√ß√£o de pre√ßo
const precoManualRaw = document.getElementById('precoConsignacaoManual') ? document.getElementById('precoConsignacaoManual').value : '';
const precoManual = parseFloat(precoManualRaw);
const precoFinal = (!isNaN(precoManual) && precoManual > 0) ? precoManual : produto.venda;

pacoteConsignacao.push({
    sku: produto.sku,
    descricao: `${produto.marca} ${produto.modelo} ${produto.cor} ${produto.tamanho}`,
    quantidade,
    valorUnitario: precoFinal,  // ‚Üê AGORA USA O PRE√áO REMARCADO
    dataInclusao: formatarDataIso(new Date()),
    horaInclusao: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
});

renderizarPacoteConsignacao();
document.getElementById('skuConsignacao').value = '';
document.getElementById('precoConsignacaoManual').value = '';  // ‚Üê LIMPA O CAMPO DE REMARCA√á√ÉO

    renderizarPacoteConsignacao();
    document.getElementById('skuConsignacao').value = '';
});

const renderizarPacoteConsignacao = () => {
    const corpoTabela = document.getElementById('corpoTabelaPacoteConsignacao');
    corpoTabela.innerHTML = '';

    let totalGeral = 0;

    pacoteConsignacao.forEach((item, index) => {
        const subtotal = item.valorUnitario * item.quantidade;
        totalGeral += subtotal;

        const linha = corpoTabela.insertRow();
        linha.insertCell().textContent = item.sku + ' - ' + item.descricao;
        linha.insertCell().textContent = item.quantidade;
        linha.insertCell().textContent = formatarMoeda(item.valorUnitario);
        linha.insertCell().textContent = formatarMoeda(subtotal);

        const celulaAcao = linha.insertCell();
        celulaAcao.style.textAlign = 'center';
        
        // Bot√£o Diminuir Quantidade
        const btnMenos = document.createElement('button');
        btnMenos.innerHTML = '<i class="fas fa-minus"></i>';
        btnMenos.className = 'btn-acao btn-small-icon';
        btnMenos.title = 'Diminuir Qtd';
        btnMenos.onclick = () => ajustarQuantidadeConsignacao(index, -1);
        
        // Bot√£o Aumentar Quantidade
        const btnMais = document.createElement('button');
        btnMais.innerHTML = '<i class="fas fa-plus"></i>';
        btnMais.className = 'btn-acao btn-small-icon';
        btnMais.title = 'Aumentar Qtd';
        btnMais.onclick = () => ajustarQuantidadeConsignacao(index, 1);
        
        // Bot√£o Remover
        const btnRemover = document.createElement('button');
        btnRemover.innerHTML = '<i class="fas fa-trash-alt"></i>';
        btnRemover.className = 'btn-remover btn-small-icon';
        btnRemover.title = 'Remover item';
        btnRemover.onclick = () => {
            pacoteConsignacao.splice(index, 1);
            renderizarPacoteConsignacao();
        };
        
        celulaAcao.appendChild(btnMenos);
        celulaAcao.appendChild(btnMais);
        celulaAcao.appendChild(btnRemover);
    });
    // Atualiza o total embaixo da tabela
    document.getElementById('totalPacoteConsignacao').textContent = 
        'R$ ' + formatarMoeda(totalGeral).replace('R$ ', '');
};

// Nova fun√ß√£o para ajustar quantidade no pacote de consigna√ß√£o
const ajustarQuantidadeConsignacao = (index, mudanca) => {
    const item = pacoteConsignacao[index];
    if (!item) return;
    
    const produtos = getDados(STORAGE_PRODUTOS);
    const produtoEstoque = produtos.find(p => p.sku === item.sku);
    
    if (!produtoEstoque) {
        alert('Produto n√£o encontrado no estoque.');
        return;
    }
    
    const novaQuantidade = item.quantidade + mudanca;
    
    // Se a nova quantidade for zero ou negativa, remove o item
    if (novaQuantidade <= 0) {
        if (confirm('Deseja remover este item do pacote?')) {
            pacoteConsignacao.splice(index, 1);
            renderizarPacoteConsignacao();
        }
        return;
    }
    
    // Aviso se estoque for zerado ou negativo (mas permite continuar)
    if (mudanca > 0 && produtoEstoque.estoque <= 0) {
        if (!confirm(`‚ö†Ô∏è Estoque zerado (${produtoEstoque.estoque}). Deseja continuar? O estoque ficar√° negativo.`)) {
            return;
        }
    } else if (mudanca > 0 && novaQuantidade > produtoEstoque.estoque) {
        if (!confirm(`‚ö†Ô∏è Estoque atual: ${produtoEstoque.estoque}. Adicionar ${novaQuantidade} unidades deixar√° o estoque negativo. Continuar?`)) {
            return;
        }
    }
    
    // Atualiza a quantidade (permite ficar negativo)
    item.quantidade = novaQuantidade;
    renderizarPacoteConsignacao();
};

const limparPacoteConsignacao = () => {
    pacoteConsignacao = [];
    renderizarPacoteConsignacao();
    clienteConsignacaoAtual = null;
    document.getElementById('cpfClienteConsignacao').value = '';
    document.getElementById('infoClienteConsignacao').textContent = 'Cliente: N√£o identificado';
    document.getElementById('precoConsignacaoManual').value = '';  // ‚Üê ADICIONE ESTA LINHA
};

const validarClienteConsignacao = () => {
    // Similar a validarClienteVenda()
    const cpfOuNomeInput = document.getElementById('cpfClienteConsignacao').value.trim();
    const infoClienteP = document.getElementById('infoClienteConsignacao');
    const cpfLimpo = limparCpf(cpfOuNomeInput);
    clienteConsignacaoAtual = null;

    if (!cpfLimpo || cpfLimpo.length < 11) {
        infoClienteP.textContent = cpfOuNomeInput.length > 0 ? `Cliente: ${cpfOuNomeInput} (Sem cadastro)` : 'Cliente: N√£o identificado';
        clienteConsignacaoAtual = { nome: cpfOuNomeInput || 'N√£o Identificado', cpf: null };
        return;
    }

    const cliente = buscarClientePorCpf(cpfLimpo);
    if (cliente) {
        infoClienteP.textContent = `Cliente: ${cliente.nome} (CPF: ${formatarCpfVisual(cliente.cpf)})`;
        clienteConsignacaoAtual = cliente;
    } else {
        infoClienteP.textContent = `CPF: ${formatarCpfVisual(cpfLimpo)} - N√ÉO ENCONTRADO!`;
        clienteConsignacaoAtual = { nome: null, cpf: cpfLimpo };
    }
};

const iniciarFinalizacaoConsignacao = () => {
    if (pacoteConsignacao.length === 0) {
        alert('O pacote est√° vazio.');
        return;
    }
    if (!clienteConsignacaoAtual) {
        alert('Selecione um cliente.');
        return;
    }

    // Reduz estoque
    const produtos = getDados(STORAGE_PRODUTOS);
    pacoteConsignacao.forEach(item => {
        const produto = produtos.find(p => p.sku === item.sku);
        if (produto) produto.estoque -= item.quantidade;
    });
    salvarDados(STORAGE_PRODUTOS, produtos);

    // Salva consigna√ß√£o
    const consignacoes = getDados(STORAGE_CONSIGNACOES) || [];
    const data = new Date();
    consignacoes.push({
        id: consignacoes.length + 1,
        cliente: clienteConsignacaoAtual,
        itens: pacoteConsignacao,
        data: formatarDataIso(data),
        timestamp: data.getTime(),
        status: 'pendente'
    });
    salvarDados(STORAGE_CONSIGNACOES, consignacoes);

    // NOVO: Calcula o total da consigna√ß√£o para o recibo
    let totalConsignacao = 0;
    pacoteConsignacao.forEach(item => {
        totalConsignacao += item.valorUnitario * item.quantidade;
    });

    // NOVO: Imprime o recibo similar ao de venda, mas indicando consigna√ß√£o
    imprimirRecibo(pacoteConsignacao, totalConsignacao, clienteConsignacaoAtual.nome || 'N√£o Identificado', 'Consigna√ß√£o');

    limparPacoteConsignacao();
    renderizarTabelaConsignacoes();
    if (document.getElementById('secao-estoque').style.display === 'block') renderizarTabelaEstoque();
    alert('Consigna√ß√£o registrada com sucesso!');
};

const renderizarTabelaConsignacoes = () => {
    const consignacoes = getDados(STORAGE_CONSIGNACOES) || [];
    const corpoTabela = document.getElementById('corpoTabelaConsignacoes');
    corpoTabela.innerHTML = '';

    consignacoes.filter(c => c.status === 'pendente').forEach(cons => {
        const linha = corpoTabela.insertRow();
        linha.insertCell().textContent = cons.id;
        linha.insertCell().textContent = cons.data;
        linha.insertCell().textContent = cons.cliente.nome || `CPF: ${formatarCpfVisual(cons.cliente.cpf)}`;
        // Quantidade total de pe√ßas na consigna√ß√£o
        let totalPecas = 0;
        cons.itens.forEach(item => totalPecas += item.quantidade);
        linha.insertCell().textContent = totalPecas + (totalPecas === 1 ? ' pe√ßa' : ' pe√ßas');
        
        // Status com informa√ß√£o de pagamento parcial
let total = 0;
cons.itens.forEach(item => { total += item.valorUnitario * item.quantidade; });
const valorPago = cons.valorPago || 0;
const valorFalta = total - valorPago;

const celulaStatus = linha.insertCell();
if (valorPago > 0 && valorPago < total) {
    // Pagamento parcial
    celulaStatus.innerHTML = `
        <span style="color: #000000; font-weight: bold;">PENDENTE</span><br>
        <span style="color: #28a745; font-weight: bold;">(Pago: ${formatarMoeda(valorPago)})</span><br>
        <span style="color: #dc3545; font-weight: bold;">(Falta: ${formatarMoeda(valorFalta)})</span>
    `;
} else if (valorPago > 0 && valorPago >= total) {
    // Totalmente pago
    celulaStatus.innerHTML = `
        <span style="color: #28a745; font-weight: bold;">PAGO</span><br>
        <span style="color: #28a745; font-weight: bold;">(Pago: ${formatarMoeda(valorPago)})</span><br>
        <span style="color: #28a745; font-weight: bold;">(Falta: R$ 0,00)</span>
    `;
} else {
    // Sem pagamento ainda
    celulaStatus.innerHTML = `
        <span style="color: #000000; font-weight: bold;">PENDENTE</span><br>
        <span style="color: #888; font-weight: bold;">(Pago: R$ 0,00)</span><br>
        <span style="color: #dc3545; font-weight: bold;">(Falta: ${formatarMoeda(total)})</span>
    `;
}
        
        linha.insertCell().textContent = formatarMoeda(total);

        const celulaAcao = linha.insertCell();
        const btnDetalhes = document.createElement('button');
        btnDetalhes.innerHTML = '<i class="fas fa-eye"></i>';
        btnDetalhes.className = 'btn-acao btn-small-icon';
        btnDetalhes.title = 'Ver detalhes';
        btnDetalhes.onclick = () => abrirModalDetalhesConsignacao(cons);
        celulaAcao.appendChild(btnDetalhes);

        // üÜïüÜïüÜï ADICIONE ESTAS LINHAS AQUI üÜïüÜïüÜï
        const btnReimprimir = document.createElement('button');
        btnReimprimir.innerHTML = '<i class="fas fa-print"></i>';
        btnReimprimir.className = 'btn-acao btn-small-icon';
        btnReimprimir.style.backgroundColor = '#9400d3';
        btnReimprimir.title = 'Reimprimir recibo';
        btnReimprimir.onclick = () => reimprimirReciboConsignacao(cons);
        celulaAcao.appendChild(btnReimprimir);

        // BOT√ÉO EDITAR (novo)
        const btnEditar = document.createElement('button');
        btnEditar.innerHTML = '<i class="fas fa-edit"></i>';
        btnEditar.className = 'btn-acao btn-small-icon';
        btnEditar.style.backgroundColor = '#ffc107';
        btnEditar.style.color = 'black';
        btnEditar.title = 'Editar consigna√ß√£o';
        btnEditar.onclick = () => editarConsignacao(cons.id);
        celulaAcao.appendChild(btnEditar);

        const btnConfirmar = document.createElement('button');
        btnConfirmar.innerHTML = '<i class="fas fa-check"></i>';
        btnConfirmar.className = 'btn-acao btn-small-icon';
        btnConfirmar.title = 'Confirmar como venda';
        btnConfirmar.onclick = () => confirmarVendaConsignacao(cons.id);
        celulaAcao.appendChild(btnConfirmar);

        const btnDevolver = document.createElement('button');
        btnDevolver.innerHTML = '<i class="fas fa-undo"></i>';
        btnDevolver.className = 'btn-remover btn-small-icon';
        btnDevolver.title = 'Devolver tudo ao estoque';
        btnDevolver.onclick = () => devolverConsignacao(cons.id);
        celulaAcao.appendChild(btnDevolver);
    });
};


// FUN√á√ÉO PARA REIMPRIMIR RECIBO DE CONSIGNA√á√ÉO (VERS√ÉO MELHORADA)
const reimprimirReciboConsignacao = (consignacao) => {
    // Calcula o total da consigna√ß√£o
    let totalConsignacao = 0;
    consignacao.itens.forEach(item => {
        totalConsignacao += item.valorUnitario * item.quantidade;
    });
    
    const valorPago = consignacao.valorPago || 0;
    const saldoRestante = totalConsignacao - valorPago;
    
    // ‚úÖ NOVO: Verifica se h√° pagamento parcial
    if (valorPago > 0 && valorPago < totalConsignacao) {
        // Pagamento parcial detectado - mostra op√ß√µes
        const opcao = prompt(
            `üìã REIMPRESS√ÉO DE CONSIGNA√á√ÉO\n\n` +
            `Total da Consigna√ß√£o: ${formatarMoeda(totalConsignacao)}\n` +
            `Valor J√° Pago: ${formatarMoeda(valorPago)}\n` +
            `Saldo Restante: ${formatarMoeda(saldoRestante)}\n\n` +
            `Escolha o tipo de recibo:\n` +
            `1 - Recibo COMPLETO (valor total)\n` +
            `2 - Recibo de PAGAMENTO PARCIAL (apenas o pago)\n` +
            `3 - Cancelar`
        );
        
        if (opcao === '1') {
            // Imprime recibo completo
            imprimirReciboConsignacaoCompleto(consignacao, totalConsignacao);
        } else if (opcao === '2') {
            // Imprime recibo de pagamento parcial
            imprimirReciboPagamentoParcial(consignacao, totalConsignacao, valorPago);
        }
        // Se for 3 ou cancelar, n√£o faz nada
        
    } else {
        // Sem pagamento parcial - imprime recibo normal
        const nomeCliente = consignacao.cliente.nome || 
                           (consignacao.cliente.cpf ? formatarCpfVisual(consignacao.cliente.cpf) : 'N√£o Identificado');
        
        imprimirRecibo(consignacao.itens, totalConsignacao, nomeCliente, 'Consigna√ß√£o');
    }
};

// ‚úÖ NOVA FUN√á√ÉO: Imprime recibo completo da consigna√ß√£o
const imprimirReciboConsignacaoCompleto = (consignacao, totalConsignacao) => {
    const dataAtual = new Date();
    const dataFormatada = formatarDataHoraSegura(dataAtual.getTime());
    const nomeCliente = consignacao.cliente.nome || `CPF: ${formatarCpfVisual(consignacao.cliente.cpf)}`;
    
    // Gera lista de itens
    let itensHTML = '';
    consignacao.itens.forEach(item => {
        const valorTotalItem = item.valorUnitario * item.quantidade;
        itensHTML += `
            <div style="display: flex; justify-content: space-between; font-size: 9pt; margin-bottom: 2px;">
                <span>${item.quantidade}x ${item.sku} ${item.descricao.replace(item.sku, '').trim()}</span>
                <span>${formatarMoeda(valorTotalItem)}</span>
            </div>
        `;
    });
    
    const recibo = `
        <div class="recibo-print-body" style="padding: 10px; margin: 0 auto; background-color: white;">
            <div class="recibo-header" style="text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000;">
                <img src="image_df7b45.jpg" alt="Logo Anjos Kids" style="max-width: 80px; display: block; margin: 0 auto;">
                <h4 style="margin: 5px 0 0 0; font-size: 11pt;">ANJOS KID'S</h4>
                <p style="margin: 0 0 10px 0; font-size: 8pt;">O seu filho merece o melhor!</p>
            </div>
            
            <p style="font-size: 12pt; text-align: center; border-bottom: 1px dashed #000; padding-bottom: 8px; color: #001f3f; font-weight: bold; margin: 10px 0;">
                üìã RECIBO CONSIGNA√á√ÉO 
            </p>

            <div class="recibo-detalhes" style="margin-top: 5px; border-bottom: 1px dashed #000; padding-bottom: 10px;">
                <p style="margin: 2px 0; font-size: 8pt;">Data: ${dataFormatada}</p>
                <p style="margin: 2px 0; font-size: 8pt;">Cliente: ${nomeCliente}</p>
            </div>

            <div class="recibo-itens" style="margin-top: 10px;">
                <h5 style="margin: 0 0 5px 0; font-size: 10pt; text-align: center;">ITENS</h5>
                ${itensHTML}
            </div>

            <div class="recibo-totais" style="margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px;">
                <div style="display: flex; justify-content: space-between; font-size: 11pt; font-weight: bold; color: #001f3f; margin-top: 5px;">
                    <span>TOTAL CONSIGNA√á√ÉO:</span>
                    <span>${formatarMoeda(totalConsignacao)}</span>
                </div>
            </div>
            
            <div class="recibo-pagamento" style="margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; text-align: center;">
                <p style="margin: 2px 0; font-size: 9pt;">Chave Pix: CPF: 355.489.048-09 (Rosangela Camiloti)</p>
                <p style="margin: 5px 0 0 0; font-size: 8pt;">Obrigado pela prefer√™ncia!</p>
            </div>
        </div>
    `;
    
    const printWindow = window.open('', '', 'height=400,width=300');
    printWindow.document.write('<html><head><title>Recibo Consigna√ß√£o</title>');
    const style = document.querySelector('style').textContent;
    printWindow.document.write('<style>' + style + '</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(recibo);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
};

// ABRIR MODAL DE DETALHES DA CONSIGNA√á√ÉO (VERS√ÉO MELHORADA COM RESUMO POR DATA)
const abrirModalDetalhesConsignacao = (cons) => {
    // Busca a consigna√ß√£o original por ID, caso a fun√ß√£o seja chamada com o ID
    let consignacao = cons;
    if (typeof cons === 'number' || typeof cons === 'string') {
        const consignacoes = getDados(STORAGE_CONSIGNACOES) || [];
        consignacao = consignacoes.find(c => c.id == cons);
    }
    if (!consignacao) {
        alert('Consigna√ß√£o n√£o encontrada.');
        return;
    }
    
    consignacaoEmVisualizacao = consignacao;

    document.getElementById('detalhesConsignacaoID').textContent = consignacao.id;
    document.getElementById('detalhesConsignacaoData').textContent = consignacao.data;
    document.getElementById('detalhesConsignacaoCliente').textContent = consignacao.cliente.nome || `CPF: ${formatarCpfVisual(consignacao.cliente.cpf)}`;
    
    // üìÖ NOVO: Agrupa itens por data
    const itensPorData = {};
    consignacao.itens.forEach(item => {
        const dataItem = item.dataInclusao || consignacao.data;
        if (!itensPorData[dataItem]) {
            itensPorData[dataItem] = {
                quantidade: 0,
                valor: 0,
                itens: []
            };
        }
        itensPorData[dataItem].quantidade += item.quantidade;
        itensPorData[dataItem].valor += item.valorUnitario * item.quantidade;
        itensPorData[dataItem].itens.push(item);
    });
    
    // üìÖ NOVO: Renderiza o resumo por data
    const datasOrdenadas = Object.keys(itensPorData).sort();
    let htmlResumo = '<table style="width: 100%; font-size: 0.9em; border-collapse: collapse;">';
    htmlResumo += '<tr style="background-color: #fd7e14; color: white; font-weight: bold;">';
    htmlResumo += '<th style="padding: 8px; text-align: left;">Data</th>';
    htmlResumo += '<th style="padding: 8px; text-align: center;">Pe√ßas</th>';
    htmlResumo += '<th style="padding: 8px; text-align: right;">Valor</th>';
    htmlResumo += '</tr>';
    
    datasOrdenadas.forEach((data, index) => {
        const [ano, mes, dia] = data.split('-');
        const dataFormatada = `${dia}/${mes}/${ano}`;
        const dados = itensPorData[data];
        const corLinha = index % 2 === 0 ? '#fff' : '#f9f9f9';
        
        htmlResumo += `<tr style="background-color: ${corLinha};">`;
        htmlResumo += `<td style="padding: 8px; border: 1px solid #ddd;"><strong>${dataFormatada}</strong></td>`;
        htmlResumo += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${dados.quantidade}</td>`;
        htmlResumo += `<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(dados.valor)}</td>`;
        htmlResumo += '</tr>';
    });
    
    htmlResumo += '</table>';
    document.getElementById('resumoPorDataConsignacao').innerHTML = htmlResumo;
    
    // Renderiza tabela detalhada (c√≥digo original mantido)
    const corpoTabela = document.getElementById('corpoTabelaDetalhesConsignacao');
    corpoTabela.innerHTML = '';
    let totalConsignacao = 0;
    let totalQuantidade = 0;
    
    consignacao.itens.forEach(item => {
        const subtotal = item.valorUnitario * item.quantidade;
        totalConsignacao += subtotal;
        totalQuantidade += item.quantidade;
        
        const linha = corpoTabela.insertRow();
        
        let dataExibicao = consignacao.data;
        if (item.dataInclusao) {
            dataExibicao = item.dataInclusao;
        }
        const [ano, mes, dia] = dataExibicao.split('-');
        let dataHoraTexto = `${dia}/${mes}/${ano}`;
        if (item.horaInclusao) {
            dataHoraTexto += ` ${item.horaInclusao}`;
        }
        
        linha.insertCell().textContent = dataHoraTexto;
        linha.insertCell().textContent = item.sku;
        linha.insertCell().textContent = item.descricao;
        linha.insertCell().textContent = item.quantidade; 
        linha.insertCell().textContent = formatarMoeda(item.valorUnitario);
        linha.insertCell().textContent = formatarMoeda(subtotal);
    });
    
    document.getElementById('totalQtdDetalhesConsignacao').textContent = totalQuantidade;
    document.getElementById('totalDetalhesConsignacao').textContent = formatarMoeda(totalConsignacao);

    const btnImprimir = document.getElementById('btnImprimirDetalhesConsignacao');
    if (btnImprimir) {
        btnImprimir.onclick = () => imprimirDetalhesConsignacao(consignacaoEmVisualizacao);
        btnImprimir.style.display = 'inline-block';
    }
    
    // Hist√≥rico de pagamentos (c√≥digo original mantido)
    const modalContent = document.querySelector('#modalDetalhesConsignacao .modal-content');
    let historicoPagamentosDiv = document.getElementById('historicoPagamentosDiv');
    
    if (!historicoPagamentosDiv) {
        historicoPagamentosDiv = document.createElement('div');
        historicoPagamentosDiv.id = 'historicoPagamentosDiv';
        historicoPagamentosDiv.style.marginTop = '20px';
        historicoPagamentosDiv.style.padding = '15px';
        historicoPagamentosDiv.style.backgroundColor = '#f9f9f9';
        historicoPagamentosDiv.style.borderRadius = '5px';
        modalContent.insertBefore(historicoPagamentosDiv, modalContent.lastElementChild);
    }
    
    if (consignacao.valorPago > 0) {
        const saldoRestante = totalConsignacao - consignacao.valorPago;
        let htmlHistorico = `
            <h4 style="color: #fd7e14; margin-top: 0;">üí∞ Pagamentos Realizados</h4>
            <p style="font-size: 1.1em;">
                <strong>Total Pago:</strong> <span style="color: #28a745;">${formatarMoeda(consignacao.valorPago)}</span><br>
                <strong>Saldo Restante:</strong> <span style="color: ${saldoRestante > 0 ? '#dc3545' : '#28a745'};">${formatarMoeda(saldoRestante)}</span>
            </p>
        `;
        
        if (consignacao.historicoPagamentos && consignacao.historicoPagamentos.length > 0) {
            htmlHistorico += '<h5>Hist√≥rico:</h5><ul style="list-style: none; padding-left: 0;">';
            consignacao.historicoPagamentos.forEach(pag => {
                const [ano, mes, dia] = pag.data.split('-');
                const dataFormatada = `${dia}/${mes}/${ano}`;
                const hora = pag.hora || '';
                htmlHistorico += `<li>üìÖ ${dataFormatada} ${hora} - ${formatarMoeda(pag.valor)}</li>`;
            });
            htmlHistorico += '</ul>';
        }
        
        historicoPagamentosDiv.innerHTML = htmlHistorico;
        historicoPagamentosDiv.style.display = 'block';
    } else {
        historicoPagamentosDiv.style.display = 'none';
    }
    
    document.getElementById('btnIniciarVendaDetalhes').style.display = 'inline-block';
    document.getElementById('modalDetalhesConsignacao').style.display = 'block';

    abrirModal('modalDetalhesConsignacao');
};
const confirmarVendaConsignacao = (id) => {
    const consignacoes = getDados(STORAGE_CONSIGNACOES);
    const cons = consignacoes.find(c => c.id === id);
    if (!cons || cons.status !== 'pendente') return;

    // Calcula total da consigna√ß√£o
    let totalConsignacao = 0;
    cons.itens.forEach(item => {
        totalConsignacao += item.valorUnitario * item.quantidade;
    });

    const valorPago = cons.valorPago || 0;
    const saldoRestante = totalConsignacao - valorPago;

    const opcao = prompt(
        `Total da Consigna√ß√£o: ${formatarMoeda(totalConsignacao)}\n` +
        `J√° Pago: ${formatarMoeda(valorPago)}\n` +
        `Saldo Restante: ${formatarMoeda(saldoRestante)}\n\n` +
        `Digite:\n` +
        `1 - Registrar Pagamento Parcial\n` +
        `2 - Liquidar Total (Confirmar Venda Completa)\n` +
        `3 - Cancelar`
    );

   if (opcao === '1') {
    const valorEntradaStr = prompt(`Informe o valor da entrada/parcial (Saldo: ${formatarMoeda(saldoRestante)}):`);
    const valorEntrada = parseFloat(valorEntradaStr.replace(',', '.'));
    
    if (isNaN(valorEntrada) || valorEntrada <= 0) {
        alert('Valor inv√°lido.');
        return;
    }
    if (valorEntrada > saldoRestante) {
        alert(`Valor maior que o saldo restante (${formatarMoeda(saldoRestante)}).`);
        return;
    }

    cons.valorPago = parseFloat(((cons.valorPago || 0) + valorEntrada).toFixed(2));
        cons.historicoPagamentos = cons.historicoPagamentos || [];
        cons.historicoPagamentos.push({
            data: formatarDataIso(new Date()),
            hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
            valor: valorEntrada,
            timestamp: new Date().getTime()
        });

        salvarDados(STORAGE_CONSIGNACOES, consignacoes);

        // ‚úÖ IMPRIME RECIBO DO PAGAMENTO PARCIAL
        imprimirReciboPagamentoParcial(cons, totalConsignacao, valorEntrada);

        if (cons.valorPago >= totalConsignacao) {
            cons.status = 'confirmada';
            registrarVendaConsignacao(cons, totalConsignacao);
            alert(`Consigna√ß√£o liquidada! Total pago: ${formatarMoeda(cons.valorPago)}`);
        } else {
            alert(`Pagamento parcial de ${formatarMoeda(valorEntrada)} registrado.\nSaldo restante: ${formatarMoeda(totalConsignacao - cons.valorPago)}`);
        }

        renderizarTabelaConsignacoes();

    } else if (opcao === '2') {
        if (!confirm(`Confirmar venda total de ${formatarMoeda(totalConsignacao)}?`)) return;

        cons.valorPago = totalConsignacao;
        cons.status = 'confirmada';
        registrarVendaConsignacao(cons, totalConsignacao);
        
        salvarDados(STORAGE_CONSIGNACOES, consignacoes);
        renderizarTabelaConsignacoes();
        renderizarTabelaCaixa();
        calcularResumosCaixa();
        alert('Venda confirmada e registrada no caixa!');
    }
};

const registrarVendaConsignacao = (cons, totalFinal) => {
    const vendasCaixa = getDados(STORAGE_CAIXA);
    const dataVenda = new Date();
    const transactionId = dataVenda.getTime();

    cons.itens.forEach(item => {
        vendasCaixa.push({
            id: vendasCaixa.length + 1,
            transactionId,
            timestamp: dataVenda.getTime(),
            data: formatarDataIso(dataVenda),
            hora: dataVenda.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
            sku: item.sku,
            descricao: item.descricao,
            quantidade: item.quantidade,
            valorTotal: item.valorUnitario * item.quantidade,
            valorUnitario: item.valorUnitario,
            clienteNome: cons.cliente.nome,
            clienteCpf: cons.cliente.cpf,
            pagamento: 'Consigna√ß√£o Liquidada',  // ‚úÖ ALTERE PARA ISTO
            totalTransacao: totalFinal
        });
    });
    salvarDados(STORAGE_CAIXA, vendasCaixa);

    valorFreteAtual = 0;
    imprimirRecibo(cons.itens, totalFinal, cons.cliente.nome || 'N√£o Identificado', 'Consigna√ß√£o Liquidada');
};

const devolverConsignacao = (id) => {
    if (!confirm('Devolver itens? Isso repor√° o estoque e cancelar√° a consigna√ß√£o.')) return;

    const consignacoes = getDados(STORAGE_CONSIGNACOES);
    const cons = consignacoes.find(c => c.id === id);
    if (!cons || cons.status !== 'pendente') return;

    // Rep√µe estoque
    const produtos = getDados(STORAGE_PRODUTOS);
    cons.itens.forEach(item => {
        const produto = produtos.find(p => p.sku === item.sku);
        if (produto) produto.estoque += item.quantidade;
    });
    salvarDados(STORAGE_PRODUTOS, produtos);

    // Atualiza status
    cons.status = 'devolvida';
    salvarDados(STORAGE_CONSIGNACOES, consignacoes);

    renderizarTabelaConsignacoes();
    if (document.getElementById('secao-estoque').style.display === 'block') renderizarTabelaEstoque();
    alert('Itens devolvidos e estoque reposto!');
};

// ‚úÖ NOVA FUN√á√ÉO: Imprime recibo de pagamento parcial
const imprimirReciboPagamentoParcial = (consignacao, totalConsignacao, valorPagoHoje) => {
    const dataAtual = new Date();
    const dataFormatada = formatarDataHoraSegura(dataAtual.getTime());
    const nomeCliente = consignacao.cliente.nome || `CPF: ${formatarCpfVisual(consignacao.cliente.cpf)}`;
    
    // Calcula saldo restante
    const saldoRestante = totalConsignacao - consignacao.valorPago;
    
    // Gera HTML do hist√≥rico de pagamentos anteriores (se houver)
    let historicoPagamentosHTML = '';
    if (consignacao.historicoPagamentos && consignacao.historicoPagamentos.length > 1) {
        historicoPagamentosHTML = `
            <div style="border-top: 1px dashed #000; margin-top: 10px; padding-top: 10px;">
                <p style="margin: 5px 0; font-size: 9pt; text-align: center;"><strong>Hist√≥rico de Pagamentos:</strong></p>
        `;
        
        // Mostra todos os pagamentos exceto o √∫ltimo (que √© o atual)
        for (let i = 0; i < consignacao.historicoPagamentos.length - 1; i++) {
            const pag = consignacao.historicoPagamentos[i];
            const [ano, mes, dia] = pag.data.split('-');
            const dataFormatadaPag = `${dia}/${mes}/${ano}`;
            
            historicoPagamentosHTML += `
                <p style="margin: 2px 0; font-size: 8pt;">
                    ${dataFormatadaPag} ${pag.hora || ''} - ${formatarMoeda(pag.valor)}
                </p>
            `;
        }
        
        historicoPagamentosHTML += `</div>`;
    }
    
    const reciboHTML = `
        <div class="recibo-print-body" style="padding: 10px; margin: 0 auto; background-color: white;">
            <div class="recibo-header" style="text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000;">
                <img src="image_df7b45.jpg" alt="Logo Anjos Kids" style="max-width: 80px; display: block; margin: 0 auto;">
                <h4 style="margin: 5px 0 0 0; font-size: 11pt;">ANJOS KID'S</h4>
                <p style="margin: 0 0 10px 0; font-size: 8pt;">O seu filho merece o melhor!</p>
            </div>
            
            <p style="font-size: 12pt; text-align: center; border-bottom: 1px dashed #000; padding-bottom: 8px; color: #001f3f; font-weight: bold; margin: 10px 0;">
                RECIBO PAGAMENTO PARCIAL
            </p>

            <div class="recibo-detalhes" style="margin-top: 5px; padding-bottom: 10px;">
                <p style="margin: 2px 0; font-size: 8pt;">Data: ${dataFormatada}</p>
                <p style="margin: 2px 0; font-size: 8pt;">Cliente: ${nomeCliente}</p>
            </div>

            <div style="border-top: 1px dashed #000; margin-top: 10px; padding-top: 10px;">
                <div style="display: flex; justify-content: space-between; font-size: 9pt; margin-bottom: 5px;">
                    <span>Total da Consigna√ß√£o:</span>
                    <span><strong>${formatarMoeda(totalConsignacao)}</strong></span>
                </div>
                
                ${historicoPagamentosHTML}
                
                <div style="border-top: 1px dashed #000; margin-top: 10px; padding-top: 10px;">
                    <div style="display: flex; justify-content: space-between; font-size: 10pt; margin-bottom: 3px;">
                        <span><strong>Valor Pago Hoje (${dataAtual.toLocaleDateString('pt-BR')}):</strong></span>
                        <span style="color: #28a745; font-weight: bold;">${formatarMoeda(valorPagoHoje)}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 9pt; margin-bottom: 3px; color: #666;">
                        <span>Total J√° Pago:</span>
                        <span>${formatarMoeda(consignacao.valorPago)}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 11pt; font-weight: bold; margin-top: 5px; color: ${saldoRestante > 0 ? '#dc3545' : '#28a745'};">
                        <span>Saldo Restante:</span>
                        <span>${formatarMoeda(saldoRestante)}</span>
                    </div>
                </div>
            </div>
            
            <div class="recibo-pagamento" style="margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; text-align: center;">
                <p style="margin: 2px 0; font-size: 9pt;">Chave Pix: CPF: 355.489.048-09 (Rosangela Camiloti)</p>
                <p style="margin: 5px 0 0 0; font-size: 8pt;">Obrigado pela prefer√™ncia!</p>
            </div>
        </div>
    `;
    
    const printWindow = window.open('', '', 'height=400,width=300');
    printWindow.document.write('<html><head><title>Recibo Pagamento</title>');
    const style = document.querySelector('style').textContent;
    printWindow.document.write('<style>' + style + '</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(reciboHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
};

const imprimirDetalhesConsignacao = (consignacao) => {
    if (!consignacao) return;

    let totalConsignacao = 0;
    let totalQuantidade = 0;
    
    // üìÖ NOVO: Agrupa itens por data para o resumo
    const itensPorData = {};
    consignacao.itens.forEach(item => {
        const dataItem = item.dataInclusao || consignacao.data;
        if (!itensPorData[dataItem]) {
            itensPorData[dataItem] = {
                quantidade: 0,
                valor: 0
            };
        }
        itensPorData[dataItem].quantidade += item.quantidade;
        itensPorData[dataItem].valor += item.valorUnitario * item.quantidade;
    });
    
    // üìÖ NOVO: Gera HTML do resumo por data
    const datasOrdenadas = Object.keys(itensPorData).sort();
    let htmlResumoPorData = '';
    
    if (datasOrdenadas.length > 1) { // S√≥ mostra se tiver mais de uma data
        htmlResumoPorData = `
            <div style="background-color: #fff3cd; border: 2px solid #fd7e14; border-radius: 8px; padding: 15px; margin: 20px 0;">
                <h4 style="margin: 0 0 10px 0; color: #fd7e14; text-align: center;">
                    üìÖ Resumo por Data de Inclus√£o
                </h4>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #fd7e14; color: white; font-weight: bold;">
                            <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Data</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Pe√ßas</th>
                            <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        datasOrdenadas.forEach((data, index) => {
            const [ano, mes, dia] = data.split('-');
            const dataFormatada = `${dia}/${mes}/${ano}`;
            const dados = itensPorData[data];
            const corLinha = index % 2 === 0 ? '#fff' : '#f9f9f9';
            
            htmlResumoPorData += `
                <tr style="background-color: ${corLinha};">
                    <td style="padding: 8px; border: 1px solid #ddd;"><strong>${dataFormatada}</strong></td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${dados.quantidade}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(dados.valor)}</td>
                </tr>
            `;
        });
        
        htmlResumoPorData += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    // Gera HTML da tabela detalhada (c√≥digo original)
    let itensHTML = '';
    consignacao.itens.forEach(item => {
        const subtotal = item.valorUnitario * item.quantidade;
        totalConsignacao += subtotal;
        totalQuantidade += item.quantidade;
        
        let dataExibicao = consignacao.data;
        if (item.dataInclusao) {
            const [ano, mes, dia] = item.dataInclusao.split('-');
            dataExibicao = `${dia}/${mes}/${ano}`;
            if (item.horaInclusao) {
                dataExibicao += ` ${item.horaInclusao}`;
            }
        }
        
        itensHTML += `
            <tr>
                <td style="padding: 5px; border: 1px solid #ddd;">${dataExibicao}</td>
                <td style="padding: 5px; border: 1px solid #ddd;">${item.sku}</td>
                <td style="padding: 5px; border: 1px solid #ddd;">${item.descricao}</td>
                <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">${item.quantidade}</td>
                <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.valorUnitario)}</td>
                <td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(subtotal)}</td>
            </tr>
        `;
    });

    // Gera HTML do hist√≥rico de pagamentos (se houver)
    const valorPago = consignacao.valorPago || 0;
    const saldoRestante = totalConsignacao - valorPago;
    
    let pagamentosHTML = '';
    if (valorPago > 0) {
        pagamentosHTML = `
            <div style="margin-top: 20px; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd;">
                <h4 style="margin: 0 0 10px 0;">Situa√ß√£o de Pagamento</h4>
                <p style="margin: 5px 0;"><strong>Total da Consigna√ß√£o:</strong> ${formatarMoeda(totalConsignacao)}</p>
                <p style="margin: 5px 0;"><strong>Valor J√° Pago:</strong> <span style="color: #28a745;">${formatarMoeda(valorPago)}</span></p>
                <p style="margin: 5px 0;"><strong>Saldo Restante:</strong> <span style="color: ${saldoRestante > 0 ? '#dc3545' : '#28a745'};">${formatarMoeda(saldoRestante)}</span></p>
        `;
        
        if (consignacao.historicoPagamentos && consignacao.historicoPagamentos.length > 0) {
            pagamentosHTML += '<h5 style="margin: 10px 0 5px 0;">Hist√≥rico de Pagamentos:</h5><ul style="margin: 0; padding-left: 20px;">';
            consignacao.historicoPagamentos.forEach(pag => {
                const [ano, mes, dia] = pag.data.split('-');
                const dataFormatada = `${dia}/${mes}/${ano}`;
                const hora = pag.hora || '';
                pagamentosHTML += `<li>${dataFormatada} ${hora} - ${formatarMoeda(pag.valor)}</li>`;
            });
            pagamentosHTML += '</ul>';
        }
        
        pagamentosHTML += '</div>';
    }

    // Monta o conte√∫do completo da impress√£o
    const conteudo = `
        <div class="print-report-body">
            <h3>Detalhes da Consigna√ß√£o ID: ${consignacao.id}</h3>
            <p><strong>Cliente:</strong> ${consignacao.cliente.nome || 'N√£o Identificado'}</p>
            <p><strong>CPF:</strong> ${consignacao.cliente.cpf ? formatarCpfVisual(consignacao.cliente.cpf) : 'N/A'}</p>
            <p><strong>Data de Abertura:</strong> ${consignacao.data}</p>

            ${htmlResumoPorData}

            <h4 style="margin-top: 20px;">Itens e Valores (com data de inclus√£o)</h4>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr style="background-color: #f0f8ff;">
                        <th style="padding: 8px; border: 1px solid #ddd;">Data Inclus√£o</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">SKU</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">Descri√ß√£o</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">Qtd</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">Unit. (R$)</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">Subtotal (R$)</th>
                    </tr>
                </thead>
                <tbody>
                    ${itensHTML}
                </tbody>
                <tfoot>
                    <tr style="font-weight: bold; background-color: #e6f7ff;">
                        <td colspan="3" style="padding: 8px; border: 1px solid #ddd; text-align: right;">TOTAL:</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${totalQuantidade}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"></td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #d35400;">${formatarMoeda(totalConsignacao)}</td>
                    </tr>
                </tfoot>
            </table>
            
            ${pagamentosHTML}
        </div>
    `;

    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>Imprimir Consigna√ß√£o</title>');
    const style = document.querySelector('style').textContent;
    printWindow.document.write('<style>' + style + '</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(conteudo);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
};
     // ===============================================
// EDI√á√ÉO DE CONSIGNA√á√ÉO - FUN√á√ïES COMPLETAS
// ===============================================

let consignacaoEmEdicao = null; // Guarda qual consigna√ß√£o estamos editando

const editarConsignacao = (id) => {
    const consignacoes = getDados(STORAGE_CONSIGNACOES) || [];
    const cons = consignacoes.find(c => c.id === id);
    if (!cons || cons.status !== 'pendente') {
        alert('Consigna√ß√£o n√£o encontrada ou j√° finalizada.');
        return;
    }

    if (!confirm('Deseja editar esta consigna√ß√£o?\nO estoque ser√° temporariamente restaurado para permitir altera√ß√µes.')) {
        return;
    }

    // 1. Rep√µe o estoque (para poder editar livremente)
    const produtos = getDados(STORAGE_PRODUTOS);
    cons.itens.forEach(item => {
        const prod = produtos.find(p => p.sku === item.sku);
        if (prod) prod.estoque += item.quantidade;
    });
    salvarDados(STORAGE_PRODUTOS, produtos);

    // 2. Carrega os dados para edi√ß√£o
    consignacaoEmEdicao = cons;
    pacoteConsignacao = JSON.parse(JSON.stringify(cons.itens)); // c√≥pia profunda

    // Preenche cliente
    const inputCpf = document.getElementById('cpfClienteConsignacao');
    if (cons.cliente.cpf) {
        inputCpf.value = formatarCpfVisual(cons.cliente.cpf);
    } else {
        inputCpf.value = cons.cliente.nome || '';
    }
    validarClienteConsignacao();

    // Atualiza tabela do pacote
    renderizarPacoteConsignacao();

    // Muda o bot√£o principal para "Salvar Altera√ß√µes"
    const btnFinalizar = document.querySelector('#secao-consignacao button[onclick="iniciarFinalizacaoConsignacao()"]');
    if (btnFinalizar) {
        btnFinalizar.innerHTML = '<i class="fas fa-save"></i> Salvar Altera√ß√µes';
        btnFinalizar.style.backgroundColor = '#ffc107';
        btnFinalizar.style.color = 'black';
        btnFinalizar.onclick = salvarEdicaoConsignacao;
    }

    // Adiciona bot√£o Cancelar (opcional, mas muito √∫til)
    if (!document.getElementById('btnCancelarEdicao')) {
        const divBotoes = btnFinalizar.parentElement;
        const btnCancelar = document.createElement('button');
        btnCancelar.id = 'btnCancelarEdicao';
        btnCancelar.innerHTML = '<i class="fas fa-times"></i> Cancelar Edi√ß√£o';
        btnCancelar.className = 'btn-remover';
        btnCancelar.style.marginLeft = '10px';
        btnCancelar.onclick = cancelarEdicaoConsignacao;
        divBotoes.appendChild(btnCancelar);
    }

    // Abre a aba de consigna√ß√£o
    mostrarSecao('secao-consignacao', document.querySelector('.btn-consignacao'));
    alert('Consigna√ß√£o carregada para edi√ß√£o!\nAltere os itens e clique em "Salvar Altera√ß√µes".');
};

const salvarEdicaoConsignacao = () => {
    if (pacoteConsignacao.length === 0) {
        alert('O pacote n√£o pode ficar vazio.');
        return;
    }
    if (!clienteConsignacaoAtual) {
        alert('Selecione um cliente v√°lido.');
        return;
    }

    // ‚úÖ REMOVE VALIDA√á√ÉO DE ESTOQUE - PERMITE NEGATIVAR
    const produtos = getDados(STORAGE_PRODUTOS);
    
    // Apenas reduz o estoque sem valida√ß√£o
    pacoteConsignacao.forEach(item => {
        const prod = produtos.find(p => p.sku === item.sku);
        if (prod) {
            prod.estoque -= item.quantidade;
        }
    });
    salvarDados(STORAGE_PRODUTOS, produtos);

    // Atualiza a consigna√ß√£o no storage
    const consignacoes = getDados(STORAGE_CONSIGNACOES);
    const index = consignacoes.findIndex(c => c.id === consignacaoEmEdicao.id);
    if (index !== -1) {
        consignacoes[index].itens = pacoteConsignacao;
        consignacoes[index].cliente = clienteConsignacaoAtual;
        salvarDados(STORAGE_CONSIGNACOES, consignacoes);
    }

    // CORRE√á√ÉO: Calcula o total e imprime o recibo ANTES de limpar
    let totalConsignacao = 0;
    pacoteConsignacao.forEach(item => {
        totalConsignacao += item.valorUnitario * item.quantidade;
    });

    imprimirRecibo(pacoteConsignacao, totalConsignacao, clienteConsignacaoAtual.nome || 'N√£o Identificado', 'Consigna√ß√£o');

    // Atualiza tabelas
    renderizarTabelaConsignacoes();
    if (document.getElementById('secao-estoque').style.display === 'block') renderizarTabelaEstoque();

    // CORRE√á√ÉO: Agora limpa (incluindo zerar o pacote apenas aqui, ap√≥s impress√£o)
    limparEdicaoConsignacao();

    alert('Consigna√ß√£o editada e salva com sucesso!');
};

const cancelarEdicaoConsignacao = () => {
    if (!confirm('Cancelar edi√ß√£o? Todas as altera√ß√µes ser√£o perdidas.')) return;

    // Rep√µe o estoque original
    const produtos = getDados(STORAGE_PRODUTOS);
    consignacaoEmEdicao.itens.forEach(item => {
        const prod = produtos.find(p => p.sku === item.sku);
        if (prod) prod.estoque += item.quantidade;
    });
    salvarDados(STORAGE_PRODUTOS, produtos);

    limparEdicaoConsignacao();
    renderizarTabelaConsignacoes();
    alert('Edi√ß√£o cancelada. Estoque restaurado.');
};

const limparEdicaoConsignacao = () => {
    limparPacoteConsignacao();
    consignacaoEmEdicao = null;

    const btnFinalizar = document.querySelector('#secao-consignacao button[onclick="salvarEdicaoConsignacao()"], #secao-consignacao button[onclick="iniciarFinalizacaoConsignacao()"]');
    if (btnFinalizar) {
        btnFinalizar.innerHTML = '<i class="fas fa-check-circle"></i> Registrar Consigna√ß√£o';
        btnFinalizar.style.backgroundColor = '#fd7e14';
        btnFinalizar.style.color = 'white';
        btnFinalizar.onclick = iniciarFinalizacaoConsignacao;
    }

    const btnCancelar = document.getElementById('btnCancelarEdicao');
    if (btnCancelar) btnCancelar.remove();
};


        // --- FUN√á√ïES DE HIST√ìRICO DE CLIENTE ---
        const abrirModalHistoricoVendas = (cpf) => {
    const cliente = buscarClientePorCpf(cpf);
    if (!cliente) return;

    document.getElementById('historicoClienteNome').textContent = cliente.nome;
    document.getElementById('historicoClienteCpf').textContent = formatarCpfVisual(cliente.cpf);
    
    const vendas = getDados(STORAGE_CAIXA);
    const vendasCliente = vendas.filter(v => v.clienteCpf === cpf);
    
    let totalGasto = 0;
    const tabelaHtml = document.createElement('table');
    tabelaHtml.innerHTML = `
        <thead>
            <tr>
                <th>Data</th>
                <th>Descri√ß√£o</th>
                <th>Qtd</th>
                <th>Valor Total</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    `;
    const corpoTabelaHistorico = tabelaHtml.querySelector('tbody');

    if (vendasCliente.length === 0) {
         corpoTabelaHistorico.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #888;">Nenhuma compra encontrada.</td></tr>';
    } else {
        vendasCliente.forEach(venda => {
            totalGasto += venda.valorTotal;
            const linha = corpoTabelaHistorico.insertRow();
            linha.insertCell().textContent = venda.data;
            linha.insertCell().textContent = venda.sku + ' - ' + venda.descricao;  // <-- Altera√ß√£o aqui: Adiciona SKU antes da descri√ß√£o
            linha.insertCell().textContent = venda.quantidade;
            linha.insertCell().textContent = formatarMoeda(venda.valorTotal);
        });
    }
    
    document.getElementById('historicoTotalGasto').textContent = formatarMoeda(totalGasto);
    document.getElementById('corpoTabelaHistoricoVendas').innerHTML = '';
    document.getElementById('corpoTabelaHistoricoVendas').appendChild(tabelaHtml);

    abrirModal('modalHistoricoVendas');
};

        // --- FUN√á√ïES DE EXPORTA√á√ÉO/IMPORTA√á√ÉO ---
        const exportarDados = () => {
            const dados = {
                produtos: getDados(STORAGE_PRODUTOS),
                clientes: getDados(STORAGE_CLIENTES),
                vendasCaixa: getDados(STORAGE_CAIXA),
                consignacoes: getDados(STORAGE_CONSIGNACOES),   // ‚Üê ADICIONE ISTO
                trocas: getDados(STORAGE_TROCAS)  // ‚¨ÖÔ∏è LINHA ADICIONADA
            };
            const json = JSON.stringify(dados, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_anjoskids_${formatarDataIso(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Dados exportados com sucesso!');
        };

        const importarDados = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const dadosImportados = JSON.parse(e.target.result);
                    
                    if (dadosImportados.produtos && dadosImportados.clientes && dadosImportados.vendasCaixa) {
                        if (confirm('Aten√ß√£o: A importa√ß√£o ir√° SOBRESCREVER todos os dados atuais (Produtos, Clientes, Vendas). Deseja continuar?')) {
                            salvarDados(STORAGE_PRODUTOS, dadosImportados.produtos);
                            salvarDados(STORAGE_CLIENTES, dadosImportados.clientes);
                            salvarDados(STORAGE_CAIXA, dadosImportados.vendasCaixa);
                            salvarDados(STORAGE_CONSIGNACOES, dadosImportados.consignacoes || []); // ‚Üê ADICIONE ISTO
                            salvarDados(STORAGE_TROCAS, dadosImportados.trocas || []); // ‚¨ÖÔ∏è LINHA ADICIONADA
                            
                            // Tenta re-renderizar as tabelas
                            renderizarTabelaEstoque();
                            renderizarTabelaClientes();
                            renderizarTabelaCaixa();
                            renderizarTabelaConsignacoes();
                            
                            alert('Dados importados com sucesso! O sistema foi recarregado.');
                        }
                    } else {
                        alert('Erro: O arquivo JSON n√£o cont√©m a estrutura de dados esperada (produtos, clientes, vendasCaixa).');
                    }
                } catch (error) {
                    alert('Erro ao processar o arquivo JSON. Verifique se o formato est√° correto.');
                    console.error('Erro de importa√ß√£o:', error);
                }
            };
            reader.readAsText(file);
        };
        
        // ----------------------------------------------------------------------------

        // ===============================================
// SISTEMA DE TROCAS/DEVOLU√á√ïES - FUN√á√ïES
// ===============================================

let produtoEmTroca = null; // Produto sendo adicionado nos novos produtos

// Fun√ß√£o para iniciar o fluxo de troca
const iniciarFluxoTroca = () => {
    // Limpa vari√°veis globais
    clienteTrocaAtual = null;
    produtosDevolvidos = [];
    produtosNovos = [];
    produtoEmTroca = null;
    
    // Limpa campos
    document.getElementById('cpfClienteTroca').value = '';
    document.getElementById('infoClienteTroca').textContent = 'Cliente: N√£o identificado';
    document.getElementById('corpoTabelaHistoricoTroca').innerHTML = '';
    document.getElementById('listaProdutosDevolucao').innerHTML = '<p style="color: #888; text-align: center;">Nenhum produto selecionado</p>';
    document.getElementById('listaProdutosNovos').innerHTML = '<p style="color: #888; text-align: center;">Nenhum produto adicionado</p>';
    
    // Esconde etapas 2 e 3
    document.getElementById('etapaTrocaDevolucao').style.display = 'none';
    document.getElementById('etapaTrocaNovos').style.display = 'none';
    
    // Atualiza totais
    atualizarTotaisTroca();
    
    // Abre o modal
    abrirModal('modalTroca');
};

// Valida√ß√£o do cliente na troca
const validarClienteTroca = () => {
    const cpfOuNomeInput = document.getElementById('cpfClienteTroca').value.trim();
    const infoClienteP = document.getElementById('infoClienteTroca');
    const cpfLimpo = limparCpf(cpfOuNomeInput);
    
    clienteTrocaAtual = null;
    document.getElementById('etapaTrocaDevolucao').style.display = 'none';
    document.getElementById('etapaTrocaNovos').style.display = 'none';
    
    if (!cpfLimpo || cpfLimpo.length < 11) {
        infoClienteP.textContent = cpfOuNomeInput.length > 0 
            ? `Cliente: ${cpfOuNomeInput} (Sem cadastro)` 
            : 'Cliente: N√£o identificado';
        return;
    }
    
    const cliente = buscarClientePorCpf(cpfLimpo);
    
    if (cliente) {
        clienteTrocaAtual = cliente;
        infoClienteP.textContent = `Cliente: ${cliente.nome} (CPF: ${formatarCpfVisual(cliente.cpf)})`;
        infoClienteP.style.color = '#28a745';
        
        // Carrega hist√≥rico de compras
        carregarHistoricoParaTroca(cliente.cpf);
        
        // Mostra etapas 2 e 3
        document.getElementById('etapaTrocaDevolucao').style.display = 'block';
        document.getElementById('etapaTrocaNovos').style.display = 'block';
    } else {
        infoClienteP.textContent = `CPF: ${formatarCpfVisual(cpfLimpo)} - N√ÉO ENCONTRADO!`;
        infoClienteP.style.color = '#dc3545';
    }
};

// Carrega hist√≥rico de compras do cliente para sele√ß√£o
const carregarHistoricoParaTroca = (cpf) => {
    const vendas = getDados(STORAGE_CAIXA);
    const vendasCliente = vendas.filter(v => v.clienteCpf === cpf);
    const corpoTabela = document.getElementById('corpoTabelaHistoricoTroca');
    
    corpoTabela.innerHTML = '';
    
    if (vendasCliente.length === 0) {
        corpoTabela.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">Nenhuma compra encontrada para este cliente.</td></tr>';
        return;
    }
    
    // Agrupa por transactionId para evitar duplicatas
    const transacoesProcessadas = new Set();
    
    vendasCliente.forEach(venda => {
        // Evita duplicatas
        const chaveUnica = `${venda.transactionId || venda.id}_${venda.sku}`;
        if (transacoesProcessadas.has(chaveUnica)) return;
        transacoesProcessadas.add(chaveUnica);
        
        const linha = corpoTabela.insertRow();
        linha.insertCell().textContent = venda.data;
        linha.insertCell().textContent = venda.sku;
        linha.insertCell().textContent = venda.descricao;
        linha.insertCell().textContent = venda.quantidade;
        linha.insertCell().textContent = formatarMoeda(venda.valorUnitario);
        linha.insertCell().textContent = formatarMoeda(venda.valorTotal);
        
        // Bot√£o para adicionar √† devolu√ß√£o
        const celulaAcao = linha.insertCell();
        const btnAdicionar = document.createElement('button');
        btnAdicionar.innerHTML = '<i class="fas fa-undo"></i> Devolver';
        btnAdicionar.className = 'btn-acao btn-small-icon';
        btnAdicionar.style.backgroundColor = '#dc3545';
        btnAdicionar.onclick = () => adicionarProdutoDevolucao(venda);
        celulaAcao.appendChild(btnAdicionar);
    });
};

// Adiciona produto √† lista de devolu√ß√£o
const adicionarProdutoDevolucao = (venda) => {
    const qtd = parseInt(prompt(`Quantidade a devolver (m√°x: ${venda.quantidade}):`, venda.quantidade));
    
    if (isNaN(qtd) || qtd <= 0) {
        alert('Quantidade inv√°lida!');
        return;
    }
    
    if (qtd > venda.quantidade) {
        alert(`Quantidade m√°xima: ${venda.quantidade}`);
        return;
    }
    
    // Verifica se o produto j√° foi adicionado
    const jaAdicionado = produtosDevolvidos.find(p => 
        p.sku === venda.sku && p.transactionId === venda.transactionId
    );
    
    if (jaAdicionado) {
        alert('Este produto j√° foi adicionado √† devolu√ß√£o!');
        return;
    }
    
    produtosDevolvidos.push({
        sku: venda.sku,
        descricao: venda.descricao,
        quantidade: qtd,
        valorUnitario: venda.valorUnitario,
        valorTotal: venda.valorUnitario * qtd,
        transactionId: venda.transactionId,
        dataOriginal: venda.data
    });
    
    renderizarListaDevolucao();
    atualizarTotaisTroca();
};

// Renderiza a lista de produtos devolvidos
const renderizarListaDevolucao = () => {
    const lista = document.getElementById('listaProdutosDevolucao');
    
    if (produtosDevolvidos.length === 0) {
        lista.innerHTML = '<p style="color: #888; text-align: center;">Nenhum produto selecionado</p>';
        return;
    }
    
    let html = '<table style="width: 100%; font-size: 0.9em;"><tbody>';
    
    produtosDevolvidos.forEach((prod, index) => {
        html += `
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 8px;">${prod.sku} - ${prod.descricao}</td>
                <td style="padding: 8px; text-align: center;">Qtd: ${prod.quantidade}</td>
                <td style="padding: 8px; text-align: right;">${formatarMoeda(prod.valorTotal)}</td>
                <td style="padding: 8px; text-align: center;">
                    <button onclick="removerProdutoDevolucao(${index})" class="btn-remover btn-small-icon">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    lista.innerHTML = html;
};

// Remove produto da lista de devolu√ß√£o
const removerProdutoDevolucao = (index) => {
    produtosDevolvidos.splice(index, 1);
    renderizarListaDevolucao();
    atualizarTotaisTroca();
};

// Exibe detalhes do produto sendo adicionado aos novos produtos
const exibirDetalhesProdutoTroca = () => {
    const skuInput = document.getElementById('skuTroca').value.trim();
    const form = document.getElementById('formAdicionarProdutoTroca');
    
    if (skuInput.length < 3) {
        form.style.border = 'none';
        produtoEmTroca = null;
        return;
    }
    
    const produto = buscarProdutoPorSku(skuInput);
    
    if (produto) {
        form.style.border = '3px solid #28a745';
        produtoEmTroca = produto;
    } else {
        form.style.border = '3px solid #dc3545';
        produtoEmTroca = null;
    }
};

// Adiciona produto aos novos produtos da troca
document.getElementById('formAdicionarProdutoTroca').addEventListener('submit', (e) => {
    e.preventDefault();
    
    if (!produtoEmTroca) {
        alert('Produto n√£o encontrado!');
        return;
    }
    
    const qtd = parseInt(prompt('Quantidade:', '1'));
    
    if (isNaN(qtd) || qtd <= 0) {
        alert('Quantidade inv√°lida!');
        return;
    }
    
    // ‚úÖ PERMITE NEGATIVAR O ESTOQUE
    if (produtoEmTroca.estoque <= 0) {
        if (!confirm(`‚ö†Ô∏è Estoque zerado (${produtoEmTroca.estoque}). O produto ser√° adicionado e o estoque ficar√° negativo. Continuar?`)) {
            return;
        }
    } else if (qtd > produtoEmTroca.estoque) {
        if (!confirm(`‚ö†Ô∏è Estoque atual: ${produtoEmTroca.estoque}. Adicionar ${qtd} unidades deixar√° o estoque negativo. Continuar?`)) {
            return;
        }
    }
    
    produtosNovos.push({
        sku: produtoEmTroca.sku,
        descricao: `${produtoEmTroca.marca} ${produtoEmTroca.modelo} ${produtoEmTroca.cor} ${produtoEmTroca.tamanho}`,
        quantidade: qtd,
        valorUnitario: produtoEmTroca.venda,
        valorTotal: produtoEmTroca.venda * qtd
    });
    
    document.getElementById('skuTroca').value = '';
    document.getElementById('formAdicionarProdutoTroca').style.border = 'none';
    produtoEmTroca = null;
    
    renderizarListaNovos();
    atualizarTotaisTroca();
});

// Renderiza a lista de novos produtos
const renderizarListaNovos = () => {
    const lista = document.getElementById('listaProdutosNovos');
    
    if (produtosNovos.length === 0) {
        lista.innerHTML = '<p style="color: #888; text-align: center;">Nenhum produto adicionado</p>';
        return;
    }
    
    let html = '<table style="width: 100%; font-size: 0.9em;"><tbody>';
    
    produtosNovos.forEach((prod, index) => {
        html += `
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 8px;">${prod.sku} - ${prod.descricao}</td>
                <td style="padding: 8px; text-align: center;">Qtd: ${prod.quantidade}</td>
                <td style="padding: 8px; text-align: right;">${formatarMoeda(prod.valorTotal)}</td>
                <td style="padding: 8px; text-align: center;">
                    <button onclick="removerProdutoNovo(${index})" class="btn-remover btn-small-icon">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    lista.innerHTML = html;
};

// Remove produto da lista de novos
const removerProdutoNovo = (index) => {
    produtosNovos.splice(index, 1);
    renderizarListaNovos();
    atualizarTotaisTroca();
};

// Atualiza os totais da troca
const atualizarTotaisTroca = () => {
    let totalDevolucao = 0;
    let totalNovos = 0;
    
    produtosDevolvidos.forEach(p => totalDevolucao += p.valorTotal);
    produtosNovos.forEach(p => totalNovos += p.valorTotal);
    
    const diferenca = totalNovos - totalDevolucao;
    
    // Atualiza displays
    document.getElementById('totalDevolucao').textContent = formatarMoeda(totalDevolucao);
    document.getElementById('totalNovos').textContent = formatarMoeda(totalNovos);
    document.getElementById('resumoTotalDevolucao').textContent = formatarMoeda(totalDevolucao);
    document.getElementById('resumoTotalNovos').textContent = formatarMoeda(totalNovos);
    
    const elemDiferenca = document.getElementById('resumoDiferenca');
    if (diferenca > 0) {
        elemDiferenca.innerHTML = `Diferen√ßa a PAGAR: <span style="color: #dc3545;">${formatarMoeda(diferenca)}</span>`;
    } else if (diferenca < 0) {
        elemDiferenca.innerHTML = `Diferen√ßa a DEVOLVER: <span style="color: #28a745;">${formatarMoeda(Math.abs(diferenca))}</span>`;
    } else {
        elemDiferenca.innerHTML = `<span style="color: #28a745;">‚úÖ Troca ZERADA</span>`;
    }
};

// Finaliza a troca
const finalizarTroca = () => {
    // Valida√ß√µes
    if (!clienteTrocaAtual) {
        alert('Selecione um cliente!');
        return;
    }
    
    if (produtosDevolvidos.length === 0) {
        alert('Adicione pelo menos um produto para devolu√ß√£o!');
        return;
    }
    
    if (produtosNovos.length === 0) {
        alert('Adicione pelo menos um novo produto!');
        return;
    }
    
    let totalDevolucao = 0;
    let totalNovos = 0;
    produtosDevolvidos.forEach(p => totalDevolucao += p.valorTotal);
    produtosNovos.forEach(p => totalNovos += p.valorTotal);
    
    const diferenca = totalNovos - totalDevolucao;
    
    let mensagemConfirmacao = `Confirmar troca?\n\n`;
    mensagemConfirmacao += `Cliente: ${clienteTrocaAtual.nome}\n`;
    mensagemConfirmacao += `Total Devolvido: ${formatarMoeda(totalDevolucao)}\n`;
    mensagemConfirmacao += `Total Novos Produtos: ${formatarMoeda(totalNovos)}\n\n`;
    
    if (diferenca > 0) {
        mensagemConfirmacao += `‚ö†Ô∏è Cliente deve pagar: ${formatarMoeda(diferenca)}`;
    } else if (diferenca < 0) {
        mensagemConfirmacao += `‚ö†Ô∏è Devolver ao cliente: ${formatarMoeda(Math.abs(diferenca))}`;
    } else {
        mensagemConfirmacao += `‚úÖ Troca zerada (valores iguais)`;
    }
    
    if (!confirm(mensagemConfirmacao)) return;
    
    // Executa a troca
    processarTroca(diferenca);
};

// ===============================================
// PROCESSA A TROCA COM REGISTRO COMPLETO
// ===============================================
const processarTroca = (diferenca) => {
    const produtos = getDados(STORAGE_PRODUTOS);
    const dataAtual = new Date();
    const transactionId = dataAtual.getTime();
    
    // 1. Rep√µe estoque dos produtos devolvidos
    produtosDevolvidos.forEach(itemDev => {
        const produto = produtos.find(p => p.sku === itemDev.sku);
        if (produto) {
            produto.estoque += itemDev.quantidade;
        }
    });
    
    // 2. Reduz estoque dos novos produtos
    produtosNovos.forEach(itemNovo => {
        const produto = produtos.find(p => p.sku === itemNovo.sku);
        if (produto) {
            produto.estoque -= itemNovo.quantidade;
        }
    });
    
    salvarDados(STORAGE_PRODUTOS, produtos);
    
    // 3. Registra a troca no storage de trocas (para hist√≥rico separado)
    const trocas = getDados(STORAGE_TROCAS) || [];
    trocas.push({
        id: trocas.length + 1,
        transactionId,
        timestamp: dataAtual.getTime(),
        data: formatarDataIso(dataAtual),
        hora: dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
        clienteNome: clienteTrocaAtual.nome,
        clienteCpf: clienteTrocaAtual.cpf,
        produtosDevolvidos: JSON.parse(JSON.stringify(produtosDevolvidos)),
        produtosNovos: JSON.parse(JSON.stringify(produtosNovos)),
        diferenca: diferenca,
        status: 'finalizada'
    });
    salvarDados(STORAGE_TROCAS, trocas);
    
    // 4. ‚ú® NOVO: Registra a troca no hist√≥rico de vendas (STORAGE_CAIXA)
    const vendasCaixa = getDados(STORAGE_CAIXA);
    
    // 4.1. Registra produtos DEVOLVIDOS (com quantidade e valor NEGATIVOS)
    produtosDevolvidos.forEach(itemDev => {
        vendasCaixa.push({
            id: vendasCaixa.length + 1,
            transactionId: transactionId,
            timestamp: dataAtual.getTime(),
            data: formatarDataIso(dataAtual),
            hora: dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
            sku: itemDev.sku,
            descricao: `üîÑ TROCA - DEVOLU√á√ÉO: ${itemDev.descricao}`,
            quantidade: -itemDev.quantidade, // ‚ùó NEGATIVO para devolu√ß√£o
            valorTotal: -itemDev.valorTotal, // ‚ùó NEGATIVO
            valorUnitario: itemDev.valorUnitario,
            clienteNome: clienteTrocaAtual.nome,
            clienteCpf: clienteTrocaAtual.cpf,
            pagamento: 'TROCA - Devolu√ß√£o',
            totalTransacao: -itemDev.valorTotal,
            tipoMovimento: 'troca_devolucao' // üè∑Ô∏è Flag de identifica√ß√£o
        });
    });
    
    // 4.2. Registra produtos NOVOS (com valores POSITIVOS)
    produtosNovos.forEach(itemNovo => {
        vendasCaixa.push({
            id: vendasCaixa.length + 1,
            transactionId: transactionId,
            timestamp: dataAtual.getTime(),
            data: formatarDataIso(dataAtual),
            hora: dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
            sku: itemNovo.sku,
            descricao: `üîÑ TROCA - NOVO PRODUTO: ${itemNovo.descricao}`,
            quantidade: itemNovo.quantidade,
            valorTotal: itemNovo.valorTotal,
            valorUnitario: itemNovo.valorUnitario,
            clienteNome: clienteTrocaAtual.nome,
            clienteCpf: clienteTrocaAtual.cpf,
            pagamento: 'TROCA - Novo Produto',
            totalTransacao: itemNovo.valorTotal,
            tipoMovimento: 'troca_novo' // üè∑Ô∏è Flag de identifica√ß√£o
        });
    });
    
    // 4.3. Se houver diferen√ßa, registra como item separado
    if (diferenca !== 0) {
    vendasCaixa.push({
        id: vendasCaixa.length + 1,
        transactionId: transactionId,
        timestamp: dataAtual.getTime(),
        data: formatarDataIso(dataAtual),
        hora: dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
        sku: 'TROCA-DIF',
        descricao: diferenca > 0 ? 
            `üîÑ TROCA - Diferen√ßa Paga pelo Cliente` : 
            `üîÑ TROCA - Diferen√ßa Devolvida ao Cliente`,
        quantidade: 1,
        valorTotal: diferenca,
        valorUnitario: diferenca,
        clienteNome: clienteTrocaAtual.nome,
        clienteCpf: clienteTrocaAtual.cpf,
        pagamento: diferenca > 0 ? 'TROCA - Diferen√ßa Recebida' : 'TROCA - Diferen√ßa Devolvida',
        totalTransacao: diferenca,
        tipoMovimento: 'troca_diferenca' // üè∑Ô∏è Flag de identifica√ß√£o
    });
}
    
    salvarDados(STORAGE_CAIXA, vendasCaixa);
    
    // 5. Imprime recibo
    imprimirReciboTroca(produtosDevolvidos, produtosNovos, diferenca, clienteTrocaAtual.nome);
    
    // 6. Limpa e fecha
    fecharModal('modalTroca');
    alert(`‚úÖ Troca finalizada e registrada com sucesso!${diferenca !== 0 ? '\n\nDiferen√ßa: ' + formatarMoeda(Math.abs(diferenca)) : '\n\nüí° Agora a troca aparece no Relat√≥rio de Vendas e no Kardex!'}`);
    
    // 7. Atualiza tabelas
    if (document.getElementById('secao-estoque').style.display === 'block') {
        renderizarTabelaEstoque();
    }
    renderizarTabelaCaixa();
    calcularResumosCaixa();
};

// Cancela a troca
const cancelarTroca = () => {
    if (produtosDevolvidos.length > 0 || produtosNovos.length > 0) {
        if (!confirm('Cancelar troca? Todos os dados ser√£o perdidos.')) {
            return;
        }
    }
    
    // üÜï Remove classe especial se existir
    const modalClientes = document.getElementById('modalSelecaoCliente');
    if (modalClientes) {
        modalClientes.classList.remove('modal-sobreposto');
    }
    
    fecharModal('modalTroca');
};

// Fun√ß√£o para abrir modal de sele√ß√£o de cliente para troca
const abrirModalSelecaoClienteParaTroca = () => {
    renderizarTabelaClientesModalParaTroca();
    abrirModal('modalSelecaoCliente');
};

// üÜï NOVA FUN√á√ÉO: Abre modal de clientes COM z-index maior
const abrirModalSelecaoClienteParaTrocaMelhorado = () => {
    renderizarTabelaClientesModalParaTroca();
    
    // Adiciona classe especial para z-index maior
    const modalClientes = document.getElementById('modalSelecaoCliente');
    modalClientes.classList.add('modal-sobreposto');
    
    abrirModal('modalSelecaoCliente');
};

// Renderiza tabela de clientes para sele√ß√£o na troca
const renderizarTabelaClientesModalParaTroca = () => {
    const clientes = getDados(STORAGE_CLIENTES);
    const corpoTabela = document.getElementById('corpoTabelaClientesModal');
    corpoTabela.innerHTML = '';
    
    clientes.forEach(cliente => {
        const linha = corpoTabela.insertRow();
        linha.insertCell().textContent = cliente.nome;
        linha.insertCell().textContent = formatarCpfVisual(cliente.cpf);
        linha.insertCell().textContent = cliente.telefone;
        
        const celulaAcao = linha.insertCell();
        const btnSelecionar = document.createElement('button');
        btnSelecionar.innerHTML = '<i class="fas fa-check"></i> Selecionar';
        btnSelecionar.className = 'btn-acao';
        btnSelecionar.onclick = () => selecionarClienteParaTroca(cliente);
        celulaAcao.appendChild(btnSelecionar);
    });
};

// Seleciona cliente para troca (VERS√ÉO MELHORADA)
const selecionarClienteParaTroca = (cliente) => {
    // Preenche o campo
    document.getElementById('cpfClienteTroca').value = formatarCpfVisual(cliente.cpf);
    
    // Valida e carrega hist√≥rico
    validarClienteTroca();
    
    // Remove a classe especial antes de fechar
    const modalClientes = document.getElementById('modalSelecaoCliente');
    modalClientes.classList.remove('modal-sobreposto');
    
    // Fecha o modal
    fecharModal('modalSelecaoCliente');
    
    // üÜï DESTAQUE VISUAL: Scroll suave para a etapa 2
    setTimeout(() => {
        const etapa2 = document.getElementById('etapaTrocaDevolucao');
        if (etapa2 && etapa2.style.display !== 'none') {
            etapa2.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Efeito visual de destaque
            etapa2.style.animation = 'pulse 0.5s ease-in-out';
            setTimeout(() => {
                etapa2.style.animation = '';
            }, 500);
        }
    }, 300);
};

// Gera e imprime recibo de troca
const imprimirReciboTroca = (produtosDev, produtosNov, diferenca, nomeCliente) => {
    const dataAtual = formatarDataHoraSegura(new Date().getTime());
    
    let totalDevolucao = 0;
    let totalNovos = 0;
    
    produtosDev.forEach(p => totalDevolucao += p.valorTotal);
    produtosNov.forEach(p => totalNovos += p.valorTotal);
    
    // Produtos devolvidos
    let htmlDevolvidos = '';
    produtosDev.forEach(item => {
        htmlDevolvidos += `
            <div style="display: flex; justify-content: space-between; font-size: 9pt; margin-bottom: 2px; color: #dc3545;">
                <span>${item.quantidade}x ${item.sku} ${item.descricao.replace(item.sku, '').trim()}</span>
                <span>-${formatarMoeda(item.valorTotal)}</span>
            </div>
        `;
    });
    
    // Produtos novos
    let htmlNovos = '';
    produtosNov.forEach(item => {
        htmlNovos += `
            <div style="display: flex; justify-content: space-between; font-size: 9pt; margin-bottom: 2px; color: #28a745;">
                <span>${item.quantidade}x ${item.sku} ${item.descricao.replace(item.sku, '').trim()}</span>
                <span>+${formatarMoeda(item.valorTotal)}</span>
            </div>
        `;
    });
    
    let htmlDiferenca = '';
    if (diferenca > 0) {
        htmlDiferenca = `
            <div style="display: flex; justify-content: space-between; font-size: 11pt; font-weight: bold; color: #dc3545; margin-top: 5px;">
                <span>DIFEREN√áA A PAGAR:</span>
                <span>${formatarMoeda(diferenca)}</span>
            </div>
        `;
    } else if (diferenca < 0) {
        htmlDiferenca = `
            <div style="display: flex; justify-content: space-between; font-size: 11pt; font-weight: bold; color: #28a745; margin-top: 5px;">
                <span>DIFEREN√áA A DEVOLVER:</span>
                <span>${formatarMoeda(Math.abs(diferenca))}</span>
            </div>
        `;
    } else {
        htmlDiferenca = `
            <div style="text-align: center; font-size: 11pt; font-weight: bold; color: #3a7bd5; margin-top: 5px;">
                ‚úÖ TROCA ZERADA
            </div>
        `;
    }
    
    const recibo = `
        <div class="recibo-print-body" style="padding: 10px; margin: 0 auto; background-color: white;">
            <div class="recibo-header" style="text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000;">
                <img src="image_df7b45.jpg" alt="Logo Anjos Kids" style="max-width: 80px; display: block; margin: 0 auto;">
                <h4 style="margin: 5px 0 0 0; font-size: 11pt;">ANJOS KID'S</h4>
                <p style="margin: 0 0 10px 0; font-size: 8pt;">O seu filho merece o melhor!</p>
            </div>
            
            <p style="font-size: 12pt; text-align: center; border-bottom: 1px dashed #000; padding-bottom: 8px; color: #ff8c00; font-weight: bold; margin: 10px 0;">
                üîÑ COMPROVANTE DE TROCA
            </p>
            
            <div class="recibo-detalhes" style="margin-top: 5px; border-bottom: 1px dashed #000; padding-bottom: 10px;">
                <p style="margin: 2px 0; font-size: 8pt;">Data: ${dataAtual}</p>
                <p style="margin: 2px 0; font-size: 8pt;">Cliente: ${nomeCliente}</p>
            </div>
            
            <div style="margin-top: 10px; border-bottom: 1px dashed #000; padding-bottom: 10px;">
                <h5 style="margin: 0 0 5px 0; font-size: 10pt; color: #dc3545; text-align: center;">
                    üì• PRODUTOS DEVOLVIDOS
                </h5>
                ${htmlDevolvidos}
                <div style="text-align: right; font-weight: bold; margin-top: 5px; color: #dc3545;">
                    Subtotal: ${formatarMoeda(totalDevolucao)}
                </div>
            </div>
            
            <div style="margin-top: 10px; border-bottom: 1px dashed #000; padding-bottom: 10px;">
                <h5 style="margin: 0 0 5px 0; font-size: 10pt; color: #28a745; text-align: center;">
                    üì§ NOVOS PRODUTOS
                </h5>
                ${htmlNovos}
                <div style="text-align: right; font-weight: bold; margin-top: 5px; color: #28a745;">
                    Subtotal: ${formatarMoeda(totalNovos)}
                </div>
            </div>
            
            <div class="recibo-totais" style="margin-top: 10px; padding-top: 5px;">
                ${htmlDiferenca}
            </div>
            
            <div class="recibo-pagamento" style="margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; text-align: center;">
                <p style="margin: 2px 0; font-size: 9pt;">Chave Pix: CPF: 355.489.048-09 (Rosangela Camiloti)</p>
                <p style="margin: 5px 0 0 0; font-size: 8pt;">Obrigado pela prefer√™ncia!</p>
            </div>
        </div>
    `;
    
    const printWindow = window.open('', '', 'height=400,width=300');
    printWindow.document.write('<html><head><title>Recibo Troca</title>');
    const style = document.querySelector('style').textContent;
    printWindow.document.write('<style>' + style + '</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(recibo);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
};

// FIM DO SISTEMA DE TROCAS
        
        // --- INICIALIZA√á√ÉO ---

        // Configura a se√ß√£o inicial
        document.addEventListener('DOMContentLoaded', () => {
            // Tenta ativar a primeira se√ß√£o por padr√£o (Iniciar Venda)
            const primeiroBotao = document.getElementById('btn-venda');
            if (primeiroBotao) {
                 mostrarSecao('secao-venda', primeiroBotao);
       
     } else {
                 // Se o bot√£o de venda n√£o existir, mostra o primeiro bot√£o do menu e sua se√ß√£o.
                 const anyButton = document.querySelector('.menu button');
                 if(anyButton) {
                    anyButton.classList.add('ativo');
                    const targetSectionId = anyButton.getAttribute('onclick').match(/mostrarSecao\('([^']*)'/)[1];
                    document.getElementById(targetSectionId).style.display = 'block';
                 }
            }
            
            // Renderiza o carrinho se houver dados salvos
            renderizarCarrinho();
            renderizarTabelaConsignacoes();
        });

// --- M√ìDULO INDEXEDDB - SINCRONIZA√á√ÉO COMPLETA ---
const DB_NAME = 'AnjosKidsDB';
const DB_VERSION = 1;
let db;

// Inicializa e cria as stores
function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            
            // Cria stores sem keyPath fixo
            const stores = ['produtos', 'clientes', 'vendasCaixa', 'carrinho', 'consignacoes', 'trocas'];
            
            stores.forEach(storeName => {
                if (!db.objectStoreNames.contains(storeName)) {
                    // Remove keyPath para evitar conflitos
                    db.createObjectStore(storeName);
                }
            });
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            console.log('IndexedDB conectado:', DB_NAME);
            resolve();
        };

        request.onerror = (event) => {
            console.error('Erro ao abrir IndexedDB:', event.target.error);
            reject(event.target.error);
        };
    });
}

// Sincroniza dados do localStorage para o IndexedDB
async function syncLocalStorageToIndexedDB() {
    if (!db) {
        console.warn('‚ö†Ô∏è IndexedDB n√£o inicializado');
        return;
    }
    
    const storeNames = ['produtos', 'clientes', 'vendasCaixa', 'carrinho', 'consignacoes', 'trocas'];
    
    try {
        for (const storeName of storeNames) {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const dados = JSON.parse(localStorage.getItem(storeName) || '[]');
            
            // Limpa a store
            store.clear();
            
            // Adiciona cada item com uma chave √∫nica
            dados.forEach((item, index) => {
                const chave = item.cpf || item.sku || item.id || `${storeName}_${index}`;
                store.put(item, chave);
            });
            
            await new Promise((resolve, reject) => {
                tx.oncomplete = resolve;
                tx.onerror = () => reject(tx.error);
            });
        }
        console.log('‚úÖ Dados sincronizados do localStorage ‚Üí IndexedDB');
    } catch (error) {
        console.error('‚ùå Erro ao sincronizar para IndexedDB:', error);
    }
}

// Sincroniza dados do IndexedDB para localStorage (CORRETAMENTE ASS√çNCRONA)
async function syncIndexedDBToLocalStorage() {
    if (!db) {
        console.warn('‚ö†Ô∏è IndexedDB n√£o inicializado para leitura');
        return;
    }
    
    const storeNames = ['produtos', 'clientes', 'vendasCaixa', 'carrinho', 'consignacoes', 'trocas'];
    
    try {
        const syncPromises = storeNames.map(storeName => {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readonly');
                
                tx.onerror = event => {
                    console.error(`‚ùå Erro na transa√ß√£o para ${storeName}:`, event.target.error);
                    resolve(); // Resolve mesmo com erro para n√£o travar
                };

                const store = tx.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const data = request.result;
                    
                    if (data && Object.keys(data).length > 0) {
                        // Se getAll retornou um objeto, converte para array
                        const dataArray = Array.isArray(data) ? data : Object.values(data);
                        
                        if (dataArray.length > 0) {
                            localStorage.setItem(storeName, JSON.stringify(dataArray));
                            console.log(`‚úÖ ${storeName}: ${dataArray.length} registros carregados`);
                        }
                    }
                    resolve();
                };
                
                request.onerror = event => {
                    console.error(`‚ùå Erro ao ler ${storeName}:`, event.target.error);
                    resolve(); // Resolve mesmo com erro
                };
            });
        });

        await Promise.all(syncPromises);
        console.log('‚úÖ Dados sincronizados do IndexedDB ‚Üí localStorage');
    } catch (error) {
        console.error('‚ùå Erro geral na sincroniza√ß√£o:', error);
    }
}
// Inicializa o banco e sincroniza tudo ao carregar o sistema
window.addEventListener('load', async () => {
    console.log('üöÄ Iniciando sistema Anjos Kids...');
    
    try {
        // 1. Inicializa o IndexedDB
        await initIndexedDB();
        console.log('‚úÖ IndexedDB inicializado');
        
        // 2. Carrega dados do IndexedDB para localStorage
        await syncIndexedDBToLocalStorage();
        
        // 3. Renderiza todas as tabelas
        renderizarTabelaClientes();
        renderizarTabelaEstoque();
        renderizarCarrinho();
        renderizarTabelaConsignacoes();
        
        // 4. Calcula resumos
        calcularResumosCaixa();
        
        console.log('‚úÖ Sistema carregado com sucesso!');
        
    } catch (err) {
        console.error('‚ùå Falha ao inicializar sistema:', err);
        alert('Erro ao carregar o sistema. Por favor, recarregue a p√°gina.');
    }
});

// Atualiza IndexedDB sempre que salvar dados no localStorage
const _salvarDadosOriginal = salvarDados;
salvarDados = (chave, dados) => {
    // 1. Salva no localStorage
    _salvarDadosOriginal(chave, dados);
    
    // 2. Salva no IndexedDB automaticamente
    if (db && ['produtos', 'clientes', 'vendasCaixa', 'carrinho', 'consignacoes', 'trocas'].includes(chave)) {
        try {
            const tx = db.transaction(chave, 'readwrite');
            const store = tx.objectStore(chave);
            
            // Limpa a store
            store.clear();
            
            // Adiciona cada item com chave √∫nica
            dados.forEach((item, index) => {
                const chaveUnica = item.cpf || item.sku || item.id || `${chave}_${index}`;
                store.put(item, chaveUnica);
            });
            
            tx.oncomplete = () => {
                console.log(`‚úÖ ${chave} sincronizado com IndexedDB`);
            };
            
            tx.onerror = (e) => {
                console.error(`‚ùå Erro ao sincronizar ${chave}:`, e.target.error);
            };
            
        } catch (error) {
            console.error(`‚ùå Erro ao salvar ${chave} no IndexedDB:`, error);
        }
    }
};
    
         function atualizarResumoGeneroTamanho() {
    const produtos = getDados(STORAGE_PRODUTOS);
    const mapa = {};

    produtos.forEach(p => {
        if (!mapa[p.genero]) mapa[p.genero] = {};
        if (!mapa[p.genero][p.tamanho]) mapa[p.genero][p.tamanho] = 0;
        mapa[p.genero][p.tamanho] += p.estoque;
    });

    let html = "";

    for (const genero in mapa) {
        html += `
            <div style="
                background:white;
                border:1px solid #ddd;
                padding:10px;
                border-radius:10px;
                box-shadow:0px 2px 6px rgba(0,0,0,0.1);
            ">
                <strong style="font-size:1.1em; color:#3a7bd5;">
                    ${genero}
                </strong>
                <hr style="margin:5px 0;">
        `;

        // Ordem final desejada dos tamanhos
const ordemTamanhos = [
    // Beb√™
    "Baby P","Baby M","Baby G","Baby GG","RN",
    
    // Num√©ricos
    "01","02","03","04","06","08","10","12","14","16",
    "18","20","22","24","26","28","30","32","34","36",
    "38","40","42","44","46","48",
    
    // Adulto padr√£o
    "PP","P","M","G","GG","XG","XGG","XXG","XXGG"
];

// Ordena tamanhos seguindo prioridade da lista acima
const tamanhosOrdenados = Object.keys(mapa[genero]).sort((a, b) => {
    const ia = ordemTamanhos.indexOf(a);
    const ib = ordemTamanhos.indexOf(b);

    if (ia === -1 && ib === -1) return a.localeCompare(b, 'pt-BR', { numeric:true });
    if (ia === -1) return 1;
    if (ib === -1) return -1;
    return ia - ib;
});

for (const tamanho of tamanhosOrdenados) {

             html += `
                <div style="display:flex; justify-content:space-between; font-size:0.9em; padding:3px 0; align-items:center; cursor:pointer; transition: background 0.2s;" 
                     onmouseover="this.style.background='#f0f8ff'" 
                     onmouseout="this.style.background='transparent'"
                     onclick="mostrarProdutosPorGeneroTamanho('${genero}', '${tamanho}')">
    <span><b>${tamanho}</b></span>
    <div style="flex:1; border-bottom:1px dashed #aaa; margin:0 8px;"></div>
    <span>${mapa[genero][tamanho]} un</span>
</div>

            `;
        }

        html += `</div>`;
    }

    document.getElementById("resultadoGeneroTamanho").innerHTML =
        html || "<em>Nenhum produto cadastrado.</em>";
}

      document.getElementById("toggleResumoBtn").addEventListener("click", function() {
    const area = document.getElementById("areaResumoGeneroTamanho");
    
    if (area.style.display === "none") {
        area.style.display = "block";
        this.textContent = "üìΩ Ocultar Resumo por G√™nero e Tamanho";
        atualizarResumoGeneroTamanho();
    } else {
        area.style.display = "none";
        this.textContent = "üìä Mostrar Resumo por G√™nero e Tamanho";
    }
});

// NOVA FUN√á√ÉO: Mostra detalhes dos produtos ao clicar em um tamanho espec√≠fico
function mostrarProdutosPorGeneroTamanho(genero, tamanho) {
    const produtos = getDados(STORAGE_PRODUTOS);
    
    // Filtra produtos que correspondem ao g√™nero e tamanho E que tenham estoque > 0
    const produtosFiltrados = produtos.filter(p => 
        p.genero === genero && p.tamanho === tamanho && p.estoque > 0
    );
    
    // ‚≠ê NOVA LINHA: ORDENA POR MODELO (CRESCENTE)
    produtosFiltrados.sort((a, b) => {
        return a.modelo.localeCompare(b.modelo, 'pt-BR');
    });
    
    if (produtosFiltrados.length === 0) {
        alert('Nenhum produto encontrado para esta categoria.');
        return;
    }
    
    // Atualiza o t√≠tulo do modal
    document.getElementById('tituloDetalhesTamanho').innerHTML = 
        `<i class="fas fa-list"></i> Produtos: ${genero} - Tamanho ${tamanho}`;
    
    // Preenche a tabela
    const corpoTabela = document.getElementById('corpoTabelaDetalhesTamanho');
    corpoTabela.innerHTML = '';
    
    let totalEstoque = 0;
    
    produtosFiltrados.forEach(produto => {
        totalEstoque += produto.estoque;
        
        const linha = corpoTabela.insertRow();
        linha.insertCell().textContent = produto.sku;
        linha.insertCell().textContent = produto.marca;
        linha.insertCell().textContent = produto.modelo;
        linha.insertCell().textContent = produto.cor;
        linha.insertCell().textContent = formatarMoeda(produto.venda);
        
        // Destaca estoque baixo
        const celulaEstoque = linha.insertCell();
        celulaEstoque.textContent = produto.estoque;
        if (produto.estoque < 5) {
            celulaEstoque.style.color = '#dc3545';
            celulaEstoque.style.fontWeight = 'bold';
        }
        
        // Adiciona efeito hover na linha
        linha.style.cursor = 'pointer';
        linha.onmouseover = () => { linha.style.backgroundColor = '#f0f8ff'; };
        linha.onmouseout = () => { linha.style.backgroundColor = ''; };
        
        // Ao clicar na linha, abre edi√ß√£o do produto
        linha.onclick = () => {
            fecharModal('modalDetalhesTamanho');
            abrirModalEdicaoProduto(produto.sku);
        };
    });
    
    // Atualiza o total
    document.getElementById('totalProdutosCategoria').textContent = `${totalEstoque} unidades`;
    
    // Abre o modal
    abrirModal('modalDetalhesTamanho');
}

// Fun√ß√£o para abrir o modal de sele√ß√£o de clientes

// Fun√ß√£o para abrir o modal de sele√ß√£o de clientes
function abrirModalSelecaoCliente() {
    renderizarTabelaClientesModal(); // Preenche a tabela com clientes
    abrirModal('modalSelecaoCliente');
}

// Renderiza a tabela de clientes no modal (similar a renderizarTabelaClientes, mas com bot√£o "Selecionar")
function renderizarTabelaClientesModal() {
    const clientes = getDados(STORAGE_CLIENTES);
    const corpoTabela = document.getElementById('corpoTabelaClientesModal');
    corpoTabela.innerHTML = '';

    clientes.forEach(cliente => {
        const linha = corpoTabela.insertRow();
        linha.insertCell().textContent = cliente.nome;
        linha.insertCell().textContent = formatarCpfVisual(cliente.cpf);
        linha.insertCell().textContent = cliente.telefone;

        // A√ß√£o: Bot√£o Selecionar
        const celulaAcao = linha.insertCell();
        const btnSelecionar = document.createElement('button');
        btnSelecionar.innerHTML = '<i class="fas fa-check"></i> Selecionar';
        btnSelecionar.className = 'btn-acao';
        btnSelecionar.onclick = () => selecionarClienteParaVenda(cliente);
        celulaAcao.appendChild(btnSelecionar);
    });
}

// Fun√ß√£o para filtrar clientes no modal (similar a filtrarClientes())
function filtrarClientesModal() {
    const input = document.getElementById('inputPesquisaClientesModal').value.toLowerCase();
    const linhas = document.getElementById('corpoTabelaClientesModal').rows;

    for (let linha of linhas) {
        const nome = linha.cells[0].textContent.toLowerCase();
        const cpf = linha.cells[1].textContent.toLowerCase();
        linha.style.display = (nome.includes(input) || cpf.includes(input)) ? '' : 'none';
    }
}

// Fun√ß√£o para selecionar o cliente e retornar √† venda
function selecionarClienteParaVenda(cliente) {
    document.getElementById('cpfCliente').value = formatarCpfVisual(cliente.cpf); // Preenche o input com CPF formatado
    validarClienteVenda(); // Atualiza a info do cliente na tela de vendas
    fecharModal('modalSelecaoCliente'); // Fecha o modal e retorna √† venda
}

// Evento de submit para cadastro r√°pido no modal
const formCadastroClienteRapido = document.getElementById('formCadastroClienteRapido');
formCadastroClienteRapido.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const cpfLimpo = limparCpf(document.getElementById('novoCpf').value);
    if (cpfLimpo.length !== 11) {
        alert('O CPF deve conter 11 d√≠gitos.');
        return;
    }
    
    if (buscarClientePorCpf(cpfLimpo)) {
        alert('Erro: J√° existe um cliente com este CPF.');
        return;
    }

    const novoCliente = {
        nome: document.getElementById('novoNomeCliente').value,
        cpf: cpfLimpo,
        telefone: document.getElementById('novoTelefone').value,
        rua: '', numero: '', bairro: '', cep: '', // Campos opcionais vazios
        cadastro: new Date().getTime()
    };

    const clientes = getDados(STORAGE_CLIENTES);
    clientes.push(novoCliente);
    salvarDados(STORAGE_CLIENTES, clientes);
    
    formCadastroClienteRapido.reset();
    renderizarTabelaClientesModal(); // Atualiza a tabela no modal
    renderizarTabelaClientes(); // Atualiza a tabela principal de clientes
    alert('Cliente cadastrado! Agora selecione-o na lista abaixo.');
});

// Fun√ß√£o para abrir o modal de sele√ß√£o de clientes no contexto de consigna√ß√£o
function abrirModalSelecaoClienteParaConsignacao() {
    renderizarTabelaClientesModalParaConsignacao(); // Preenche a tabela adaptada para consigna√ß√£o
    abrirModal('modalSelecaoCliente');
}

// Renderiza a tabela de clientes no modal, mas com bot√£o "Selecionar" para consigna√ß√£o
function renderizarTabelaClientesModalParaConsignacao() {
    const clientes = getDados(STORAGE_CLIENTES);
    const corpoTabela = document.getElementById('corpoTabelaClientesModal');
    corpoTabela.innerHTML = '';

    clientes.forEach(cliente => {
        const linha = corpoTabela.insertRow();
        linha.insertCell().textContent = cliente.nome;
        linha.insertCell().textContent = formatarCpfVisual(cliente.cpf);
        linha.insertCell().textContent = cliente.telefone;

        // A√ß√£o: Bot√£o Selecionar (adaptado para consigna√ß√£o)
        const celulaAcao = linha.insertCell();
        const btnSelecionar = document.createElement('button');
        btnSelecionar.innerHTML = '<i class="fas fa-check"></i> Selecionar';
        btnSelecionar.className = 'btn-acao';
        btnSelecionar.onclick = () => selecionarClienteParaConsignacao(cliente);
        celulaAcao.appendChild(btnSelecionar);
    });
}

// Fun√ß√£o para selecionar o cliente e retornar √† consigna√ß√£o
function selecionarClienteParaConsignacao(cliente) {
    document.getElementById('cpfClienteConsignacao').value = formatarCpfVisual(cliente.cpf); // Preenche o input com CPF formatado
    validarClienteConsignacao(); // Atualiza a info do cliente na tela de consigna√ß√£o
    clienteConsignacaoAtual = cliente; // Atualiza a vari√°vel global para o cliente atual
    fecharModal('modalSelecaoCliente'); // Fecha o modal e retorna √† consigna√ß√£o
}



// ===============================================
// RELAT√ìRIO RESUMIDO DE CONSIGNA√á√ïES POR DIA
// ===============================================

function abrirRelatorioConsignacoesPorDia() {
    const consignacoes = getDados(STORAGE_CONSIGNACOES) || [];
    const produtos = getDados(STORAGE_PRODUTOS);
    const pendentes = consignacoes.filter(c => c.status === 'pendente');
    
    if (pendentes.length === 0) {
        alert('N√£o h√° consigna√ß√µes pendentes no momento.');
        return;
    }
    
    // Agrupa por data
    const porDia = {};
    pendentes.forEach(cons => {
        if (!porDia[cons.data]) {
            porDia[cons.data] = { consignacoes: 0, pecas: 0, valor: 0, custo: 0 };
        }
        
        let totalPecas = 0;
        let totalValor = 0;
        let totalCusto = 0;
        
        cons.itens.forEach(item => {
            totalPecas += item.quantidade;
            totalValor += item.valorUnitario * item.quantidade;
            
            const produto = produtos.find(p => p.sku === item.sku);
            if (produto) {
                totalCusto += produto.custo * item.quantidade;
            }
        });
        
        porDia[cons.data].consignacoes++;
        porDia[cons.data].pecas += totalPecas;
        porDia[cons.data].valor += totalValor;
        porDia[cons.data].custo += totalCusto;
    });
    
    // Ordena datas
    const datasOrdenadas = Object.keys(porDia).sort();
    
    // Gera tabela resumida
    let html = `
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #fd7e14; color: white;">
                    <th style="padding: 12px; text-align: left; width: 12%;">Data</th>
                    <th style="padding: 12px; text-align: center; width: 10%;">Consig.</th>
                    <th style="padding: 12px; text-align: center; width: 8%;">P√ßs</th>
                    <th style="padding: 12px; text-align: center; width: 35%;">Valor Total</th>
                    <th style="padding: 12px; text-align: center; width: 35%;">Lucro</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalGeralConsignacoes = 0;
    let totalGeralPecas = 0;
    let totalGeralValor = 0;
    let totalGeralCusto = 0;
    
    datasOrdenadas.forEach((data, index) => {
        const [ano, mes, dia] = data.split('-');
        const dataFormatada = `${dia}/${mes}/${ano}`;
        const dados = porDia[data];
        
        totalGeralConsignacoes += dados.consignacoes;
        totalGeralPecas += dados.pecas;
        totalGeralValor += dados.valor;
        totalGeralCusto += dados.custo;
        
        const cor = index % 2 === 0 ? '#f9f9f9' : 'white';
        
        const lucro = dados.valor - dados.custo;
        const percentualLucro = dados.custo > 0 ? ((lucro / dados.custo) * 100).toFixed(1) : 0;
        
        html += `
            <tr style="background-color: ${cor};">
                <td style="padding: 10px; border: 1px solid #ddd;"><strong>${dataFormatada}</strong></td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${dados.consignacoes}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${dados.pecas}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${formatarMoeda(dados.valor)}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #28a745; font-weight: bold;">
                    ${formatarMoeda(lucro)} (${percentualLucro}%)
                </td>
            </tr>
        `;
    });
    
    const lucroGeralTotal = totalGeralValor - totalGeralCusto;
    const percentualLucroGeral = totalGeralCusto > 0 ? ((lucroGeralTotal / totalGeralCusto) * 100).toFixed(1) : 0;
    
    html += `
            </tbody>
            <tfoot>
                <tr style="background-color: #3a7bd5; color: white; font-weight: bold; font-size: 1.1em;">
                    <td style="padding: 15px; border: 1px solid #ddd;">TOTAL</td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center;">${totalGeralConsignacoes}</td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center;">${totalGeralPecas}</td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center;">${formatarMoeda(totalGeralValor)}</td>
                    <td style="padding: 15px; border: 1px solid #ddd; text-align: center; color: #d4edda;">
                        ${formatarMoeda(lucroGeralTotal)} (${percentualLucroGeral}%)
                    </td>
                </tr>
            </tfoot>
        </table>
    `;
    
    document.getElementById('conteudoRelatorioConsignacoes').innerHTML = html;
    abrirModal('modalRelatorioConsignacoes');
}

function imprimirRelatorioConsignacoes() {
    const conteudo = document.getElementById('conteudoRelatorioConsignacoes').innerHTML;
    
    const janelaImpressao = window.open('', '', 'width=800,height=600');
    janelaImpressao.document.write(`
        <html>
        <head>
            <title>Relat√≥rio de Consigna√ß√µes</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 10px; }
                @media print {
                    body { font-size: 11pt; }
                }
            </style>
        </head>
        <body>
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #fd7e14; margin: 0;">Anjos Kid's</h2>
                <h3 style="margin: 5px 0;">Relat√≥rio de Consigna√ß√µes Pendentes</h3>
                <p style="color: #888; font-size: 0.9em;">Data: ${formatarDataHoraSegura(new Date().getTime())}</p>
            </div>
            ${conteudo}
        </body>
        </html>
    `);
    janelaImpressao.document.close();
    
    setTimeout(() => {
        janelaImpressao.print();
    }, 250);
}

// ===============================================
// SALVAMENTO AUTOM√ÅTICO AO FECHAR NAVEGADOR
// ===============================================

// Salva dados antes de fechar a p√°gina
window.addEventListener('beforeunload', async (e) => {
    if (db) {
        try {
            await syncLocalStorageToIndexedDB();
            console.log('üíæ Dados salvos antes de fechar');
        } catch (error) {
            console.error('‚ùå Erro ao salvar antes de fechar:', error);
        }
    }
});

// Sincroniza periodicamente (a cada 5 minutos)
setInterval(async () => {
    if (db) {
        try {
            await syncLocalStorageToIndexedDB();
            console.log('üíæ Sincroniza√ß√£o autom√°tica realizada');
        } catch (error) {
            console.error('‚ùå Erro na sincroniza√ß√£o autom√°tica:', error);
        }
    }
}, 5 * 60 * 1000); // 5 minutos

// ===============================================
// SISTEMA DE HIST√ìRICO DE TROCAS - FUN√á√ïES
// ===============================================

// Abre o modal de hist√≥rico de trocas
function abrirModalHistoricoTrocas() {
    const trocas = getDados(STORAGE_TROCAS) || [];
    
    if (trocas.length === 0) {
        alert('Nenhuma troca foi realizada ainda.');
        return;
    }
    
    // Limpa filtros
    document.getElementById('filtroClienteTroca').value = '';
    document.getElementById('filtroDataTroca').value = '';
    
    // Renderiza tabela
    renderizarTabelaHistoricoTrocas(trocas);
    
    // Abre modal
    abrirModal('modalHistoricoTrocas');
}

// Renderiza a tabela de hist√≥rico de trocas
function renderizarTabelaHistoricoTrocas(trocasFiltradas) {
    const corpoTabela = document.getElementById('corpoTabelaHistoricoTrocas');
    corpoTabela.innerHTML = '';
    
    let totalTrocas = 0;
    let totalDevolvidos = 0;
    let totalNovos = 0;
    
    trocasFiltradas.forEach(troca => {
    // Calcula as quantidades primeiro
    let qtdDevolvidos = 0;
    let qtdNovos = 0;
    troca.produtosDevolvidos.forEach(p => qtdDevolvidos += p.quantidade);
    troca.produtosNovos.forEach(p => qtdNovos += p.quantidade);
    
    // ‚úÖ S√ì SOMA SE N√ÉO FOR ESTORNADA
    if (troca.status !== 'estornada') {
        totalTrocas++;
        totalDevolvidos += qtdDevolvidos;
        totalNovos += qtdNovos;
    }
        
     
        const linha = corpoTabela.insertRow();
        linha.insertCell().textContent = troca.id;
        linha.insertCell().textContent = `${troca.data} ${troca.hora}`;
        linha.insertCell().textContent = troca.clienteNome || 'N√£o Identificado';
        linha.insertCell().textContent = qtdDevolvidos;
        linha.insertCell().textContent = qtdNovos;
        
        const celulaDiferenca = linha.insertCell();
        celulaDiferenca.textContent = formatarMoeda(troca.diferenca);
        celulaDiferenca.style.fontWeight = 'bold';

        // Marca visualmente se foi estornada
        if (troca.status === 'estornada') {
        linha.style.backgroundColor = '#f8d7da'; // Rosa claro
        linha.style.opacity = '0.7';
        celulaDiferenca.innerHTML += '<br><small style="color: #dc3545;">‚ùå ESTORNADA</small>';
        }
        
        if (troca.diferenca > 0) celulaDiferenca.style.color = '#dc3545';
        else if (troca.diferenca < 0) celulaDiferenca.style.color = '#28a745';
        else celulaDiferenca.style.color = '#3a7bd5';
        
        // A√á√ïES - Apenas reimprimir
        const celulaAcao = linha.insertCell();
        celulaAcao.style.textAlign = 'center';
        celulaAcao.style.whiteSpace = 'nowrap';
        
        // Desabilita a√ß√µes se a troca foi estornada
const desabilitado = troca.status === 'estornada';
const estiloBotaoDesabilitado = desabilitado ? 'opacity: 0.5; cursor: not-allowed;' : '';

celulaAcao.innerHTML = `
    <button class="btn-acao btn-small-icon" 
            title="Ver detalhes"
            style="background-color: #3a7bd5;"
            onclick="verDetalhesTrocaPorId(${troca.id})">
        <i class="fas fa-eye"></i>
    </button>
    
    <button class="btn-acao btn-small-icon" 
            title="${desabilitado ? 'Troca estornada' : 'Reimprimir recibo'}"
            style="background-color: #ffc107; color: black; ${estiloBotaoDesabilitado}"
            onclick="${desabilitado ? 'return false;' : `reimprimirTrocaPorId(${troca.id})`}">
        <i class="fas fa-print"></i>
    </button>
    
    <button class="btn-remover btn-small-icon" 
            title="${desabilitado ? 'J√° foi estornada' : 'Estornar troca'}"
            style="${estiloBotaoDesabilitado}"
            onclick="${desabilitado ? 'return false;' : `estornarTroca(${troca.id})`}">
        <i class="fas fa-undo-alt"></i>
    </button>
`;
    });
    
    document.getElementById('resumoTotalTrocasModal').textContent = totalTrocas;
    document.getElementById('resumoItensDevolvidos').textContent = totalDevolvidos;
    document.getElementById('resumoItensNovos').textContent = totalNovos;
}

// Filtra hist√≥rico de trocas
function filtrarHistoricoTrocas() {
    const trocas = getDados(STORAGE_TROCAS) || [];
    const filtroCliente = document.getElementById('filtroClienteTroca').value.toLowerCase().trim();
    const filtroData = document.getElementById('filtroDataTroca').value;
    
    let trocasFiltradas = trocas;
    
    // Filtra por cliente
    if (filtroCliente) {
        trocasFiltradas = trocasFiltradas.filter(t => {
            const nome = (t.clienteNome || '').toLowerCase();
            const cpf = (t.clienteCpf || '').replace(/\D/g, '');
            return nome.includes(filtroCliente) || cpf.includes(filtroCliente);
        });
    }
    
    // Filtra por data
    if (filtroData) {
        trocasFiltradas = trocasFiltradas.filter(t => t.data === filtroData);
    }
    
    renderizarTabelaHistoricoTrocas(trocasFiltradas);
}

// Limpa filtros de trocas
function limparFiltrosTrocas() {
    document.getElementById('filtroClienteTroca').value = '';
    document.getElementById('filtroDataTroca').value = '';
    
    const trocas = getDados(STORAGE_TROCAS) || [];
    renderizarTabelaHistoricoTrocas(trocas);
}

// Abre modal de detalhes de uma troca espec√≠fica
function abrirModalDetalhesTroca(troca) {
    console.log('üìÇ Preenchendo modal com dados da troca:', troca);
    
    trocaAtualParaReimprimir = troca;
    
    document.getElementById('detalhesTrocaID').textContent = troca.id;
    document.getElementById('detalhesTrocaCliente').textContent = troca.clienteNome || 'N√£o Identificado';
    document.getElementById('detalhesTrocaDataHora').textContent = `${troca.data} ${troca.hora}`;
    
    // ========================================
    // PRODUTOS DEVOLVIDOS (ENTRADA)
    // ========================================
    const corpoDevolvidos = document.getElementById('tabelaDetalhesTrocaDevolvidos');
    corpoDevolvidos.innerHTML = '';
    let totalDevolvidos = 0;
    
    troca.produtosDevolvidos.forEach(prod => {
        const linha = corpoDevolvidos.insertRow();
        linha.insertCell().textContent = prod.sku;
        linha.insertCell().textContent = prod.descricao;
        linha.insertCell().textContent = prod.quantidade;
        linha.insertCell().textContent = formatarMoeda(prod.valorUnitario);
        linha.insertCell().textContent = formatarMoeda(prod.valorTotal);
        totalDevolvidos += prod.valorTotal;
    });
    
    document.getElementById('totalDetalhesTrocaDevolvidos').textContent = formatarMoeda(totalDevolvidos);
    
    // ========================================
    // PRODUTOS NOVOS (SA√çDA)
    // ========================================
    const corpoNovos = document.getElementById('tabelaDetalhesTrocaNovos');
    corpoNovos.innerHTML = '';
    let totalNovos = 0;
    
    troca.produtosNovos.forEach(prod => {
        const linha = corpoNovos.insertRow();
        linha.insertCell().textContent = prod.sku;
        linha.insertCell().textContent = prod.descricao;
        linha.insertCell().textContent = prod.quantidade;
        linha.insertCell().textContent = formatarMoeda(prod.valorUnitario);
        linha.insertCell().textContent = formatarMoeda(prod.valorTotal);
        totalNovos += prod.valorTotal;
    });
    
    document.getElementById('totalDetalhesTrocaNovos').textContent = formatarMoeda(totalNovos);
    
    // ========================================
    // DIFEREN√áA
    // ========================================
    const elemDiferenca = document.getElementById('detalhesTrocaDiferenca');
    
    if (troca.diferenca > 0) {
        elemDiferenca.innerHTML = `<span style="color: #dc3545;">üî¥ Cliente Pagou: ${formatarMoeda(troca.diferenca)}</span>`;
    } else if (troca.diferenca < 0) {
        elemDiferenca.innerHTML = `<span style="color: #28a745;">üü¢ Devolvido ao Cliente: ${formatarMoeda(Math.abs(troca.diferenca))}</span>`;
    } else {
        elemDiferenca.innerHTML = `<span style="color: #3a7bd5;">‚úÖ Troca Zerada (valores iguais)</span>`;
    }
    
    console.log('‚úÖ Modal preenchido. Abrindo...');
    abrirModal('modalDetalhesTroca');
}

    // ‚úÖ NOVAS FUN√á√ïES AUXILIARES MAIS SIMPLES
function verDetalhesTrocaPorId(trocaId) {
    console.log('üîç Abrindo detalhes da troca ID:', trocaId); // LOG DE DEBUG
    
    const trocas = getDados(STORAGE_TROCAS) || [];
    const troca = trocas.find(t => t.id === trocaId);
    
    if (!troca) {
        alert('Troca n√£o encontrada!');
        console.error('‚ùå Troca n√£o encontrada no storage:', trocaId);
        return;
    }
    
    console.log('‚úÖ Troca encontrada:', troca);
    abrirModalDetalhesTroca(troca);
}

function reimprimirTrocaPorId(trocaId) {
    const trocas = getDados(STORAGE_TROCAS) || [];
    const troca = trocas.find(t => t.id === trocaId);
    
    if (!troca) {
        alert('Troca n√£o encontrada!');
        return;
    }
    
    imprimirReciboTroca(
        troca.produtosDevolvidos,
        troca.produtosNovos,
        troca.diferenca,
        troca.clienteNome || 'N√£o Identificado'
    );
}

// Reimprime o recibo da troca atual
function reimprimirReciboDaTroca() {
    if (!trocaAtualParaReimprimir) {
        alert('Nenhuma troca selecionada para reimprimir.');
        return;
    }
    
    imprimirReciboTroca(
        trocaAtualParaReimprimir.produtosDevolvidos,
        trocaAtualParaReimprimir.produtosNovos,
        trocaAtualParaReimprimir.diferenca,
        trocaAtualParaReimprimir.clienteNome || 'N√£o Identificado'
    );
}

// Imprime todo o hist√≥rico de trocas
function imprimirHistoricoTrocas() {
    const trocas = getDados(STORAGE_TROCAS) || [];
    
    if (trocas.length === 0) {
        alert('Nenhuma troca para imprimir.');
        return;
    }
    
    let html = `
        <div class="print-report-body">
            <h3 style="text-align: center;">Hist√≥rico de Trocas - Anjos Kid's</h3>
            <p style="text-align: center; color: #888;">Data de Emiss√£o: ${formatarDataHoraSegura(new Date().getTime())}</p>
            
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead>
                    <tr style="background-color: #ff8c00; color: white;">
                        <th style="padding: 10px; border: 1px solid #ddd;">ID</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Data/Hora</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Cliente</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Devolvidos</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Novos</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Diferen√ßa</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    trocas.forEach(troca => {
        let qtdDev = 0;
        let qtdNov = 0;
        
        troca.produtosDevolvidos.forEach(p => qtdDev += p.quantidade);
        troca.produtosNovos.forEach(p => qtdNov += p.quantidade);
        
        html += `
            <tr>
                <td style="padding: 8px; border: 1px solid #ddd;">${troca.id}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">${troca.data} ${troca.hora}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">${troca.clienteNome || 'N/A'}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${qtdDev}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${qtdNov}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(troca.diferenca)}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write('<html><head><title>Hist√≥rico de Trocas</title>');
    const style = document.querySelector('style').textContent;
    printWindow.document.write('<style>' + style + '</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(html);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
}

// ===============================================
// FUN√á√ÉO PARA ESTORNAR UMA TROCA
// ===============================================
function estornarTroca(trocaId) {
    const trocas = getDados(STORAGE_TROCAS) || [];
    const troca = trocas.find(t => t.id === trocaId);
    
    if (!troca) {
        alert('‚ùå Troca n√£o encontrada!');
        return;
    }
    
    // Verifica se j√° foi estornada
    if (troca.status === 'estornada') {
        alert('‚ö†Ô∏è Esta troca j√° foi estornada anteriormente!');
        return;
    }
    
    // Calcula totais para a mensagem de confirma√ß√£o
    let qtdDevolvidos = 0;
    let qtdNovos = 0;
    troca.produtosDevolvidos.forEach(p => qtdDevolvidos += p.quantidade);
    troca.produtosNovos.forEach(p => qtdNovos += p.quantidade);
    
    // Confirma√ß√£o detalhada
    const mensagemConfirmacao = `
‚ö†Ô∏è ATEN√á√ÉO: ESTORNAR TROCA

Esta a√ß√£o ir√°:
‚úÖ Devolver ${qtdNovos} produtos novos ao estoque
‚ùå Retirar ${qtdDevolvidos} produtos devolvidos do estoque
üóëÔ∏è Remover registros do caixa

Cliente: ${troca.clienteNome || 'N√£o Identificado'}
Diferen√ßa: ${formatarMoeda(troca.diferenca)}

‚ö†Ô∏è Esta a√ß√£o N√ÉO pode ser desfeita!

Deseja continuar?
    `.trim();
    
    if (!confirm(mensagemConfirmacao)) {
        return;
    }
    
    // ========================================
    // 1. AJUSTA ESTOQUE
    // ========================================
    const produtos = getDados(STORAGE_PRODUTOS);
    let errosEstoque = [];
    
    // 1.1. Devolve produtos NOVOS ao estoque (adiciona)
    troca.produtosNovos.forEach(itemNovo => {
        const produto = produtos.find(p => p.sku === itemNovo.sku);
        if (produto) {
            produto.estoque += itemNovo.quantidade;
            console.log(`‚úÖ ${itemNovo.sku}: +${itemNovo.quantidade} (estoque: ${produto.estoque})`);
        } else {
            errosEstoque.push(`Produto ${itemNovo.sku} n√£o encontrado`);
        }
    });
    
    // 1.2. Remove produtos DEVOLVIDOS do estoque (subtrai)
    troca.produtosDevolvidos.forEach(itemDev => {
        const produto = produtos.find(p => p.sku === itemDev.sku);
        if (produto) {
            produto.estoque -= itemDev.quantidade;
            console.log(`‚úÖ ${itemDev.sku}: -${itemDev.quantidade} (estoque: ${produto.estoque})`);
        } else {
            errosEstoque.push(`Produto ${itemDev.sku} n√£o encontrado`);
        }
    });
    
    salvarDados(STORAGE_PRODUTOS, produtos);
    
    // ========================================
    // 2. REMOVE REGISTROS DO CAIXA
    // ========================================
    let vendasCaixa = getDados(STORAGE_CAIXA);
    const transactionId = troca.transactionId;
    
    // Conta quantos registros ser√£o removidos
    const registrosAntes = vendasCaixa.length;
    vendasCaixa = vendasCaixa.filter(v => v.transactionId !== transactionId);
    const registrosDepois = vendasCaixa.length;
    const registrosRemovidos = registrosAntes - registrosDepois;
    
    salvarDados(STORAGE_CAIXA, vendasCaixa);
    
    // ========================================
    // 3. MARCA TROCA COMO ESTORNADA
    // ========================================
    troca.status = 'estornada';
    troca.dataEstorno = formatarDataIso(new Date());
    troca.horaEstorno = new Date().toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    });
    
    salvarDados(STORAGE_TROCAS, trocas);
    
    // ========================================
    // 4. ATUALIZA INTERFACE
    // ========================================
    // Atualiza tabela de trocas
    const trocasFiltradas = getDados(STORAGE_TROCAS) || [];
    renderizarTabelaHistoricoTrocas(trocasFiltradas);
    
    // Atualiza tabela de caixa se estiver vis√≠vel
    if (document.getElementById('secao-caixa').style.display === 'block') {
        renderizarTabelaCaixa();
        calcularResumosCaixa();
    }
    
    // Atualiza tabela de estoque se estiver vis√≠vel
    if (document.getElementById('secao-estoque').style.display === 'block') {
        renderizarTabelaEstoque();
        calcularResumoEstoque();
    }
    
    // ========================================
    // 5. MENSAGEM DE SUCESSO
    // ========================================
    let mensagemSucesso = `‚úÖ Troca ID ${trocaId} estornada com sucesso!\n\n`;
    mensagemSucesso += `üì¶ Estoque atualizado\n`;
    mensagemSucesso += `üóëÔ∏è ${registrosRemovidos} registros removidos do caixa\n`;
    
    if (errosEstoque.length > 0) {
        mensagemSucesso += `\n‚ö†Ô∏è Avisos:\n${errosEstoque.join('\n')}`;
    }
    
    alert(mensagemSucesso);
    
    console.log('‚úÖ Estorno conclu√≠do:', {
        trocaId,
        registrosRemovidos,
        errosEstoque
    });
}

// ===============================================
// MODAL DE RESUMO DETALHADO DE CONSIGNA√á√ïES
// ===============================================

function abrirModalResumoConsignacoes() {
    const consignacoes = getDados(STORAGE_CONSIGNACOES) || [];
    const pendentes = consignacoes.filter(c => c.status === 'pendente');
    
    if (pendentes.length === 0) {
        alert('N√£o h√° consigna√ß√µes pendentes no momento.');
        return;
    }
    
    let qtdTotal = 0;
    let valorTotalPago = 0;
    let valorTotalReceber = 0;
    
    const corpoTabela = document.getElementById('corpoTabelaResumoConsignacoes');
    corpoTabela.innerHTML = '';
    
    pendentes.forEach(cons => {
        // Calcula valores
        let totalConsignacao = 0;
        let totalPecas = 0;
        
        cons.itens.forEach(item => {
            totalConsignacao += item.valorUnitario * item.quantidade;
            totalPecas += item.quantidade;
        });
        
        const valorPago = cons.valorPago || 0;
        const saldo = totalConsignacao - valorPago;
        
        // Acumula nos totais
        qtdTotal++;
        valorTotalPago += valorPago;
        valorTotalReceber += saldo;
        
        // Cria linha na tabela
        const linha = corpoTabela.insertRow();
        
        linha.insertCell().textContent = cons.id;
        linha.insertCell().textContent = cons.data;
        linha.insertCell().textContent = cons.cliente.nome || `CPF: ${formatarCpfVisual(cons.cliente.cpf)}`;
        linha.insertCell().textContent = totalPecas;
        linha.insertCell().textContent = formatarMoeda(totalConsignacao);
        
        // Valor Pago (verde se houver pagamento)
        const celulaPago = linha.insertCell();
        celulaPago.textContent = formatarMoeda(valorPago);
        if (valorPago > 0) {
            celulaPago.style.color = '#28a745';
            celulaPago.style.fontWeight = 'bold';
        }
        
        // Saldo (vermelho se houver d√≠vida)
        const celulaSaldo = linha.insertCell();
        celulaSaldo.textContent = formatarMoeda(saldo);
        if (saldo > 0) {
            celulaSaldo.style.color = '#dc3545';
            celulaSaldo.style.fontWeight = 'bold';
        } else {
            celulaSaldo.style.color = '#28a745';
        }
        
        // Status
        const celulaStatus = linha.insertCell();
        if (valorPago > 0 && saldo > 0) {
            celulaStatus.innerHTML = '<span style="color: #ffc107; font-weight: bold;">‚ö†Ô∏è PARCIAL</span>';
        } else if (saldo === 0) {
            celulaStatus.innerHTML = '<span style="color: #28a745; font-weight: bold;">‚úÖ PAGO</span>';
        } else {
            celulaStatus.innerHTML = '<span style="color: #dc3545; font-weight: bold;">‚ùå PENDENTE</span>';
        }
        
        // Efeito hover
        linha.style.cursor = 'pointer';
        linha.onmouseover = () => { linha.style.backgroundColor = '#fff3cd'; };
        linha.onmouseout = () => { linha.style.backgroundColor = ''; };
        
        // Ao clicar, abre detalhes da consigna√ß√£o
        linha.onclick = () => {
            fecharModal('modalResumoConsignacoes');
            abrirModalDetalhesConsignacao(cons);
        };
    });
    
    // Atualiza os cards de resumo
    document.getElementById('resumoQtdConsignacoes').textContent = qtdTotal;
    document.getElementById('resumoValorPago').textContent = formatarMoeda(valorTotalPago);
    document.getElementById('resumoValorReceber').textContent = formatarMoeda(valorTotalReceber);
    
    // Abre o modal
    abrirModal('modalResumoConsignacoes');
}
	      
    </script>

<!-- MODAL: RESUMO DETALHADO DE CONSIGNA√á√ïES -->
<div id="modalResumoConsignacoes" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="fechar" onclick="fecharModal('modalResumoConsignacoes')">&times;</span>
        <h3><i class="fas fa-handshake"></i> Resumo Detalhado de Consigna√ß√µes Pendentes</h3>
        
        <!-- Cards de Resumo -->
        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #fd7e14 0%, #e06c00 100%); 
                        border-radius: 10px; padding: 15px; text-align: center; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
                    üìä Total de Consigna√ß√µes
                </div>
                <div id="resumoQtdConsignacoes" style="font-size: 1.8em; font-weight: bold;">0</div>
            </div>
            
            <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
                        border-radius: 10px; padding: 15px; text-align: center; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
                    üí∞ Total Pago
                </div>
                <div id="resumoValorPago" style="font-size: 1.8em; font-weight: bold;">R$ 0,00</div>
            </div>
            
            <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
                        border-radius: 10px; padding: 15px; text-align: center; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
                    ‚ö†Ô∏è Total a Receber
                </div>
                <div id="resumoValorReceber" style="font-size: 1.8em; font-weight: bold;">R$ 0,00</div>
            </div>
        </div>
        
        <!-- Tabela de Consigna√ß√µes -->
        <div style="max-height: 500px; overflow-y: auto;">
            <table style="width: 100%;">
                <thead style="position: sticky; top: 0; background-color: white; z-index: 10;">
                    <tr style="background-color: #fd7e14; color: white;">
                        <th style="padding: 12px;">ID</th>
                        <th style="padding: 12px;">Data</th>
                        <th style="padding: 12px;">Cliente</th>
                        <th style="padding: 12px;">Pe√ßas</th>
                        <th style="padding: 12px;">Valor Total</th>
                        <th style="padding: 12px;">Valor Pago</th>
                        <th style="padding: 12px;">Saldo</th>
                        <th style="padding: 12px;">Status</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaResumoConsignacoes">
                    <!-- Preenchido dinamicamente -->
                </tbody>
            </table>
        </div>
        
        <!-- Bot√£o Fechar -->
        <div style="text-align: right; margin-top: 20px;">
            <button onclick="fecharModal('modalResumoConsignacoes')" class="btn-remover">
                <i class="fas fa-times"></i> Fechar
            </button>
        </div>
    </div>
</div>

<!-- MODAL: HIST√ìRICO DE TROCAS -->
<div id="modalHistoricoTrocas" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <span class="fechar" onclick="fecharModal('modalHistoricoTrocas')">&times;</span>
        <h3><i class="fas fa-exchange-alt"></i> Hist√≥rico de Trocas Realizadas</h3>
        
        <!-- Filtros -->
        <div style="background-color: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="filtroClienteTroca" style="font-weight: bold;">üîç Filtrar por Cliente:</label>
                    <input type="text" id="filtroClienteTroca" 
                           placeholder="Digite nome ou CPF" 
                           oninput="filtrarHistoricoTrocas()"
                           style="width: 100%; padding: 8px; border: 1px solid #ffc107; border-radius: 5px;">
                </div>
                
                <div style="flex: 1; min-width: 150px;">
                    <label for="filtroDataTroca" style="font-weight: bold;">üìÖ Filtrar por Data:</label>
                    <input type="date" id="filtroDataTroca" 
                           onchange="filtrarHistoricoTrocas()"
                           style="width: 100%; padding: 8px; border: 1px solid #ffc107; border-radius: 5px;">
                </div>
                
                <button onclick="limparFiltrosTrocas()" class="btn-acao" style="background-color: #6c757d;">
                    <i class="fas fa-eraser"></i> Limpar Filtros
                </button>
                
                <button onclick="imprimirHistoricoTrocas()" class="btn-acao" style="background-color: #9400d3;">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
        </div>
        
        <!-- Resumo -->
        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #ff8c00 0%, #ff6347 100%); 
                        border-radius: 10px; padding: 15px; text-align: center; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
                    üìä Total de Trocas
                </div>
                <div id="resumoTotalTrocasModal" style="font-size: 1.8em; font-weight: bold;">0</div>
            </div>
            
            <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
                        border-radius: 10px; padding: 15px; text-align: center; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
                    üì¶ Itens Devolvidos
                </div>
                <div id="resumoItensDevolvidos" style="font-size: 1.8em; font-weight: bold;">0</div>
            </div>
            
            <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
                        border-radius: 10px; padding: 15px; text-align: center; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
                    üÜï Novos Produtos
                </div>
                <div id="resumoItensNovos" style="font-size: 1.8em; font-weight: bold;">0</div>
            </div>
        </div>
        
        <!-- Tabela de Trocas -->
        <div style="max-height: 500px; overflow-y: auto;">
            <table id="tabelaHistoricoTrocas" style="width: 100%;">
                <thead style="position: sticky; top: 0; background-color: white; z-index: 10;">
                    <tr style="background-color: #ff8c00; color: white;">
                        <th style="padding: 12px;">ID</th>
                        <th style="padding: 12px;">Data/Hora</th>
                        <th style="padding: 12px;">Cliente</th>
                        <th style="padding: 12px;">Itens Dev.</th>
                        <th style="padding: 12px;">Itens Novos</th>
                        <th style="padding: 12px;">Diferen√ßa</th>
                        <th style="padding: 12px;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaHistoricoTrocas">
                    <!-- Preenchido dinamicamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL: DETALHES DE UMA TROCA ESPEC√çFICA (CORRIGIDO) -->
<div id="modalDetalhesTroca" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="fechar" onclick="fecharModal('modalDetalhesTroca')">&times;</span>
        <h3><i class="fas fa-file-invoice"></i> Detalhes da Troca ID <span id="detalhesTrocaID"></span></h3>
        
        <div style="background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p style="margin: 5px 0;"><strong>Cliente:</strong> <span id="detalhesTrocaCliente"></span></p>
            <p style="margin: 5px 0;"><strong>Data/Hora:</strong> <span id="detalhesTrocaDataHora"></span></p>
        </div>
        
        <!-- Produtos Devolvidos -->
        <div style="border: 2px solid #dc3545; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <h4 style="color: #dc3545; margin-top: 0;"><i class="fas fa-undo"></i> Produtos Devolvidos</h4>
            <table style="width: 100%; font-size: 0.9em;">
                <thead>
                    <tr style="background-color: #f8d7da;">
                        <th style="padding: 8px;">SKU</th>
                        <th style="padding: 8px;">Descri√ß√£o</th>
                        <th style="padding: 8px;">Qtd</th>
                        <th style="padding: 8px;">Valor Unit.</th>
                        <th style="padding: 8px;">Subtotal</th>
                    </tr>
                </thead>
                <tbody id="tabelaDetalhesTrocaDevolvidos"></tbody>
                <tfoot>
                    <tr style="font-weight: bold; background-color: #f8d7da;">
                        <td colspan="4" style="text-align: right; padding: 10px;">TOTAL DEVOLVIDO:</td>
                        <td id="totalDetalhesTrocaDevolvidos" style="padding: 10px; color: #dc3545;">R$ 0,00</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Produtos Novos -->
        <div style="border: 2px solid #28a745; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <h4 style="color: #28a745; margin-top: 0;"><i class="fas fa-box-open"></i> Novos Produtos</h4>
            <table style="width: 100%; font-size: 0.9em;">
                <thead>
                    <tr style="background-color: #d4edda;">
                        <th style="padding: 8px;">SKU</th>
                        <th style="padding: 8px;">Descri√ß√£o</th>
                        <th style="padding: 8px;">Qtd</th>
                        <th style="padding: 8px;">Valor Unit.</th>
                        <th style="padding: 8px;">Subtotal</th>
                    </tr>
                </thead>
                <tbody id="tabelaDetalhesTrocaNovos"></tbody>
                <tfoot>
                    <tr style="font-weight: bold; background-color: #d4edda;">
                        <td colspan="4" style="text-align: right; padding: 10px;">TOTAL NOVOS:</td>
                        <td id="totalDetalhesTrocaNovos" style="padding: 10px; color: #28a745;">R$ 0,00</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Diferen√ßa -->
        <div style="background-color: #e7f3ff; border: 2px solid #3a7bd5; border-radius: 8px; padding: 15px; text-align: center;">
            <h4 style="color: #3a7bd5; margin: 0 0 10px 0;">üí∞ Diferen√ßa da Troca</h4>
            <div id="detalhesTrocaDiferenca" style="font-size: 1.5em; font-weight: bold;">R$ 0,00</div>
        </div>
        
        <!-- Bot√µes -->
        <div style="text-align: right; margin-top: 20px;">
            <button onclick="reimprimirReciboDaTroca()" class="btn-acao" style="background-color: #ffc107; color: black;">
                <i class="fas fa-print"></i> Reimprimir Recibo
            </button>
            <button onclick="fecharModal('modalDetalhesTroca')" class="btn-remover" style="margin-left: 10px;">
                <i class="fas fa-times"></i> Fechar
            </button>
        </div>
    </div>
</div>

<!-- MODAL: AN√ÅLISE DETALHADA DE VENDAS -->
<div id="modalAnaliseVendas" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <span class="fechar" onclick="fecharModal('modalAnaliseVendas')">&times;</span>
        <h3><i class="fas fa-chart-bar"></i> An√°lise Detalhada de Vendas</h3>
        
        <!-- Cards de Resumo Principal -->
        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%); 
                        border-radius: 10px; padding: 15px; text-align: center; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
                    üì¶ Total de Produtos Vendidos
                </div>
                <div id="analiseQtdTotal" style="font-size: 1.8em; font-weight: bold;">0</div>
            </div>
            
            <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
                        border-radius: 10px; padding: 15px; text-align: center; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
                    üí∞ Faturamento Total
                </div>
                <div id="analiseFaturamentoTotal" style="font-size: 1.8em; font-weight: bold;">R$ 0,00</div>
            </div>
            
            <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%); 
                        border-radius: 10px; padding: 15px; text-align: center; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
                    üéØ Ticket M√©dio
                </div>
                <div id="analiseTicketMedio" style="font-size: 1.8em; font-weight: bold;">R$ 0,00</div>
            </div>
        </div>
        
       <!-- An√°lises por Categoria -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            
            <!-- TOP 5 Marcas -->
            <div style="background: white; border: 2px solid #3a7bd5; border-radius: 10px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                <h4 style="color: #3a7bd5; margin-top: 0; border-bottom: 2px solid #3a7bd5; padding-bottom: 10px;">
                    <i class="fas fa-trophy"></i> Top 5 Marcas Mais Vendidas
                </h4>
                <div id="analiseTopMarcas" style="font-size: 0.95em;">
                    <!-- Preenchido dinamicamente -->
                </div>
            </div>
            
            <!-- TOP 5 Tamanhos -->
            <div style="background: white; border: 2px solid #28a745; border-radius: 10px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                <h4 style="color: #28a745; margin-top: 0; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                    <i class="fas fa-ruler"></i> Top 5 Tamanhos Mais Vendidos
                </h4>
                <div id="analiseTopTamanhos" style="font-size: 0.95em;">
                    <!-- Preenchido dinamicamente -->
                </div>
            </div>
            
            <!-- TOP 5 Modelos -->
            <div style="background: white; border: 2px solid #ff69b4; border-radius: 10px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                <h4 style="color: #ff69b4; margin-top: 0; border-bottom: 2px solid #ff69b4; padding-bottom: 10px;">
                    <i class="fas fa-star"></i> Top 5 Modelos Mais Vendidos
                </h4>
                <div id="analiseTopModelos" style="font-size: 0.95em;">
                    <!-- Preenchido dinamicamente -->
                </div>
            </div>
            
            <!-- TOP 5 G√™neros -->
            <div style="background: white; border: 2px solid #9400d3; border-radius: 10px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                <h4 style="color: #9400d3; margin-top: 0; border-bottom: 2px solid #9400d3; padding-bottom: 10px;">
                    <i class="fas fa-venus-mars"></i> Vendas por G√™nero
                </h4>
                <div id="analiseTopGeneros" style="font-size: 0.95em;">
                    <!-- Preenchido dinamicamente -->
                </div>
            </div>
            
        </div>

</body>
</html>